var et=Object.create,Ve=Object.defineProperty,tt=Object.getPrototypeOf,nt=Object.prototype.hasOwnProperty,rt=Object.getOwnPropertyNames,it=Object.getOwnPropertyDescriptor;var Y=Object.assign,at=r=>Ve(r,"__esModule",{value:!0});var ot=(r,a)=>()=>(a||(a={exports:{}},r(a.exports,a)),a.exports);var st=(r,a,p)=>{if(a&&typeof a=="object"||typeof a=="function")for(let c of rt(a))!nt.call(r,c)&&c!=="default"&&Ve(r,c,{get:()=>a[c],enumerable:!(p=it(a,c))||p.enumerable});return r},ft=r=>st(at(Ve(r!=null?et(tt(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var Re=(r,a,p)=>new Promise((c,V)=>{var x=U=>{try{O(p.next(U))}catch(_){V(_)}},b=U=>{try{O(p.throw(U))}catch(_){V(_)}},O=U=>U.done?c(U.value):Promise.resolve(U.value).then(x,b);O((p=p.apply(r,a)).next())});var $e=ot((He,Ae)=>{(function(r){"use strict";var a=r.setTimeout,p=r.clearTimeout,c=r.XMLHttpRequest,V=r.XDomainRequest,x=r.ActiveXObject,b=r.EventSource,O=r.document,U=r.Promise,_=r.fetch,ue=r.Response,ie=r.TextDecoder,N=r.TextEncoder,T=r.AbortController;if(typeof window!="undefined"&&typeof O!="undefined"&&!("readyState"in O)&&O.body==null&&(O.readyState="loading",window.addEventListener("load",function(e){O.readyState="complete"},!1)),c==null&&x!=null&&(c=function(){return new x("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function n(){}return n.prototype=e,new n}),Date.now||(Date.now=function(){return new Date().getTime()}),T==null){var $=_;_=function(e,n){var i=n.signal;return $(e,{headers:n.headers,credentials:n.credentials,cache:n.cache}).then(function(t){var u=t.body.getReader();return i._reader=u,i._aborted&&i._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return u}}}})},T=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function C(){this.bitsNeeded=0,this.codePoint=0}C.prototype.decode=function(e){function n(E,y,l){if(l===1)return E>=128>>y&&E<<y<=2047;if(l===2)return E>=2048>>y&&E<<y<=55295||E>=57344>>y&&E<<y<=65535;if(l===3)return E>=65536>>y&&E<<y<=1114111;throw new Error}function i(E,y){if(E===6*1)return y>>6>15?3:y>31?2:1;if(E===6*2)return y>15?3:2;if(E===6*3)return 3;throw new Error}for(var t=65533,u="",d=this.bitsNeeded,v=this.codePoint,S=0;S<e.length;S+=1){var g=e[S];d!==0&&(g<128||g>191||!n(v<<6|g&63,d-6,i(d,v)))&&(d=0,v=t,u+=String.fromCharCode(v)),d===0?(g>=0&&g<=127?(d=0,v=g):g>=192&&g<=223?(d=6*1,v=g&31):g>=224&&g<=239?(d=6*2,v=g&15):g>=240&&g<=247?(d=6*3,v=g&7):(d=0,v=t),d!==0&&!n(v,d,i(d,v))&&(d=0,v=t)):(d-=6,v=v<<6|g&63),d===0&&(v<=65535?u+=String.fromCharCode(v):(u+=String.fromCharCode(55296+(v-65535-1>>10)),u+=String.fromCharCode(56320+(v-65535-1&1023))))}return this.bitsNeeded=d,this.codePoint=v,u};var oe=function(){try{return new ie().decode(new N().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(ie==null||N==null||!oe())&&(ie=C);var K=function(){};function z(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=K,this.onload=K,this.onerror=K,this.onreadystatechange=K,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=K}z.prototype.open=function(e,n){this._abort(!0);var i=this,t=this._xhr,u=1,d=0;this._abort=function(l){i._sendTimeout!==0&&(p(i._sendTimeout),i._sendTimeout=0),(u===1||u===2||u===3)&&(u=4,t.onload=K,t.onerror=K,t.onabort=K,t.onprogress=K,t.onreadystatechange=K,t.abort(),d!==0&&(p(d),d=0),l||(i.readyState=4,i.onabort(null),i.onreadystatechange())),u=0};var v=function(){if(u===1){var l=0,w="",Q=void 0;if("contentType"in t)l=200,w="OK",Q=t.contentType;else try{l=t.status,w=t.statusText,Q=t.getResponseHeader("Content-Type")}catch(Ee){l=0,w="",Q=void 0}l!==0&&(u=2,i.readyState=2,i.status=l,i.statusText=w,i._contentType=Q,i.onreadystatechange())}},S=function(){if(v(),u===2||u===3){u=3;var l="";try{l=t.responseText}catch(w){}i.readyState=3,i.responseText=l,i.onprogress()}},g=function(l,w){if((w==null||w.preventDefault==null)&&(w={preventDefault:K}),S(),u===1||u===2||u===3){if(u=4,d!==0&&(p(d),d=0),i.readyState=4,l==="load")i.onload(w);else if(l==="error")i.onerror(w);else if(l==="abort")i.onabort(w);else throw new TypeError;i.onreadystatechange()}},E=function(l){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&g(t.responseText===""?"error":"load",l):t.readyState===3?"onprogress"in t||S():t.readyState===2&&v())},y=function(){d=a(function(){y()},500),t.readyState===3&&S()};"onload"in t&&(t.onload=function(l){g("load",l)}),"onerror"in t&&(t.onerror=function(l){g("error",l)}),"onabort"in t&&(t.onabort=function(l){g("abort",l)}),"onprogress"in t&&(t.onprogress=S),"onreadystatechange"in t&&(t.onreadystatechange=function(l){E(l)}),("contentType"in t||!("ontimeout"in c.prototype))&&(n+=(n.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,n,!0),"readyState"in t&&(d=a(function(){y()},0))},z.prototype.abort=function(){this._abort(!1)},z.prototype.getResponseHeader=function(e){return this._contentType},z.prototype.setRequestHeader=function(e,n){var i=this._xhr;"setRequestHeader"in i&&i.setRequestHeader(e,n)},z.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},z.prototype.send=function(){if((!("ontimeout"in c.prototype)||!("sendAsBinary"in c.prototype)&&!("mozAnon"in c.prototype))&&O!=null&&O.readyState!=null&&O.readyState!=="complete"){var e=this;e._sendTimeout=a(function(){e._sendTimeout=0,e.send()},4);return}var n=this._xhr;"withCredentials"in n&&(n.withCredentials=this.withCredentials);try{n.send(void 0)}catch(i){throw i}};function F(e){return e.replace(/[A-Z]/g,function(n){return String.fromCharCode(n.charCodeAt(0)+32)})}function le(e){for(var n=Object.create(null),i=e.split(`\r
`),t=0;t<i.length;t+=1){var u=i[t],d=u.split(": "),v=d.shift(),S=d.join(": ");n[F(v)]=S}this._map=n}le.prototype.get=function(e){return this._map[F(e)]},c!=null&&c.HEADERS_RECEIVED==null&&(c.HEADERS_RECEIVED=2);function ve(){}ve.prototype.open=function(e,n,i,t,u,d,v){e.open("GET",u);var S=0;e.onprogress=function(){var E=e.responseText,y=E.slice(S);S+=y.length,i(y)},e.onerror=function(E){E.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===c.HEADERS_RECEIVED){var E=e.status,y=e.statusText,l=e.getResponseHeader("Content-Type"),w=e.getAllResponseHeaders();n(E,y,l,new le(w))}},e.withCredentials=d;for(var g in v)Object.prototype.hasOwnProperty.call(v,g)&&e.setRequestHeader(g,v[g]);return e.send(),e};function H(e){this._headers=e}H.prototype.get=function(e){return this._headers.get(e)};function he(){}he.prototype.open=function(e,n,i,t,u,d,v){var S=null,g=new T,E=g.signal,y=new ie;return _(u,{headers:v,credentials:d?"include":"same-origin",signal:E,cache:"no-store"}).then(function(l){return S=l.body.getReader(),n(l.status,l.statusText,l.headers.get("Content-Type"),new H(l.headers)),new U(function(w,Q){var Ee=function(){S.read().then(function(G){if(G.done)w(void 0);else{var P=y.decode(G.value,{stream:!0});i(P),Ee()}}).catch(function(G){Q(G)})};Ee()})}).catch(function(l){if(l.name!=="AbortError")return l}).then(function(l){t(l)}),{abort:function(){S!=null&&S.cancel(),g.abort()}}};function ne(){this._listeners=Object.create(null)}function Se(e){a(function(){throw e},0)}ne.prototype.dispatchEvent=function(e){e.target=this;var n=this._listeners[e.type];if(n!=null)for(var i=n.length,t=0;t<i;t+=1){var u=n[t];try{typeof u.handleEvent=="function"?u.handleEvent(e):u.call(this,e)}catch(d){Se(d)}}},ne.prototype.addEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];t==null&&(t=[],i[e]=t);for(var u=!1,d=0;d<t.length;d+=1)t[d]===n&&(u=!0);u||t.push(n)},ne.prototype.removeEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];if(t!=null){for(var u=[],d=0;d<t.length;d+=1)t[d]!==n&&u.push(t[d]);u.length===0?delete i[e]:i[e]=u}};function re(e){this.type=e,this.target=void 0}function we(e,n){re.call(this,e),this.data=n.data,this.lastEventId=n.lastEventId}we.prototype=Object.create(re.prototype);function pe(e,n){re.call(this,e),this.status=n.status,this.statusText=n.statusText,this.headers=n.headers}pe.prototype=Object.create(re.prototype);function ge(e,n){re.call(this,e),this.error=n.error}ge.prototype=Object.create(re.prototype);var s=-1,f=0,o=1,h=2,R=-1,m=0,I=1,L=2,be=3,Xe=/^text\/event\-stream(;.*)?$/i,qe=1e3,Je=18e6,xe=function(e,n){var i=e==null?n:parseInt(e,10);return i!==i&&(i=n),_e(i)},_e=function(e){return Math.min(Math.max(e,qe),Je)},se=function(e,n,i){try{typeof n=="function"&&n.call(e,i)}catch(t){Se(t)}};function W(e,n){ne.call(this),n=n||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,Ye(this,e,n)}function ze(){return c!=null&&"withCredentials"in c.prototype||V==null?new c:new V}var We=_!=null&&ue!=null&&"body"in ue.prototype;function Ye(e,n,i){n=String(n);var t=Boolean(i.withCredentials),u=i.lastEventIdQueryParameterName||"lastEventId",d=_e(1e3),v=xe(i.heartbeatTimeout,45e3),S="",g=d,E=!1,y=0,l=i.headers||{},w=i.Transport,Q=We&&w==null?void 0:new z(w!=null?new w:ze()),Ee=w!=null&&typeof w!="string"?new w:Q==null?new he:new ve,G=void 0,P=0,J=s,fe="",Te="",Z="",Ce="",j=m,Fe=0,ae=0,Qe=function(D,A,X,q){if(J===f)if(D===200&&X!=null&&Xe.test(X)){J=o,E=Date.now(),g=d,e.readyState=o;var B=new pe("open",{status:D,statusText:A,headers:q});e.dispatchEvent(B),se(e,e.onopen,B)}else{var M="";D!==200?(A&&(A=A.replace(/\s+/g," ")),M="EventSource's response has a status "+D+" "+A+" that is not 200. Aborting the connection."):M="EventSource's response has a Content-Type specifying an unsupported type: "+(X==null?"-":X.replace(/\s+/g," "))+". Aborting the connection.",Me();var B=new pe("error",{status:D,statusText:A,headers:q});e.dispatchEvent(B),se(e,e.onerror,B),console.error(M)}},Ze=function(D){if(J===o){for(var A=-1,X=0;X<D.length;X+=1){var q=D.charCodeAt(X);(q===`
`.charCodeAt(0)||q==="\r".charCodeAt(0))&&(A=X)}var B=(A!==-1?Ce:"")+D.slice(0,A+1);Ce=(A===-1?Ce:"")+D.slice(A+1),D!==""&&(E=Date.now(),y+=D.length);for(var M=0;M<B.length;M+=1){var q=B.charCodeAt(M);if(j===R&&q===`
`.charCodeAt(0))j=m;else if(j===R&&(j=m),q==="\r".charCodeAt(0)||q===`
`.charCodeAt(0)){if(j!==m){j===I&&(ae=M+1);var ee=B.slice(Fe,ae-1),te=B.slice(ae+(ae<M&&B.charCodeAt(ae)===" ".charCodeAt(0)?1:0),M);ee==="data"?(fe+=`
`,fe+=te):ee==="id"?Te=te:ee==="event"?Z=te:ee==="retry"?(d=xe(te,d),g=d):ee==="heartbeatTimeout"&&(v=xe(te,v),P!==0&&(p(P),P=a(function(){ye()},v)))}if(j===m){if(fe!==""){S=Te,Z===""&&(Z="message");var de=new we(Z,{data:fe.slice(1),lastEventId:Te});if(e.dispatchEvent(de),Z==="open"?se(e,e.onopen,de):Z==="message"?se(e,e.onmessage,de):Z==="error"&&se(e,e.onerror,de),J===h)return}fe="",Z=""}j=q==="\r".charCodeAt(0)?R:m}else j===m&&(Fe=M,j=I),j===I?q===":".charCodeAt(0)&&(ae=M+1,j=L):j===L&&(j=be)}}},Pe=function(D){if(J===o||J===f)J=s,P!==0&&(p(P),P=0),P=a(function(){ye()},g),g=_e(Math.min(d*16,g*2)),e.readyState=f;else if(J===h&&D!=null){console.error(D);var A=new ge("error",{error:D});e.dispatchEvent(A),se(e,e.onerror,A)}},Me=function(){J=h,G!=null&&(G.abort(),G=void 0),P!==0&&(p(P),P=0),e.readyState=h},ye=function(){if(P=0,J!==s){if(!E&&G!=null)Pe(new Error("No activity within "+v+" milliseconds. "+(J===f?"No response received.":y+" chars received.")+" Reconnecting.")),G!=null&&(G.abort(),G=void 0);else{var D=Math.max((E||Date.now())+v-Date.now(),1);E=!1,P=a(function(){ye()},D)}return}E=!1,y=0,P=a(function(){ye()},v),J=f,fe="",Z="",Te=S,Ce="",Fe=0,ae=0,j=m;var A=n;if(n.slice(0,5)!=="data:"&&n.slice(0,5)!=="blob:"&&S!==""){var X=n.indexOf("?");A=X===-1?n:n.slice(0,X+1)+n.slice(X+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(te,de){return de===u?"":te}),A+=(n.indexOf("?")===-1?"?":"&")+u+"="+encodeURIComponent(S)}var q=e.withCredentials,B={};B.Accept="text/event-stream";var M=e.headers;if(M!=null)for(var ee in M)Object.prototype.hasOwnProperty.call(M,ee)&&(B[ee]=M[ee]);try{G=Ee.open(Q,Qe,Ze,Pe,A,q,B)}catch(te){throw Me(),te}};e.url=n,e.readyState=f,e.withCredentials=t,e.headers=l,e._close=Me,ye()}W.prototype=Object.create(ne.prototype),W.prototype.CONNECTING=f,W.prototype.OPEN=o,W.prototype.CLOSED=h,W.prototype.close=function(){this._close()},W.CONNECTING=f,W.OPEN=o,W.CLOSED=h,W.prototype.withCredentials=void 0;var Le=b;c!=null&&(b==null||!("withCredentials"in b.prototype))&&(Le=W),function(e){if(typeof Ae=="object"&&typeof Ae.exports=="object"){var n=e(He);n!==void 0&&(Ae.exports=n)}else typeof define=="function"&&define.amd?define(["exports"],e):e(r)}(function(e){e.EventSourcePolyfill=W,e.NativeEventSource=b,e.EventSource=Le})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:He:globalThis)});function ke(r){this.message=r}ke.prototype=new Error,ke.prototype.name="InvalidCharacterError";var je=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var a=String(r).replace(/=+$/,"");if(a.length%4==1)throw new ke("'atob' failed: The string to be decoded is not correctly encoded.");for(var p,c,V=0,x=0,b="";c=a.charAt(x++);~c&&(p=V%4?64*p+c:c,V++%4)?b+=String.fromCharCode(255&p>>(-2*V&6)):0)c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c);return b};function dt(r){var a=r.replace(/-/g,"+").replace(/_/g,"/");switch(a.length%4){case 0:break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}try{return function(p){return decodeURIComponent(je(p).replace(/(.)/g,function(c,V){var x=V.charCodeAt(0).toString(16).toUpperCase();return x.length<2&&(x="0"+x),"%"+x}))}(a)}catch(p){return je(a)}}function Ie(r){this.message=r}function ct(r,a){if(typeof r!="string")throw new Ie("Invalid token specified");var p=(a=a||{}).header===!0?0:1;try{return JSON.parse(dt(r.split(".")[p]))}catch(c){throw new Ie("Invalid token specified: "+c.message)}}Ie.prototype=new Error,Ie.prototype.name="InvalidTokenError";var Be=ct;function Ue(r){return{all:r=r||new Map,on:function(a,p){var c=r.get(a);c&&c.push(p)||r.set(a,[p])},off:function(a,p){var c=r.get(a);c&&c.splice(c.indexOf(p)>>>0,1)},emit:function(a,p){(r.get(a)||[]).slice().map(function(c){c(p)}),(r.get("*")||[]).slice().map(function(c){c(a,p)})}}}var Ge=ft($e());var k;(function(r){r.READY="ready",r.CONNECTED="connected",r.DISCONNECTED="disconnected",r.CHANGED="changed",r.ERROR="error"})(k||(k={}));var Oe=6e4,Ke={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:Oe,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},ce=(r,...a)=>console.error(`[FF-SDK] ${r}`,...a);var ut="1.5.0",lt=500,Ne=globalThis.fetch,vt=Ge.EventSourcePolyfill,me=!!globalThis.Proxy,De=r=>{let{value:a}=r;try{switch(r.kind.toLowerCase()){case"int":case"number":a=Number(a);break;case"boolean":a=a.toString().toLowerCase()==="true";break;case"json":a=JSON.parse(a);break}}catch(p){ce(p)}return a},ht=(r,a,p)=>{let c=!1,V,x,b,O,U,_=!0,ue=()=>{_=!1},ie=()=>{_=!0},N=[],T=Ue(),$=Y(Y({},Ke),p);$.eventsSyncInterval<Oe&&($.eventsSyncInterval=Oe);let C=(s,...f)=>{$.debug&&console.debug(`[FF-SDK] ${s}`,...f)},oe=s=>{if(_){let f=Date.now();f-s.lastAccessed>lt&&(s.count++,s.lastAccessed=f)}};globalThis.onbeforeunload=()=>{N.length&&globalThis.localStorage&&(ue(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(N),ie())};let K=(s,f)=>Re(void 0,null,function*(){return(yield(yield Ne(`${f.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s,target:Y(Y({},a),{identifier:String(a.identifier)})})})).json()).authToken}),z=()=>{if(N.length){C("Sending metrics...",{metrics:N,evaluations:F});let s={metricsData:N.map(f=>({timestamp:Date.now(),count:f.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:f.featureIdentifier},{key:"featureName",value:f.featureIdentifier},{key:"variationIdentifier",value:f.variationIdentifier},{key:"target",value:a.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:ut}]}))};Ne(`${$.eventUrl}/metrics/${V}?cluster=${x}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify(s)}).then(()=>{N=[]}).catch(f=>{C(f)}).finally(()=>{U=window.setTimeout(z,$.eventsSyncInterval)})}else U=window.setTimeout(z,$.eventsSyncInterval)},F={},le=s=>{C("Sending event for",s.flag),me?T.emit(k.CHANGED,new Proxy(s,{get(f,o){var h;if(f.hasOwnProperty(o)&&o==="value"){let R=f.flag,m=s.value,I=N.find(L=>L.featureIdentifier===R&&L.featureValue===m);I?(oe(I),I.variationIdentifier=((h=F[R])==null?void 0:h.identifier)||""):N.push({featureIdentifier:R,featureValue:String(m),variationIdentifier:F[R].identifier||"",count:_?1:0,lastAccessed:Date.now()}),C("Metrics event: Flag",o,"has been read with value via stream update",m)}return o==="value"?De(s):s[o]}})):T.emit(k.CHANGED,{deleted:s.deleted,flag:s.flag,value:De(s)})},ve=function(){return me?new Proxy({},{get(s,f){var h,R,m;let o=s[f];if(s.hasOwnProperty(f)){let I=s[f],L=N.find(be=>be.featureIdentifier===f&&I===be.featureValue);L?(L.variationIdentifier=((h=F[f])==null?void 0:h.identifier)||"",oe(L)):N.push({featureIdentifier:f,featureValue:I,variationIdentifier:((R=F[f])==null?void 0:R.identifier)||"",count:_?1:0,lastAccessed:Date.now()}),C("Metrics event: Flag:",f,"has been read with value:",I,"variationIdentifier:",(m=F[f])==null?void 0:m.identifier)}return o}}):{}},H=ve();K(r,$).then(s=>{if(c)return;O=s;let f=Be(s);if(C("Authenticated",f),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,C("Picking up metrics from previous session")}catch(o){}U=window.setTimeout(z,$.eventsSyncInterval),V=f.environment,x=f.clusterIdentifier,he().then(()=>{C("Fetch all flags ok",H)}).then(()=>{c||Se()}).then(()=>{c||(C("Event stream ready",{storage:H}),T.emit(k.READY,Y({},H)),me||Object.keys(H).forEach(o=>{var h;N.push({featureIdentifier:o,featureValue:H[o],variationIdentifier:((h=F[o])==null?void 0:h.identifier)||"",count:_?1:0,lastAccessed:Date.now()})}))}).catch(o=>{T.emit(k.ERROR,o)})}).catch(s=>{ce("Authentication error: ",s),T.emit(k.ERROR,s)});let he=()=>Re(void 0,null,function*(){try{(yield(yield Ne(`${$.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}})).json()).forEach(o=>{let h=De(o),R=H[o.flag];h!==R&&(C("Flag variation has changed for ",o.identifier),H[o.flag]=h,F[o.flag]=Y(Y({},o),{value:h}),le(o))})}catch(s){return ce("Features fetch operation error: ",s),T.emit(k.ERROR,s),s}}),ne=s=>Re(void 0,null,function*(){var f;try{let o=yield Ne(`${$.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations/${s}?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}});if(o.ok){let h=yield o.json(),R=De(h);if(ue(),H[s]=R,F[s]=Y(Y({},h),{value:R}),ie(),le(h),!me){let m=h.flag,I=N.find(L=>L.featureIdentifier===m&&L.featureValue===h.value);I?(oe(I),I.variationIdentifier=((f=F[m])==null?void 0:f.identifier)||""):N.push({featureIdentifier:m,featureValue:String(h.value),variationIdentifier:F[m].identifier||"",count:_?1:0,lastAccessed:Date.now()})}}else T.emit(k.ERROR,o)}catch(o){ce("Feature fetch operation error: ",o),T.emit(k.ERROR,o)}}),Se=()=>{if(!$.streamEnabled){C("Stream is disabled by configuration. Note: Polling is not yet supported");return}b=new vt(`${$.baseUrl}/stream?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`,"API-Key":r}}),b.onopen=o=>{C("Stream connected",o),T.emit(k.CONNECTED)},b.onclose=o=>{C("Stream disconnected"),T.emit(k.DISCONNECTED)},b.onerror=o=>{ce("Stream has issue",o),T.emit(k.ERROR,o)};let s=o=>{switch(o.event){case"create":setTimeout(()=>ne(o.identifier),1e3);break;case"patch":ne(o.identifier);break;case"delete":delete H[o.identifier],T.emit(k.CHANGED,{flag:o.identifier,value:void 0,deleted:!0}),C("Evaluation deleted",{message:o,storage:H});break}},f=o=>{o.event==="patch"&&he()};b.addEventListener("*",o=>{let h=JSON.parse(o.data);C("Received event from stream: ",h),h.domain==="flag"?s(h):h.domain==="target-segment"&&f(h)})},re=(s,f)=>T.on(s,f),we=(s,f)=>{s?T.off(s,f):ge()},pe=(s,f)=>{var h;let o=H[s];if(!me&&o!==void 0){let R=o,m=s,I=N.find(L=>L.featureIdentifier===m&&L.featureValue===R);I?(oe(I),I.variationIdentifier=((h=F[m])==null?void 0:h.identifier)||""):N.push({featureIdentifier:m,featureValue:R,count:_?1:0,variationIdentifier:F[m].identifier||"",lastAccessed:Date.now()})}return o!==void 0?o:f},ge=()=>{c=!0,C("Closing event stream"),H=ve(),F={},clearTimeout(U),T.all.clear(),typeof(b==null?void 0:b.close)=="function"&&b.close()};return{on:re,off:we,variation:pe,close:ge}};export{k as Event,ht as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
