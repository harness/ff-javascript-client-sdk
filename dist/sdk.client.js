var st=Object.create,He=Object.defineProperty,ft=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty,ct=Object.getOwnPropertyNames,lt=Object.getOwnPropertyDescriptor;var W=Object.assign,ut=t=>He(t,"__esModule",{value:!0});var pt=(t,i)=>()=>(i||(i={exports:{}},t(i.exports,i)),i.exports);var vt=(t,i,p)=>{if(i&&typeof i=="object"||typeof i=="function")for(let f of ct(i))!dt.call(t,f)&&f!=="default"&&He(t,f,{get:()=>i[f],enumerable:!(p=lt(i,f))||p.enumerable});return t},ht=t=>vt(ut(He(t!=null?st(ft(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var Oe=(t,i,p)=>new Promise((f,V)=>{var N=U=>{try{O(p.next(U))}catch(F){V(F)}},T=U=>{try{O(p.throw(U))}catch(F){V(F)}},O=U=>U.done?f(U.value):Promise.resolve(U.value).then(N,T);O((p=p.apply(t,i)).next())});var Xe=pt((Le,Ae)=>{(function(t){"use strict";var i=t.setTimeout,p=t.clearTimeout,f=t.XMLHttpRequest,V=t.XDomainRequest,N=t.ActiveXObject,T=t.EventSource,O=t.document,U=t.Promise,F=t.fetch,pe=t.Response,ie=t.TextDecoder,I=t.TextEncoder,C=t.AbortController;if(typeof window!="undefined"&&typeof O!="undefined"&&!("readyState"in O)&&O.body==null&&(O.readyState="loading",window.addEventListener("load",function(e){O.readyState="complete"},!1)),f==null&&N!=null&&(f=function(){return new N("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function n(){}return n.prototype=e,new n}),Date.now||(Date.now=function(){return new Date().getTime()}),C==null){var Y=F;F=function(e,n){var o=n.signal;return Y(e,{headers:n.headers,credentials:n.credentials,cache:n.cache}).then(function(r){var l=r.body.getReader();return o._reader=l,o._aborted&&o._reader.cancel(),{status:r.status,statusText:r.statusText,headers:r.headers,body:{getReader:function(){return l}}}})},C=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function x(){this.bitsNeeded=0,this.codePoint=0}x.prototype.decode=function(e){function n(m,E,u){if(u===1)return m>=128>>E&&m<<E<=2047;if(u===2)return m>=2048>>E&&m<<E<=55295||m>=57344>>E&&m<<E<=65535;if(u===3)return m>=65536>>E&&m<<E<=1114111;throw new Error}function o(m,E){if(m===6*1)return E>>6>15?3:E>31?2:1;if(m===6*2)return E>15?3:2;if(m===6*3)return 3;throw new Error}for(var r=65533,l="",c=this.bitsNeeded,v=this.codePoint,w=0;w<e.length;w+=1){var h=e[w];c!==0&&(h<128||h>191||!n(v<<6|h&63,c-6,o(c,v)))&&(c=0,v=r,l+=String.fromCharCode(v)),c===0?(h>=0&&h<=127?(c=0,v=h):h>=192&&h<=223?(c=6*1,v=h&31):h>=224&&h<=239?(c=6*2,v=h&15):h>=240&&h<=247?(c=6*3,v=h&7):(c=0,v=r),c!==0&&!n(v,c,o(c,v))&&(c=0,v=r)):(c-=6,v=v<<6|h&63),c===0&&(v<=65535?l+=String.fromCharCode(v):(l+=String.fromCharCode(55296+(v-65535-1>>10)),l+=String.fromCharCode(56320+(v-65535-1&1023))))}return this.bitsNeeded=c,this.codePoint=v,l};var oe=function(){try{return new ie().decode(new I().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(ie==null||I==null||!oe())&&(ie=x);var B=function(){};function q(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=B,this.onload=B,this.onerror=B,this.onreadystatechange=B,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=B}q.prototype.open=function(e,n){this._abort(!0);var o=this,r=this._xhr,l=1,c=0;this._abort=function(u){o._sendTimeout!==0&&(p(o._sendTimeout),o._sendTimeout=0),(l===1||l===2||l===3)&&(l=4,r.onload=B,r.onerror=B,r.onabort=B,r.onprogress=B,r.onreadystatechange=B,r.abort(),c!==0&&(p(c),c=0),u||(o.readyState=4,o.onabort(null),o.onreadystatechange())),l=0};var v=function(){if(l===1){var u=0,b="",Q=void 0;if("contentType"in r)u=200,b="OK",Q=r.contentType;else try{u=r.status,b=r.statusText,Q=r.getResponseHeader("Content-Type")}catch(Ee){u=0,b="",Q=void 0}u!==0&&(l=2,o.readyState=2,o.status=u,o.statusText=b,o._contentType=Q,o.onreadystatechange())}},w=function(){if(v(),l===2||l===3){l=3;var u="";try{u=r.responseText}catch(b){}o.readyState=3,o.responseText=u,o.onprogress()}},h=function(u,b){if((b==null||b.preventDefault==null)&&(b={preventDefault:B}),w(),l===1||l===2||l===3){if(l=4,c!==0&&(p(c),c=0),o.readyState=4,u==="load")o.onload(b);else if(u==="error")o.onerror(b);else if(u==="abort")o.onabort(b);else throw new TypeError;o.onreadystatechange()}},m=function(u){r!=null&&(r.readyState===4?(!("onload"in r)||!("onerror"in r)||!("onabort"in r))&&h(r.responseText===""?"error":"load",u):r.readyState===3?"onprogress"in r||w():r.readyState===2&&v())},E=function(){c=i(function(){E()},500),r.readyState===3&&w()};"onload"in r&&(r.onload=function(u){h("load",u)}),"onerror"in r&&(r.onerror=function(u){h("error",u)}),"onabort"in r&&(r.onabort=function(u){h("abort",u)}),"onprogress"in r&&(r.onprogress=w),"onreadystatechange"in r&&(r.onreadystatechange=function(u){m(u)}),("contentType"in r||!("ontimeout"in f.prototype))&&(n+=(n.indexOf("?")===-1?"?":"&")+"padding=true"),r.open(e,n,!0),"readyState"in r&&(c=i(function(){E()},0))},q.prototype.abort=function(){this._abort(!1)},q.prototype.getResponseHeader=function(e){return this._contentType},q.prototype.setRequestHeader=function(e,n){var o=this._xhr;"setRequestHeader"in o&&o.setRequestHeader(e,n)},q.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},q.prototype.send=function(){if((!("ontimeout"in f.prototype)||!("sendAsBinary"in f.prototype)&&!("mozAnon"in f.prototype))&&O!=null&&O.readyState!=null&&O.readyState!=="complete"){var e=this;e._sendTimeout=i(function(){e._sendTimeout=0,e.send()},4);return}var n=this._xhr;"withCredentials"in n&&(n.withCredentials=this.withCredentials);try{n.send(void 0)}catch(o){throw o}};function _(e){return e.replace(/[A-Z]/g,function(n){return String.fromCharCode(n.charCodeAt(0)+32)})}function ve(e){for(var n=Object.create(null),o=e.split(`\r
`),r=0;r<o.length;r+=1){var l=o[r],c=l.split(": "),v=c.shift(),w=c.join(": ");n[_(v)]=w}this._map=n}ve.prototype.get=function(e){return this._map[_(e)]},f!=null&&f.HEADERS_RECEIVED==null&&(f.HEADERS_RECEIVED=2);function he(){}he.prototype.open=function(e,n,o,r,l,c,v){e.open("GET",l);var w=0;e.onprogress=function(){var m=e.responseText,E=m.slice(w);w+=E.length,o(E)},e.onerror=function(m){m.preventDefault(),r(new Error("NetworkError"))},e.onload=function(){r(null)},e.onabort=function(){r(null)},e.onreadystatechange=function(){if(e.readyState===f.HEADERS_RECEIVED){var m=e.status,E=e.statusText,u=e.getResponseHeader("Content-Type"),b=e.getAllResponseHeaders();n(m,E,u,new ve(b))}},e.withCredentials=c;for(var h in v)Object.prototype.hasOwnProperty.call(v,h)&&e.setRequestHeader(h,v[h]);return e.send(),e};function H(e){this._headers=e}H.prototype.get=function(e){return this._headers.get(e)};function ge(){}ge.prototype.open=function(e,n,o,r,l,c,v){var w=null,h=new C,m=h.signal,E=new ie;return F(l,{headers:v,credentials:c?"include":"same-origin",signal:m,cache:"no-store"}).then(function(u){return w=u.body.getReader(),n(u.status,u.statusText,u.headers.get("Content-Type"),new H(u.headers)),new U(function(b,Q){var Ee=function(){w.read().then(function(K){if(K.done)b(void 0);else{var k=E.decode(K.value,{stream:!0});o(k),Ee()}}).catch(function(K){Q(K)})};Ee()})}).catch(function(u){if(u.name!=="AbortError")return u}).then(function(u){r(u)}),{abort:function(){w!=null&&w.cancel(),h.abort()}}};function re(){this._listeners=Object.create(null)}function be(e){i(function(){throw e},0)}re.prototype.dispatchEvent=function(e){e.target=this;var n=this._listeners[e.type];if(n!=null)for(var o=n.length,r=0;r<o;r+=1){var l=n[r];try{typeof l.handleEvent=="function"?l.handleEvent(e):l.call(this,e)}catch(c){be(c)}}},re.prototype.addEventListener=function(e,n){e=String(e);var o=this._listeners,r=o[e];r==null&&(r=[],o[e]=r);for(var l=!1,c=0;c<r.length;c+=1)r[c]===n&&(l=!0);l||r.push(n)},re.prototype.removeEventListener=function(e,n){e=String(e);var o=this._listeners,r=o[e];if(r!=null){for(var l=[],c=0;c<r.length;c+=1)r[c]!==n&&l.push(r[c]);l.length===0?delete o[e]:o[e]=l}};function ne(e){this.type=e,this.target=void 0}function Se(e,n){ne.call(this,e),this.data=n.data,this.lastEventId=n.lastEventId}Se.prototype=Object.create(ne.prototype);function me(e,n){ne.call(this,e),this.status=n.status,this.statusText=n.statusText,this.headers=n.headers}me.prototype=Object.create(ne.prototype);function Te(e,n){ne.call(this,e),this.error=n.error}Te.prototype=Object.create(ne.prototype);var se=-1,s=0,d=1,a=2,g=-1,y=0,S=1,A=2,$=3,Ce=/^text\/event\-stream(;.*)?$/i,et=1e3,tt=18e6,_e=function(e,n){var o=e==null?n:parseInt(e,10);return o!==o&&(o=n),Pe(o)},Pe=function(e){return Math.min(Math.max(e,et),tt)},fe=function(e,n,o){try{typeof n=="function"&&n.call(e,o)}catch(r){be(r)}};function J(e,n){re.call(this),n=n||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,it(this,e,n)}function rt(){return f!=null&&"withCredentials"in f.prototype||V==null?new f:new V}var nt=F!=null&&pe!=null&&"body"in pe.prototype;function it(e,n,o){n=String(n);var r=Boolean(o.withCredentials),l=o.lastEventIdQueryParameterName||"lastEventId",c=Pe(1e3),v=_e(o.heartbeatTimeout,45e3),w="",h=c,m=!1,E=0,u=o.headers||{},b=o.Transport,Q=nt&&b==null?void 0:new q(b!=null?new b:rt()),Ee=b!=null&&typeof b!="string"?new b:Q==null?new ge:new he,K=void 0,k=0,X=se,de="",xe="",Z="",Re="",L=y,Ve=0,ae=0,at=function(D,R,G,z){if(X===s)if(D===200&&G!=null&&Ce.test(G)){X=d,m=Date.now(),h=c,e.readyState=d;var j=new me("open",{status:D,statusText:R,headers:z});e.dispatchEvent(j),fe(e,e.onopen,j)}else{var P="";D!==200?(R&&(R=R.replace(/\s+/g," ")),P="EventSource's response has a status "+D+" "+R+" that is not 200. Aborting the connection."):P="EventSource's response has a Content-Type specifying an unsupported type: "+(G==null?"-":G.replace(/\s+/g," "))+". Aborting the connection.",Me();var j=new me("error",{status:D,statusText:R,headers:z});e.dispatchEvent(j),fe(e,e.onerror,j),console.error(P)}},ot=function(D){if(X===d){for(var R=-1,G=0;G<D.length;G+=1){var z=D.charCodeAt(G);(z===`
`.charCodeAt(0)||z==="\r".charCodeAt(0))&&(R=G)}var j=(R!==-1?Re:"")+D.slice(0,R+1);Re=(R===-1?Re:"")+D.slice(R+1),D!==""&&(m=Date.now(),E+=D.length);for(var P=0;P<j.length;P+=1){var z=j.charCodeAt(P);if(L===g&&z===`
`.charCodeAt(0))L=y;else if(L===g&&(L=y),z==="\r".charCodeAt(0)||z===`
`.charCodeAt(0)){if(L!==y){L===S&&(ae=P+1);var ee=j.slice(Ve,ae-1),te=j.slice(ae+(ae<P&&j.charCodeAt(ae)===" ".charCodeAt(0)?1:0),P);ee==="data"?(de+=`
`,de+=te):ee==="id"?xe=te:ee==="event"?Z=te:ee==="retry"?(c=_e(te,c),h=c):ee==="heartbeatTimeout"&&(v=_e(te,v),k!==0&&(p(k),k=i(function(){ye()},v)))}if(L===y){if(de!==""){w=xe,Z===""&&(Z="message");var ce=new Se(Z,{data:de.slice(1),lastEventId:xe});if(e.dispatchEvent(ce),Z==="open"?fe(e,e.onopen,ce):Z==="message"?fe(e,e.onmessage,ce):Z==="error"&&fe(e,e.onerror,ce),X===a)return}de="",Z=""}L=z==="\r".charCodeAt(0)?g:y}else L===y&&(Ve=P,L=S),L===S?z===":".charCodeAt(0)&&(ae=P+1,L=A):L===A&&(L=$)}}},Be=function(D){if(X===d||X===s)X=se,k!==0&&(p(k),k=0),k=i(function(){ye()},h),h=Pe(Math.min(c*16,h*2)),e.readyState=s;else if(X===a&&D!=null){console.error(D);var R=new Te("error",{error:D});e.dispatchEvent(R),fe(e,e.onerror,R)}},Me=function(){X=a,K!=null&&(K.abort(),K=void 0),k!==0&&(p(k),k=0),e.readyState=a},ye=function(){if(k=0,X!==se){if(!m&&K!=null)Be(new Error("No activity within "+v+" milliseconds. "+(X===s?"No response received.":E+" chars received.")+" Reconnecting.")),K!=null&&(K.abort(),K=void 0);else{var D=Math.max((m||Date.now())+v-Date.now(),1);m=!1,k=i(function(){ye()},D)}return}m=!1,E=0,k=i(function(){ye()},v),X=s,de="",Z="",xe=w,Re="",Ve=0,ae=0,L=y;var R=n;if(n.slice(0,5)!=="data:"&&n.slice(0,5)!=="blob:"&&w!==""){var G=n.indexOf("?");R=G===-1?n:n.slice(0,G+1)+n.slice(G+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(te,ce){return ce===l?"":te}),R+=(n.indexOf("?")===-1?"?":"&")+l+"="+encodeURIComponent(w)}var z=e.withCredentials,j={};j.Accept="text/event-stream";var P=e.headers;if(P!=null)for(var ee in P)Object.prototype.hasOwnProperty.call(P,ee)&&(j[ee]=P[ee]);try{K=Ee.open(Q,at,ot,Be,R,z,j)}catch(te){throw Me(),te}};e.url=n,e.readyState=s,e.withCredentials=r,e.headers=u,e._close=Me,ye()}J.prototype=Object.create(re.prototype),J.prototype.CONNECTING=s,J.prototype.OPEN=d,J.prototype.CLOSED=a,J.prototype.close=function(){this._close()},J.CONNECTING=s,J.OPEN=d,J.CLOSED=a,J.prototype.withCredentials=void 0;var $e=T;f!=null&&(T==null||!("withCredentials"in T.prototype))&&($e=J),function(e){if(typeof Ae=="object"&&typeof Ae.exports=="object"){var n=e(Le);n!==void 0&&(Ae.exports=n)}else typeof define=="function"&&define.amd?define(["exports"],e):e(t)}(function(e){e.EventSourcePolyfill=J,e.NativeEventSource=T,e.EventSource=$e})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Le:globalThis)});function ke(t){this.message=t}ke.prototype=new Error,ke.prototype.name="InvalidCharacterError";var Ke=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(t){var i=String(t).replace(/=+$/,"");if(i.length%4==1)throw new ke("'atob' failed: The string to be decoded is not correctly encoded.");for(var p,f,V=0,N=0,T="";f=i.charAt(N++);~f&&(p=V%4?64*p+f:f,V++%4)?T+=String.fromCharCode(255&p>>(-2*V&6)):0)f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(f);return T};function gt(t){var i=t.replace(/-/g,"+").replace(/_/g,"/");switch(i.length%4){case 0:break;case 2:i+="==";break;case 3:i+="=";break;default:throw"Illegal base64url string!"}try{return function(p){return decodeURIComponent(Ke(p).replace(/(.)/g,function(f,V){var N=V.charCodeAt(0).toString(16).toUpperCase();return N.length<2&&(N="0"+N),"%"+N}))}(i)}catch(p){return Ke(i)}}function Ie(t){this.message=t}function mt(t,i){if(typeof t!="string")throw new Ie("Invalid token specified");var p=(i=i||{}).header===!0?0:1;try{return JSON.parse(gt(t.split(".")[p]))}catch(f){throw new Ie("Invalid token specified: "+f.message)}}Ie.prototype=new Error,Ie.prototype.name="InvalidTokenError";var Ge=mt;function ze(t){return{all:t=t||new Map,on:function(i,p){var f=t.get(i);f&&f.push(p)||t.set(i,[p])},off:function(i,p){var f=t.get(i);f&&f.splice(f.indexOf(p)>>>0,1)},emit:function(i,p){(t.get(i)||[]).slice().map(function(f){f(p)}),(t.get("*")||[]).slice().map(function(f){f(i,p)})}}}var Ze=ht(Xe());var M;(function(t){t.READY="ready",t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.CHANGED="changed",t.ERROR="error"})(M||(M={}));var qe={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},le=(t,...i)=>console.error(`[FF-SDK] ${t}`,...i),De=30*1e3;var ue;(function(t){t.NOOP="noop",t.AMPLITUDE="amplitude"})(ue||(ue={}));var je=class{initialize(i){console.log(`Initializing provider with ${i.apiKey}`)}experiment(i,p,f){console.log(`Experiment for ${i} with variation ${p} and target ${f.identifier}`)}},Je=je;var Ue=class{experiment(i,p,f){}initialize(i){}},We=Ue;var Ye=new Map([[ue.NOOP,new Je],[ue.AMPLITUDE,new We]]),Et=t=>Ye[t]||Ye[ue.NOOP],Qe=t=>{let i=Et(t.provider);return i!==void 0&&i.initialize(t.config),i};var yt="1.4.14",wt=500,Ne=globalThis.fetch,bt=Ze.EventSourcePolyfill,we=!!globalThis.Proxy,Fe=t=>{let{value:i}=t;try{switch(t.kind.toLowerCase()){case"int":case"number":i=Number(i);break;case"boolean":i=i.toString().toLowerCase()==="true";break;case"json":i=JSON.parse(i);break}}catch(p){le(p)}return i},St=(t,i,p)=>{let f=!1,V,N,T,O,U,F=!0,pe=()=>{F=!1},ie=()=>{F=!0},I=[],C=ze(),Y=W(W({},qe),p),x=(s,...d)=>{Y.debug&&console.debug(`[FF-SDK] ${s}`,...d)},oe=s=>{if(F){let d=Date.now();d-s.lastAccessed>wt&&(s.count++,s.lastAccessed=d)}};globalThis.onbeforeunload=()=>{I.length&&globalThis.localStorage&&(pe(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(I),ie())};let B=(s,d)=>Oe(void 0,null,function*(){return(yield(yield Ne(`${d.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s,target:W(W({},i),{identifier:String(i.identifier)})})})).json()).authToken}),q=()=>{if(I.length){x("Sending metrics...",{metrics:I,evaluations:_});let s={metricsData:I.map(d=>({timestamp:Date.now(),count:d.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:d.featureIdentifier},{key:"featureName",value:d.featureIdentifier},{key:"variationIdentifier",value:d.variationIdentifier},{key:"target",value:i.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:yt}]}))};Ne(`${Y.eventUrl}/metrics/${V}?cluster=${N}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify(s)}).then(()=>{I=[]}).catch(d=>{x(d)}).finally(()=>{U=window.setTimeout(q,De)})}else U=window.setTimeout(q,De)},_={},ve=s=>{x("Sending event for",s.flag),we?C.emit(M.CHANGED,new Proxy(s,{get(d,a){var g;if(d.hasOwnProperty(a)&&a==="value"){let y=d.flag,S=s.value,A=I.find($=>$.featureIdentifier===y&&$.featureValue===S);A?(oe(A),A.variationIdentifier=((g=_[y])==null?void 0:g.identifier)||""):I.push({featureIdentifier:y,featureValue:String(S),variationIdentifier:_[y].identifier||"",count:F?1:0,lastAccessed:Date.now()}),x("Metrics event: Flag",a,"has been read with value via stream update",S)}return a==="value"?Fe(s):s[a]}})):C.emit(M.CHANGED,{deleted:s.deleted,flag:s.flag,value:Fe(s)})},he=function(){return we?new Proxy({},{get(s,d){var g,y,S;let a=s[d];if(s.hasOwnProperty(d)){let A=s[d],$=I.find(Ce=>Ce.featureIdentifier===d&&A===Ce.featureValue);$?($.variationIdentifier=((g=_[d])==null?void 0:g.identifier)||"",oe($)):I.push({featureIdentifier:d,featureValue:A,variationIdentifier:((y=_[d])==null?void 0:y.identifier)||"",count:F?1:0,lastAccessed:Date.now()}),x("Metrics event: Flag:",d,"has been read with value:",A,"variationIdentifier:",(S=_[d])==null?void 0:S.identifier)}return a}}):{}},H=he();B(t,Y).then(s=>{if(f)return;O=s;let d=Ge(s);if(x("Authenticated",d),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,x("Picking up metrics from previous session")}catch(a){}U=window.setTimeout(q,De),V=d.environment,N=d.clusterIdentifier,ge().then(()=>{x("Fetch all flags ok",H)}).then(()=>{f||be()}).then(()=>{f||(x("Event stream ready",{storage:H}),C.emit(M.READY,W({},H)),we||Object.keys(H).forEach(a=>{var g;I.push({featureIdentifier:a,featureValue:H[a],variationIdentifier:((g=_[a])==null?void 0:g.identifier)||"",count:F?1:0,lastAccessed:Date.now()})}))}).catch(a=>{C.emit(M.ERROR,a)})}).catch(s=>{le("Authentication error: ",s),C.emit(M.ERROR,s)});let ge=()=>Oe(void 0,null,function*(){try{(yield(yield Ne(`${Y.baseUrl}/client/env/${V}/target/${i.identifier}/evaluations?cluster=${N}`,{headers:{Authorization:`Bearer ${O}`}})).json()).forEach(a=>{let g=Fe(a),y=H[a.flag];g!==y&&(x("Flag variation has changed for ",a.identifier),H[a.flag]=g,_[a.flag]=W(W({},a),{value:g}),ve(a))})}catch(s){return le("Features fetch operation error: ",s),C.emit(M.ERROR,s),s}}),re=s=>Oe(void 0,null,function*(){var d;try{let a=yield Ne(`${Y.baseUrl}/client/env/${V}/target/${i.identifier}/evaluations/${s}?cluster=${N}`,{headers:{Authorization:`Bearer ${O}`}});if(a.ok){let g=yield a.json(),y=Fe(g);if(pe(),H[s]=y,_[s]=W(W({},g),{value:y}),ie(),ve(g),!we){let S=g.flag,A=I.find($=>$.featureIdentifier===S&&$.featureValue===g.value);A?(oe(A),A.variationIdentifier=((d=_[S])==null?void 0:d.identifier)||""):I.push({featureIdentifier:S,featureValue:String(g.value),variationIdentifier:_[S].identifier||"",count:F?1:0,lastAccessed:Date.now()})}}else C.emit(M.ERROR,a)}catch(a){le("Feature fetch operation error: ",a),C.emit(M.ERROR,a)}}),be=()=>{if(!Y.streamEnabled){x("Stream is disabled by configuration. Note: Polling is not yet supported");return}T=new bt(`${Y.baseUrl}/stream?cluster=${N}`,{headers:{Authorization:`Bearer ${O}`,"API-Key":t}}),T.onopen=a=>{x("Stream connected",a),C.emit(M.CONNECTED)},T.onclose=a=>{x("Stream disconnected"),C.emit(M.DISCONNECTED)},T.onerror=a=>{le("Stream has issue",a),C.emit(M.ERROR,a)};let s=a=>{switch(a.event){case"create":setTimeout(()=>re(a.identifier),1e3);break;case"patch":re(a.identifier);break;case"delete":delete H[a.identifier],C.emit(M.CHANGED,{flag:a.identifier,value:void 0,deleted:!0}),x("Evaluation deleted",{message:a,storage:H});break}},d=a=>{a.event==="patch"&&ge()};T.addEventListener("*",a=>{let g=JSON.parse(a.data);x("Received event from stream: ",g),g.domain==="flag"?s(g):g.domain==="target-segment"&&d(g)})},ne=(s,d)=>C.on(s,d),Se=(s,d)=>{s?C.off(s,d):se()},me=(s,d)=>{var g;let a=H[s];if(!we&&a!==void 0){let y=a,S=s,A=I.find($=>$.featureIdentifier===S&&$.featureValue===y);A?(oe(A),A.variationIdentifier=((g=_[S])==null?void 0:g.identifier)||""):I.push({featureIdentifier:S,featureValue:y,count:F?1:0,variationIdentifier:_[S].identifier||"",lastAccessed:Date.now()})}return a!==void 0?a:d},Te=(s,d)=>{let a;p&&p.experiment?(a=Qe(p.experiment),a.experiment(s,d,i)):console.log("experiment called but no experimentation config provided.")},se=()=>{f=!0,x("Closing event stream"),H=he(),_={},clearTimeout(U),C.all.clear(),typeof(T==null?void 0:T.close)=="function"&&T.close()};return{on:ne,off:Se,variation:me,experiment:Te,close:se}};export{M as Event,St as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
