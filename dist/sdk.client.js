var ot=Object.create,Ve=Object.defineProperty,st=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty,ft=Object.getOwnPropertyNames,ct=Object.getOwnPropertyDescriptor;var W=Object.assign,lt=t=>Ve(t,"__esModule",{value:!0});var ut=(t,n)=>()=>(n||(n={exports:{}},t(n.exports,n)),n.exports);var vt=(t,n,l)=>{if(n&&typeof n=="object"||typeof n=="function")for(let d of ft(n))!dt.call(t,d)&&d!=="default"&&Ve(t,d,{get:()=>n[d],enumerable:!(l=ct(n,d))||l.enumerable});return t},ht=t=>vt(lt(Ve(t!=null?ot(st(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var _e=(t,n,l)=>new Promise((d,C)=>{var _=P=>{try{x(l.next(P))}catch(H){C(H)}},T=P=>{try{x(l.throw(P))}catch(H){C(H)}},x=P=>P.done?d(P.value):Promise.resolve(P.value).then(_,T);x((l=l.apply(t,n)).next())});var Ye=ut((Pe,De)=>{(function(t){"use strict";var n=t.setTimeout,l=t.clearTimeout,d=t.XMLHttpRequest,C=t.XDomainRequest,_=t.ActiveXObject,T=t.EventSource,x=t.document,P=t.Promise,H=t.fetch,oe=t.Response,de=t.TextDecoder,me=t.TextEncoder,I=t.AbortController;if(typeof window!="undefined"&&typeof x!="undefined"&&!("readyState"in x)&&x.body==null&&(x.readyState="loading",window.addEventListener("load",function(e){x.readyState="complete"},!1)),d==null&&_!=null&&(d=function(){return new _("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function a(){}return a.prototype=e,new a}),Date.now||(Date.now=function(){return new Date().getTime()}),I==null){var m=H;H=function(e,a){var s=a.signal;return m(e,{headers:a.headers,credentials:a.credentials,cache:a.cache}).then(function(r){var u=r.body.getReader();return s._reader=u,s._aborted&&s._reader.cancel(),{status:r.status,statusText:r.statusText,headers:r.headers,body:{getReader:function(){return u}}}})},I=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function F(){this.bitsNeeded=0,this.codePoint=0}F.prototype.decode=function(e){function a(g,y,v){if(v===1)return g>=128>>y&&g<<y<=2047;if(v===2)return g>=2048>>y&&g<<y<=55295||g>=57344>>y&&g<<y<=65535;if(v===3)return g>=65536>>y&&g<<y<=1114111;throw new Error}function s(g,y){if(g===6*1)return y>>6>15?3:y>31?2:1;if(g===6*2)return y>15?3:2;if(g===6*3)return 3;throw new Error}for(var r=65533,u="",f=this.bitsNeeded,h=this.codePoint,R=0;R<e.length;R+=1){var p=e[R];f!==0&&(p<128||p>191||!a(h<<6|p&63,f-6,s(f,h)))&&(f=0,h=r,u+=String.fromCharCode(h)),f===0?(p>=0&&p<=127?(f=0,h=p):p>=192&&p<=223?(f=6*1,h=p&31):p>=224&&p<=239?(f=6*2,h=p&15):p>=240&&p<=247?(f=6*3,h=p&7):(f=0,h=r),f!==0&&!a(h,f,s(f,h))&&(f=0,h=r)):(f-=6,h=h<<6|p&63),f===0&&(h<=65535?u+=String.fromCharCode(h):(u+=String.fromCharCode(55296+(h-65535-1>>10)),u+=String.fromCharCode(56320+(h-65535-1&1023))))}return this.bitsNeeded=f,this.codePoint=h,u};var A=function(){try{return new de().decode(new me().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(de==null||me==null||!A())&&(de=F);var L=function(){};function Q(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=L,this.onload=L,this.onerror=L,this.onreadystatechange=L,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=L}Q.prototype.open=function(e,a){this._abort(!0);var s=this,r=this._xhr,u=1,f=0;this._abort=function(v){s._sendTimeout!==0&&(l(s._sendTimeout),s._sendTimeout=0),(u===1||u===2||u===3)&&(u=4,r.onload=L,r.onerror=L,r.onabort=L,r.onprogress=L,r.onreadystatechange=L,r.abort(),f!==0&&(l(f),f=0),v||(s.readyState=4,s.onabort(null),s.onreadystatechange())),u=0};var h=function(){if(u===1){var v=0,S="",ne=void 0;if("contentType"in r)v=200,S="OK",ne=r.contentType;else try{v=r.status,S=r.statusText,ne=r.getResponseHeader("Content-Type")}catch(Ce){v=0,S="",ne=void 0}v!==0&&(u=2,s.readyState=2,s.status=v,s.statusText=S,s._contentType=ne,s.onreadystatechange())}},R=function(){if(h(),u===2||u===3){u=3;var v="";try{v=r.responseText}catch(S){}s.readyState=3,s.responseText=v,s.onprogress()}},p=function(v,S){if((S==null||S.preventDefault==null)&&(S={preventDefault:L}),R(),u===1||u===2||u===3){if(u=4,f!==0&&(l(f),f=0),s.readyState=4,v==="load")s.onload(S);else if(v==="error")s.onerror(S);else if(v==="abort")s.onabort(S);else throw new TypeError;s.onreadystatechange()}},g=function(v){r!=null&&(r.readyState===4?(!("onload"in r)||!("onerror"in r)||!("onabort"in r))&&p(r.responseText===""?"error":"load",v):r.readyState===3?"onprogress"in r||R():r.readyState===2&&h())},y=function(){f=n(function(){y()},500),r.readyState===3&&R()};"onload"in r&&(r.onload=function(v){p("load",v)}),"onerror"in r&&(r.onerror=function(v){p("error",v)}),"onabort"in r&&(r.onabort=function(v){p("abort",v)}),"onprogress"in r&&(r.onprogress=R),"onreadystatechange"in r&&(r.onreadystatechange=function(v){g(v)}),("contentType"in r||!("ontimeout"in d.prototype))&&(a+=(a.indexOf("?")===-1?"?":"&")+"padding=true"),r.open(e,a,!0),"readyState"in r&&(f=n(function(){y()},0))},Q.prototype.abort=function(){this._abort(!1)},Q.prototype.getResponseHeader=function(e){return this._contentType},Q.prototype.setRequestHeader=function(e,a){var s=this._xhr;"setRequestHeader"in s&&s.setRequestHeader(e,a)},Q.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},Q.prototype.send=function(){if((!("ontimeout"in d.prototype)||!("sendAsBinary"in d.prototype)&&!("mozAnon"in d.prototype))&&x!=null&&x.readyState!=null&&x.readyState!=="complete"){var e=this;e._sendTimeout=n(function(){e._sendTimeout=0,e.send()},4);return}var a=this._xhr;"withCredentials"in a&&(a.withCredentials=this.withCredentials);try{a.send(void 0)}catch(s){throw s}};function ce(e){return e.replace(/[A-Z]/g,function(a){return String.fromCharCode(a.charCodeAt(0)+32)})}function le(e){for(var a=Object.create(null),s=e.split(`\r
`),r=0;r<s.length;r+=1){var u=s[r],f=u.split(": "),h=f.shift(),R=f.join(": ");a[ce(h)]=R}this._map=a}le.prototype.get=function(e){return this._map[ce(e)]},d!=null&&d.HEADERS_RECEIVED==null&&(d.HEADERS_RECEIVED=2);function M(){}M.prototype.open=function(e,a,s,r,u,f,h){e.open("GET",u);var R=0;e.onprogress=function(){var g=e.responseText,y=g.slice(R);R+=y.length,s(y)},e.onerror=function(g){g.preventDefault(),r(new Error("NetworkError"))},e.onload=function(){r(null)},e.onabort=function(){r(null)},e.onreadystatechange=function(){if(e.readyState===d.HEADERS_RECEIVED){var g=e.status,y=e.statusText,v=e.getResponseHeader("Content-Type"),S=e.getAllResponseHeaders();a(g,y,v,new le(S))}},e.withCredentials=f;for(var p in h)Object.prototype.hasOwnProperty.call(h,p)&&e.setRequestHeader(p,h[p]);return e.send(),e};function be(e){this._headers=e}be.prototype.get=function(e){return this._headers.get(e)};function ye(){}ye.prototype.open=function(e,a,s,r,u,f,h){var R=null,p=new I,g=p.signal,y=new de;return H(u,{headers:h,credentials:f?"include":"same-origin",signal:g,cache:"no-store"}).then(function(v){return R=v.body.getReader(),a(v.status,v.statusText,v.headers.get("Content-Type"),new be(v.headers)),new P(function(S,ne){var Ce=function(){R.read().then(function(B){if(B.done)S(void 0);else{var k=y.decode(B.value,{stream:!0});s(k),Ce()}}).catch(function(B){ne(B)})};Ce()})}).catch(function(v){if(v.name!=="AbortError")return v}).then(function(v){r(v)}),{abort:function(){R!=null&&R.cancel(),p.abort()}}};function N(){this._listeners=Object.create(null)}function Re(e){n(function(){throw e},0)}N.prototype.dispatchEvent=function(e){e.target=this;var a=this._listeners[e.type];if(a!=null)for(var s=a.length,r=0;r<s;r+=1){var u=a[r];try{typeof u.handleEvent=="function"?u.handleEvent(e):u.call(this,e)}catch(f){Re(f)}}},N.prototype.addEventListener=function(e,a){e=String(e);var s=this._listeners,r=s[e];r==null&&(r=[],s[e]=r);for(var u=!1,f=0;f<r.length;f+=1)r[f]===a&&(u=!0);u||r.push(a)},N.prototype.removeEventListener=function(e,a){e=String(e);var s=this._listeners,r=s[e];if(r!=null){for(var u=[],f=0;f<r.length;f+=1)r[f]!==a&&u.push(r[f]);u.length===0?delete s[e]:s[e]=u}};function Z(e){this.type=e,this.target=void 0}function ue(e,a){Z.call(this,e),this.data=a.data,this.lastEventId=a.lastEventId}ue.prototype=Object.create(Z.prototype);function Se(e,a){Z.call(this,e),this.status=a.status,this.statusText=a.statusText,this.headers=a.headers}Se.prototype=Object.create(Z.prototype);function ve(e,a){Z.call(this,e),this.error=a.error}ve.prototype=Object.create(Z.prototype);var we=-1,z=0,ee=1,te=2,o=-1,i=0,c=1,w=2,X=3,G=/^text\/event\-stream(;.*)?$/i,U=1e3,J=18e6,he=function(e,a){var s=e==null?a:parseInt(e,10);return s!==s&&(s=a),Le(s)},Le=function(e){return Math.min(Math.max(e,U),J)},pe=function(e,a,s){try{typeof a=="function"&&a.call(e,s)}catch(r){Re(r)}};function Y(e,a){N.call(this),a=a||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,rt(this,e,a)}function tt(){return d!=null&&"withCredentials"in d.prototype||C==null?new d:new C}var nt=H!=null&&oe!=null&&"body"in oe.prototype;function rt(e,a,s){a=String(a);var r=Boolean(s.withCredentials),u=s.lastEventIdQueryParameterName||"lastEventId",f=Le(1e3),h=he(s.heartbeatTimeout,45e3),R="",p=f,g=!1,y=0,v=s.headers||{},S=s.Transport,ne=nt&&S==null?void 0:new Q(S!=null?new S:tt()),Ce=S!=null&&typeof S!="string"?new S:ne==null?new ye:new M,B=void 0,k=0,q=we,ge="",Ae="",re="",Oe="",V=i,Me=0,fe=0,it=function(O,b,$,K){if(q===z)if(O===200&&$!=null&&G.test($)){q=ee,g=Date.now(),p=f,e.readyState=ee;var j=new Se("open",{status:O,statusText:b,headers:K});e.dispatchEvent(j),pe(e,e.onopen,j)}else{var D="";O!==200?(b&&(b=b.replace(/\s+/g," ")),D="EventSource's response has a status "+O+" "+b+" that is not 200. Aborting the connection."):D="EventSource's response has a Content-Type specifying an unsupported type: "+($==null?"-":$.replace(/\s+/g," "))+". Aborting the connection.",ke();var j=new Se("error",{status:O,statusText:b,headers:K});e.dispatchEvent(j),pe(e,e.onerror,j),console.error(D)}},at=function(O){if(q===ee){for(var b=-1,$=0;$<O.length;$+=1){var K=O.charCodeAt($);(K===`
`.charCodeAt(0)||K==="\r".charCodeAt(0))&&(b=$)}var j=(b!==-1?Oe:"")+O.slice(0,b+1);Oe=(b===-1?Oe:"")+O.slice(b+1),O!==""&&(g=Date.now(),y+=O.length);for(var D=0;D<j.length;D+=1){var K=j.charCodeAt(D);if(V===o&&K===`
`.charCodeAt(0))V=i;else if(V===o&&(V=i),K==="\r".charCodeAt(0)||K===`
`.charCodeAt(0)){if(V!==i){V===c&&(fe=D+1);var ie=j.slice(Me,fe-1),ae=j.slice(fe+(fe<D&&j.charCodeAt(fe)===" ".charCodeAt(0)?1:0),D);ie==="data"?(ge+=`
`,ge+=ae):ie==="id"?Ae=ae:ie==="event"?re=ae:ie==="retry"?(f=he(ae,f),p=f):ie==="heartbeatTimeout"&&(h=he(ae,h),k!==0&&(l(k),k=n(function(){Te()},h)))}if(V===i){if(ge!==""){R=Ae,re===""&&(re="message");var Ee=new ue(re,{data:ge.slice(1),lastEventId:Ae});if(e.dispatchEvent(Ee),re==="open"?pe(e,e.onopen,Ee):re==="message"?pe(e,e.onmessage,Ee):re==="error"&&pe(e,e.onerror,Ee),q===te)return}ge="",re=""}V=K==="\r".charCodeAt(0)?o:i}else V===i&&(Me=D,V=c),V===c?K===":".charCodeAt(0)&&(fe=D+1,V=w):V===w&&(V=X)}}},Ke=function(O){if(q===ee||q===z)q=we,k!==0&&(l(k),k=0),k=n(function(){Te()},p),p=Le(Math.min(f*16,p*2)),e.readyState=z;else if(q===te&&O!=null){console.error(O);var b=new ve("error",{error:O});e.dispatchEvent(b),pe(e,e.onerror,b)}},ke=function(){q=te,B!=null&&(B.abort(),B=void 0),k!==0&&(l(k),k=0),e.readyState=te},Te=function(){if(k=0,q!==we){if(!g&&B!=null)Ke(new Error("No activity within "+h+" milliseconds. "+(q===z?"No response received.":y+" chars received.")+" Reconnecting.")),B!=null&&(B.abort(),B=void 0);else{var O=Math.max((g||Date.now())+h-Date.now(),1);g=!1,k=n(function(){Te()},O)}return}g=!1,y=0,k=n(function(){Te()},h),q=z,ge="",re="",Ae=R,Oe="",Me=0,fe=0,V=i;var b=a;if(a.slice(0,5)!=="data:"&&a.slice(0,5)!=="blob:"&&R!==""){var $=a.indexOf("?");b=$===-1?a:a.slice(0,$+1)+a.slice($+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(ae,Ee){return Ee===u?"":ae}),b+=(a.indexOf("?")===-1?"?":"&")+u+"="+encodeURIComponent(R)}var K=e.withCredentials,j={};j.Accept="text/event-stream";var D=e.headers;if(D!=null)for(var ie in D)Object.prototype.hasOwnProperty.call(D,ie)&&(j[ie]=D[ie]);try{B=Ce.open(ne,it,at,Ke,b,K,j)}catch(ae){throw ke(),ae}};e.url=a,e.readyState=z,e.withCredentials=r,e.headers=v,e._close=ke,Te()}Y.prototype=Object.create(N.prototype),Y.prototype.CONNECTING=z,Y.prototype.OPEN=ee,Y.prototype.CLOSED=te,Y.prototype.close=function(){this._close()},Y.CONNECTING=z,Y.OPEN=ee,Y.CLOSED=te,Y.prototype.withCredentials=void 0;var $e=T;d!=null&&(T==null||!("withCredentials"in T.prototype))&&($e=Y),function(e){if(typeof De=="object"&&typeof De.exports=="object"){var a=e(Pe);a!==void 0&&(De.exports=a)}else typeof define=="function"&&define.amd?define(["exports"],e):e(t)}(function(e){e.EventSourcePolyfill=Y,e.NativeEventSource=T,e.EventSource=$e})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Pe:globalThis)});function je(t){this.message=t}je.prototype=new Error,je.prototype.name="InvalidCharacterError";var Xe=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(t){var n=String(t).replace(/=+$/,"");if(n.length%4==1)throw new je("'atob' failed: The string to be decoded is not correctly encoded.");for(var l,d,C=0,_=0,T="";d=n.charAt(_++);~d&&(l=C%4?64*l+d:d,C++%4)?T+=String.fromCharCode(255&l>>(-2*C&6)):0)d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d);return T};function pt(t){var n=t.replace(/-/g,"+").replace(/_/g,"/");switch(n.length%4){case 0:break;case 2:n+="==";break;case 3:n+="=";break;default:throw"Illegal base64url string!"}try{return function(l){return decodeURIComponent(Xe(l).replace(/(.)/g,function(d,C){var _=C.charCodeAt(0).toString(16).toUpperCase();return _.length<2&&(_="0"+_),"%"+_}))}(n)}catch(l){return Xe(n)}}function Ie(t){this.message=t}function gt(t,n){if(typeof t!="string")throw new Ie("Invalid token specified");var l=(n=n||{}).header===!0?0:1;try{return JSON.parse(pt(t.split(".")[l]))}catch(d){throw new Ie("Invalid token specified: "+d.message)}}Ie.prototype=new Error,Ie.prototype.name="InvalidTokenError";var qe=gt;function Je(t){return{all:t=t||new Map,on:function(n,l){var d=t.get(n);d&&d.push(l)||t.set(n,[l])},off:function(n,l){var d=t.get(n);d&&d.splice(d.indexOf(l)>>>0,1)},emit:function(n,l){(t.get(n)||[]).slice().map(function(d){d(l)}),(t.get("*")||[]).slice().map(function(d){d(n,l)})}}}var et=ht(Ye());var E;(function(t){t.READY="ready",t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.FLAGS_LOADED="flags loaded",t.CACHE_LOADED="cache loaded",t.CHANGED="changed",t.ERROR="error",t.ERROR_METRICS="metrics error",t.ERROR_AUTH="auth error",t.ERROR_FETCH_FLAGS="fetch flags error",t.ERROR_FETCH_FLAG="fetch flag error",t.ERROR_STREAM="stream error"})(E||(E={}));var Fe=6e4,We={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:Fe,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[],cache:!1},se=(t,...n)=>console.error(`[FF-SDK] ${t}`,...n),Ge=(t,n=!0)=>{n?setTimeout(t,0):t()};function ze(t){return"HARNESS_FF_CACHE_"+t}function Ne(t){let n=window.localStorage.getItem(ze(t));if(n)try{return JSON.parse(n)}catch(l){}return[]}function xe(t,n){window.localStorage.setItem(ze(t),JSON.stringify(n))}function Qe(t,n){let l=Ne(t),d=l.find(({flag:C})=>C===n.flag);d?Object.assign(d,n):l.push(n),xe(t,l)}function Ze(t,n){let l=Ne(t),d=l.findIndex(({flag:C})=>C===n);d>-1&&(l.splice(d,1),xe(t,l))}var Et="1.9.1",mt=500,He=globalThis.fetch,yt=et.EventSourcePolyfill,Ue=!!globalThis.Proxy,Be=t=>{let{value:n}=t;try{switch(t.kind.toLowerCase()){case"int":case"number":n=Number(n);break;case"boolean":n=n.toString().toLowerCase()==="true";break;case"json":n=JSON.parse(n);break}}catch(l){se(l)}return n},Rt=(t,n,l)=>{let d=!1,C,_,T,x,P,H=!0,oe={},de=()=>{H=!1},me=()=>{H=!0},I=[],m=Je(),F=W(W({},We),l);F.eventsSyncInterval<Fe&&(F.eventsSyncInterval=Fe);let A=(o,...i)=>{F.debug&&console.debug(`[FF-SDK] ${o}`,...i)},L=o=>{if(H){let i=Date.now();i-o.lastAccessed>mt&&(o.count++,o.lastAccessed=i)}};globalThis.onbeforeunload=()=>{I.length&&globalThis.localStorage&&(de(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(I),me())};let Q=(o,i)=>_e(void 0,null,function*(){return(yield(yield He(`${i.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:o,target:W(W({},n),{identifier:String(n.identifier)})})})).json()).authToken}),ce=0,le=()=>{if(I.length){A("Sending metrics...",{metrics:I,evaluations:M});let o={metricsData:I.map(i=>({timestamp:Date.now(),count:i.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:i.featureIdentifier},{key:"featureName",value:i.featureIdentifier},{key:"variationIdentifier",value:i.variationIdentifier},{key:"target",value:n.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:Et}]}))};He(`${F.eventUrl}/metrics/${C}?cluster=${_}`,{method:"POST",headers:W({"Content-Type":"application/json"},oe),body:JSON.stringify(o)}).then(()=>{I=[],ce=0}).catch(i=>{ce++&&(I=[],ce=0),A(i),m.emit(E.ERROR_METRICS,i)}).finally(()=>{P=window.setTimeout(le,F.eventsSyncInterval)})}else P=window.setTimeout(le,F.eventsSyncInterval)},M={},be=o=>{A("Sending event for",o.flag),Ue?m.emit(E.CHANGED,new Proxy(o,{get(i,c){var w;if(i.hasOwnProperty(c)&&c==="value"){let X=i.flag,G=o.value,U=I.find(J=>J.featureIdentifier===X&&J.featureValue===G);U?(L(U),U.variationIdentifier=((w=M[X])==null?void 0:w.identifier)||""):I.push({featureIdentifier:X,featureValue:String(G),variationIdentifier:M[X].identifier||"",count:H?1:0,lastAccessed:Date.now()}),A("Metrics event: Flag",c,"has been read with value via stream update",G)}return c==="value"?Be(o):o[c]}})):m.emit(E.CHANGED,{deleted:o.deleted,flag:o.flag,value:Be(o)})},ye=function(){return Ue?new Proxy({},{get(o,i){var w,X,G;let c=o[i];if(o.hasOwnProperty(i)){let U=o[i],J=I.find(he=>he.featureIdentifier===i&&U===he.featureValue);J?(J.variationIdentifier=((w=M[i])==null?void 0:w.identifier)||"",L(J)):I.push({featureIdentifier:i,featureValue:U,variationIdentifier:((X=M[i])==null?void 0:X.identifier)||"",count:H?1:0,lastAccessed:Date.now()}),A("Metrics event: Flag:",i,"has been read with value:",U,"variationIdentifier:",(G=M[i])==null?void 0:G.identifier)}return c}}):{}},N=ye();Q(t,F).then(o=>{if(d)return;x=o;let i=qe(o);if(oe={Authorization:`Bearer ${x}`,"Harness-AccountID":i.accountID,"Harness-EnvironmentID":i.environmentIdentifier},A("Authenticated",i),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,A("Picking up metrics from previous session")}catch(w){}P=window.setTimeout(le,F.eventsSyncInterval),C=i.environment,_=i.clusterIdentifier;let c=!!Object.keys(M).length;Re().then(()=>{A("Fetch all flags ok",N)}).then(()=>{d||Se()}).then(()=>{d||(A("Event stream ready",{storage:N}),c||m.emit(E.READY,W({},N)))}).catch(w=>{m.emit(E.ERROR,w)})}).catch(o=>{se("Authentication error: ",o),m.emit(E.ERROR_AUTH,o),m.emit(E.ERROR,o)});let Re=()=>_e(void 0,null,function*(){try{let o=yield He(`${F.baseUrl}/client/env/${C}/target/${n.identifier}/evaluations?cluster=${_}`,{headers:oe});if(o.ok){let i=yield o.json();i.forEach(ue),m.emit(E.FLAGS_LOADED,i)}else se("Features fetch operation error: ",o),m.emit(E.ERROR_FETCH_FLAGS,o),m.emit(E.ERROR,o)}catch(o){return se("Features fetch operation error: ",o),m.emit(E.ERROR_FETCH_FLAGS,o),m.emit(E.ERROR,o),o}}),Z=o=>_e(void 0,null,function*(){try{let i=yield He(`${F.baseUrl}/client/env/${C}/target/${n.identifier}/evaluations/${o}?cluster=${_}`,{headers:oe});if(i.ok){let c=yield i.json();ue(c)}else se("Feature fetch operation error: ",i),m.emit(E.ERROR_FETCH_FLAG,i),m.emit(E.ERROR,i)}catch(i){se("Feature fetch operation error: ",i),m.emit(E.ERROR_FETCH_FLAG,i),m.emit(E.ERROR,i)}}),ue=o=>{de();let i=Be(o);i!==N[o.flag]&&(A("Flag variation has changed for ",o.identifier),N[o.flag]=i,M[o.flag]=W(W({},o),{value:i}),be(o)),me()},Se=()=>{if(!F.streamEnabled){A("Stream is disabled by configuration. Note: Polling is not yet supported");return}T=new yt(`${F.baseUrl}/stream?cluster=${_}`,{headers:W({"API-Key":t},oe)}),T.onopen=c=>{A("Stream connected",c),m.emit(E.CONNECTED)},T.onclose=()=>{A("Stream disconnected"),m.emit(E.DISCONNECTED)},T.onerror=c=>{se("Stream has issue",c),m.emit(E.ERROR_STREAM,c),m.emit(E.ERROR,c)};let o=c=>{switch(c.event){case"create":setTimeout(()=>Z(c.identifier),1e3);break;case"patch":Z(c.identifier);break;case"delete":delete N[c.identifier],m.emit(E.CHANGED,{flag:c.identifier,value:void 0,deleted:!0}),A("Evaluation deleted",{message:c,storage:N});break}},i=c=>{c.event==="patch"&&Re()};T.addEventListener("*",c=>{let w=JSON.parse(c.data);A("Received event from stream: ",w),w.domain==="flag"?o(w):w.domain==="target-segment"&&i(w)})},ve=(o,i)=>m.on(o,i),we=(o,i)=>{o?m.off(o,i):ee()},z=(o,i)=>{var w;let c=N[o];if(!Ue&&c!==void 0){let X=c,G=o,U=I.find(J=>J.featureIdentifier===G&&J.featureValue===X);U?(L(U),U.variationIdentifier=((w=M[G])==null?void 0:w.identifier)||""):I.push({featureIdentifier:G,featureValue:X,count:H?1:0,variationIdentifier:M[G].identifier||"",lastAccessed:Date.now()})}return c!==void 0?c:i},ee=()=>{d=!0,A("Closing event stream"),N=ye(),M={},clearTimeout(P),m.all.clear(),typeof(T==null?void 0:T.close)=="function"&&T.close()},te=(o,i=!0)=>{o.length&&Ge(()=>{let c=!!Object.keys(M).length;o.forEach(ue),c||m.emit(E.READY,W({},N))},i)};if(F.cache&&"localStorage"in window){let o=!0,i=Ne(n.identifier);i&&Ge(()=>{te(i,!1),m.emit(E.CACHE_LOADED,i)}),ve(E.FLAGS_LOADED,c=>{xe(n.identifier,c),o=!1}),ve(E.CHANGED,c=>{o||(c.deleted?Ze(n.identifier,c.flag):Qe(n.identifier,c))})}return{on:ve,off:we,variation:z,close:ee,setEvaluations:te}};export{E as Event,Rt as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
