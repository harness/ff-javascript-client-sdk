var et=Object.create,ke=Object.defineProperty,tt=Object.getPrototypeOf,nt=Object.prototype.hasOwnProperty,rt=Object.getOwnPropertyNames,it=Object.getOwnPropertyDescriptor;var W=Object.assign,at=r=>ke(r,"__esModule",{value:!0});var ot=(r,a)=>()=>(a||(a={exports:{}},r(a.exports,a)),a.exports);var st=(r,a,p)=>{if(a&&typeof a=="object"||typeof a=="function")for(let c of rt(a))!nt.call(r,c)&&c!=="default"&&ke(r,c,{get:()=>a[c],enumerable:!(p=it(a,c))||p.enumerable});return r},ft=r=>st(at(ke(r!=null?et(tt(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var Oe=(r,a,p)=>new Promise((c,V)=>{var D=$=>{try{L(p.next($))}catch(N){V(N)}},b=$=>{try{L(p.throw($))}catch(N){V(N)}},L=$=>$.done?c($.value):Promise.resolve($.value).then(D,b);L((p=p.apply(r,a)).next())});var Ge=ot((Pe,De)=>{(function(r){"use strict";var a=r.setTimeout,p=r.clearTimeout,c=r.XMLHttpRequest,V=r.XDomainRequest,D=r.ActiveXObject,b=r.EventSource,L=r.document,$=r.Promise,N=r.fetch,ie=r.Response,ae=r.TextDecoder,ve=r.TextEncoder,w=r.AbortController;if(typeof window!="undefined"&&typeof L!="undefined"&&!("readyState"in L)&&L.body==null&&(L.readyState="loading",window.addEventListener("load",function(e){L.readyState="complete"},!1)),c==null&&D!=null&&(c=function(){return new D("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function n(){}return n.prototype=e,new n}),Date.now||(Date.now=function(){return new Date().getTime()}),w==null){var x=N;N=function(e,n){var i=n.signal;return x(e,{headers:n.headers,credentials:n.credentials,cache:n.cache}).then(function(t){var l=t.body.getReader();return i._reader=l,i._aborted&&i._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return l}}}})},w=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function P(){this.bitsNeeded=0,this.codePoint=0}P.prototype.decode=function(e){function n(E,y,u){if(u===1)return E>=128>>y&&E<<y<=2047;if(u===2)return E>=2048>>y&&E<<y<=55295||E>=57344>>y&&E<<y<=65535;if(u===3)return E>=65536>>y&&E<<y<=1114111;throw new Error}function i(E,y){if(E===6*1)return y>>6>15?3:y>31?2:1;if(E===6*2)return y>15?3:2;if(E===6*3)return 3;throw new Error}for(var t=65533,l="",d=this.bitsNeeded,h=this.codePoint,m=0;m<e.length;m+=1){var g=e[m];d!==0&&(g<128||g>191||!n(h<<6|g&63,d-6,i(d,h)))&&(d=0,h=t,l+=String.fromCharCode(h)),d===0?(g>=0&&g<=127?(d=0,h=g):g>=192&&g<=223?(d=6*1,h=g&31):g>=224&&g<=239?(d=6*2,h=g&15):g>=240&&g<=247?(d=6*3,h=g&7):(d=0,h=t),d!==0&&!n(h,d,i(d,h))&&(d=0,h=t)):(d-=6,h=h<<6|g&63),d===0&&(h<=65535?l+=String.fromCharCode(h):(l+=String.fromCharCode(55296+(h-65535-1>>10)),l+=String.fromCharCode(56320+(h-65535-1&1023))))}return this.bitsNeeded=d,this.codePoint=h,l};var R=function(){try{return new ae().decode(new ve().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(ae==null||ve==null||!R())&&(ae=P);var H=function(){};function Q(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=H,this.onload=H,this.onerror=H,this.onreadystatechange=H,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=H}Q.prototype.open=function(e,n){this._abort(!0);var i=this,t=this._xhr,l=1,d=0;this._abort=function(u){i._sendTimeout!==0&&(p(i._sendTimeout),i._sendTimeout=0),(l===1||l===2||l===3)&&(l=4,t.onload=H,t.onerror=H,t.onabort=H,t.onprogress=H,t.onreadystatechange=H,t.abort(),d!==0&&(p(d),d=0),u||(i.readyState=4,i.onabort(null),i.onreadystatechange())),l=0};var h=function(){if(l===1){var u=0,S="",ee=void 0;if("contentType"in t)u=200,S="OK",ee=t.contentType;else try{u=t.status,S=t.statusText,ee=t.getResponseHeader("Content-Type")}catch(me){u=0,S="",ee=void 0}u!==0&&(l=2,i.readyState=2,i.status=u,i.statusText=S,i._contentType=ee,i.onreadystatechange())}},m=function(){if(h(),l===2||l===3){l=3;var u="";try{u=t.responseText}catch(S){}i.readyState=3,i.responseText=u,i.onprogress()}},g=function(u,S){if((S==null||S.preventDefault==null)&&(S={preventDefault:H}),m(),l===1||l===2||l===3){if(l=4,d!==0&&(p(d),d=0),i.readyState=4,u==="load")i.onload(S);else if(u==="error")i.onerror(S);else if(u==="abort")i.onabort(S);else throw new TypeError;i.onreadystatechange()}},E=function(u){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&g(t.responseText===""?"error":"load",u):t.readyState===3?"onprogress"in t||m():t.readyState===2&&h())},y=function(){d=a(function(){y()},500),t.readyState===3&&m()};"onload"in t&&(t.onload=function(u){g("load",u)}),"onerror"in t&&(t.onerror=function(u){g("error",u)}),"onabort"in t&&(t.onabort=function(u){g("abort",u)}),"onprogress"in t&&(t.onprogress=m),"onreadystatechange"in t&&(t.onreadystatechange=function(u){E(u)}),("contentType"in t||!("ontimeout"in c.prototype))&&(n+=(n.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,n,!0),"readyState"in t&&(d=a(function(){y()},0))},Q.prototype.abort=function(){this._abort(!1)},Q.prototype.getResponseHeader=function(e){return this._contentType},Q.prototype.setRequestHeader=function(e,n){var i=this._xhr;"setRequestHeader"in i&&i.setRequestHeader(e,n)},Q.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},Q.prototype.send=function(){if((!("ontimeout"in c.prototype)||!("sendAsBinary"in c.prototype)&&!("mozAnon"in c.prototype))&&L!=null&&L.readyState!=null&&L.readyState!=="complete"){var e=this;e._sendTimeout=a(function(){e._sendTimeout=0,e.send()},4);return}var n=this._xhr;"withCredentials"in n&&(n.withCredentials=this.withCredentials);try{n.send(void 0)}catch(i){throw i}};function se(e){return e.replace(/[A-Z]/g,function(n){return String.fromCharCode(n.charCodeAt(0)+32)})}function fe(e){for(var n=Object.create(null),i=e.split(`\r
`),t=0;t<i.length;t+=1){var l=i[t],d=l.split(": "),h=d.shift(),m=d.join(": ");n[se(h)]=m}this._map=n}fe.prototype.get=function(e){return this._map[se(e)]},c!=null&&c.HEADERS_RECEIVED==null&&(c.HEADERS_RECEIVED=2);function _(){}_.prototype.open=function(e,n,i,t,l,d,h){e.open("GET",l);var m=0;e.onprogress=function(){var E=e.responseText,y=E.slice(m);m+=y.length,i(y)},e.onerror=function(E){E.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===c.HEADERS_RECEIVED){var E=e.status,y=e.statusText,u=e.getResponseHeader("Content-Type"),S=e.getAllResponseHeaders();n(E,y,u,new fe(S))}},e.withCredentials=d;for(var g in h)Object.prototype.hasOwnProperty.call(h,g)&&e.setRequestHeader(g,h[g]);return e.send(),e};function he(e){this._headers=e}he.prototype.get=function(e){return this._headers.get(e)};function pe(){}pe.prototype.open=function(e,n,i,t,l,d,h){var m=null,g=new w,E=g.signal,y=new ae;return N(l,{headers:h,credentials:d?"include":"same-origin",signal:E,cache:"no-store"}).then(function(u){return m=u.body.getReader(),n(u.status,u.statusText,u.headers.get("Content-Type"),new he(u.headers)),new $(function(S,ee){var me=function(){m.read().then(function(G){if(G.done)S(void 0);else{var j=y.decode(G.value,{stream:!0});i(j),me()}}).catch(function(G){ee(G)})};me()})}).catch(function(u){if(u.name!=="AbortError")return u}).then(function(u){t(u)}),{abort:function(){m!=null&&m.cancel(),g.abort()}}};function O(){this._listeners=Object.create(null)}function ge(e){a(function(){throw e},0)}O.prototype.dispatchEvent=function(e){e.target=this;var n=this._listeners[e.type];if(n!=null)for(var i=n.length,t=0;t<i;t+=1){var l=n[t];try{typeof l.handleEvent=="function"?l.handleEvent(e):l.call(this,e)}catch(d){ge(d)}}},O.prototype.addEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];t==null&&(t=[],i[e]=t);for(var l=!1,d=0;d<t.length;d+=1)t[d]===n&&(l=!0);l||t.push(n)},O.prototype.removeEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];if(t!=null){for(var l=[],d=0;d<t.length;d+=1)t[d]!==n&&l.push(t[d]);l.length===0?delete i[e]:i[e]=l}};function Z(e){this.type=e,this.target=void 0}function be(e,n){Z.call(this,e),this.data=n.data,this.lastEventId=n.lastEventId}be.prototype=Object.create(Z.prototype);function Ee(e,n){Z.call(this,e),this.status=n.status,this.statusText=n.statusText,this.headers=n.headers}Ee.prototype=Object.create(Z.prototype);function Te(e,n){Z.call(this,e),this.error=n.error}Te.prototype=Object.create(Z.prototype);var ye=-1,Y=0,s=1,f=2,o=-1,v=0,T=1,C=2,F=3,K=/^text\/event\-stream(;.*)?$/i,Ce=1e3,Je=18e6,Fe=function(e,n){var i=e==null?n:parseInt(e,10);return i!==i&&(i=n),Me(i)},Me=function(e){return Math.min(Math.max(e,Ce),Je)},de=function(e,n,i){try{typeof n=="function"&&n.call(e,i)}catch(t){ge(t)}};function z(e,n){O.call(this),n=n||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,ze(this,e,n)}function We(){return c!=null&&"withCredentials"in c.prototype||V==null?new c:new V}var Ye=N!=null&&ie!=null&&"body"in ie.prototype;function ze(e,n,i){n=String(n);var t=Boolean(i.withCredentials),l=i.lastEventIdQueryParameterName||"lastEventId",d=Me(1e3),h=Fe(i.heartbeatTimeout,45e3),m="",g=d,E=!1,y=0,u=i.headers||{},S=i.Transport,ee=Ye&&S==null?void 0:new Q(S!=null?new S:We()),me=S!=null&&typeof S!="string"?new S:ee==null?new pe:new _,G=void 0,j=0,J=ye,ce="",Ie="",te="",Re="",U=v,Ve=0,oe=0,Qe=function(A,I,X,q){if(J===Y)if(A===200&&X!=null&&K.test(X)){J=s,E=Date.now(),g=d,e.readyState=s;var B=new Ee("open",{status:A,statusText:I,headers:q});e.dispatchEvent(B),de(e,e.onopen,B)}else{var M="";A!==200?(I&&(I=I.replace(/\s+/g," ")),M="EventSource's response has a status "+A+" "+I+" that is not 200. Aborting the connection."):M="EventSource's response has a Content-Type specifying an unsupported type: "+(X==null?"-":X.replace(/\s+/g," "))+". Aborting the connection.",He();var B=new Ee("error",{status:A,statusText:I,headers:q});e.dispatchEvent(B),de(e,e.onerror,B),console.error(M)}},Ze=function(A){if(J===s){for(var I=-1,X=0;X<A.length;X+=1){var q=A.charCodeAt(X);(q===`
`.charCodeAt(0)||q==="\r".charCodeAt(0))&&(I=X)}var B=(I!==-1?Re:"")+A.slice(0,I+1);Re=(I===-1?Re:"")+A.slice(I+1),A!==""&&(E=Date.now(),y+=A.length);for(var M=0;M<B.length;M+=1){var q=B.charCodeAt(M);if(U===o&&q===`
`.charCodeAt(0))U=v;else if(U===o&&(U=v),q==="\r".charCodeAt(0)||q===`
`.charCodeAt(0)){if(U!==v){U===T&&(oe=M+1);var ne=B.slice(Ve,oe-1),re=B.slice(oe+(oe<M&&B.charCodeAt(oe)===" ".charCodeAt(0)?1:0),M);ne==="data"?(ce+=`
`,ce+=re):ne==="id"?Ie=re:ne==="event"?te=re:ne==="retry"?(d=Fe(re,d),g=d):ne==="heartbeatTimeout"&&(h=Fe(re,h),j!==0&&(p(j),j=a(function(){Se()},h)))}if(U===v){if(ce!==""){m=Ie,te===""&&(te="message");var le=new be(te,{data:ce.slice(1),lastEventId:Ie});if(e.dispatchEvent(le),te==="open"?de(e,e.onopen,le):te==="message"?de(e,e.onmessage,le):te==="error"&&de(e,e.onerror,le),J===f)return}ce="",te=""}U=q==="\r".charCodeAt(0)?o:v}else U===v&&(Ve=M,U=T),U===T?q===":".charCodeAt(0)&&(oe=M+1,U=C):U===C&&(U=F)}}},Ue=function(A){if(J===s||J===Y)J=ye,j!==0&&(p(j),j=0),j=a(function(){Se()},g),g=Me(Math.min(d*16,g*2)),e.readyState=Y;else if(J===f&&A!=null){console.error(A);var I=new Te("error",{error:A});e.dispatchEvent(I),de(e,e.onerror,I)}},He=function(){J=f,G!=null&&(G.abort(),G=void 0),j!==0&&(p(j),j=0),e.readyState=f},Se=function(){if(j=0,J!==ye){if(!E&&G!=null)Ue(new Error("No activity within "+h+" milliseconds. "+(J===Y?"No response received.":y+" chars received.")+" Reconnecting.")),G!=null&&(G.abort(),G=void 0);else{var A=Math.max((E||Date.now())+h-Date.now(),1);E=!1,j=a(function(){Se()},A)}return}E=!1,y=0,j=a(function(){Se()},h),J=Y,ce="",te="",Ie=m,Re="",Ve=0,oe=0,U=v;var I=n;if(n.slice(0,5)!=="data:"&&n.slice(0,5)!=="blob:"&&m!==""){var X=n.indexOf("?");I=X===-1?n:n.slice(0,X+1)+n.slice(X+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(re,le){return le===l?"":re}),I+=(n.indexOf("?")===-1?"?":"&")+l+"="+encodeURIComponent(m)}var q=e.withCredentials,B={};B.Accept="text/event-stream";var M=e.headers;if(M!=null)for(var ne in M)Object.prototype.hasOwnProperty.call(M,ne)&&(B[ne]=M[ne]);try{G=me.open(ee,Qe,Ze,Ue,I,q,B)}catch(re){throw He(),re}};e.url=n,e.readyState=Y,e.withCredentials=t,e.headers=u,e._close=He,Se()}z.prototype=Object.create(O.prototype),z.prototype.CONNECTING=Y,z.prototype.OPEN=s,z.prototype.CLOSED=f,z.prototype.close=function(){this._close()},z.CONNECTING=Y,z.OPEN=s,z.CLOSED=f,z.prototype.withCredentials=void 0;var je=b;c!=null&&(b==null||!("withCredentials"in b.prototype))&&(je=z),function(e){if(typeof De=="object"&&typeof De.exports=="object"){var n=e(Pe);n!==void 0&&(De.exports=n)}else typeof define=="function"&&define.amd?define(["exports"],e):e(r)}(function(e){e.EventSourcePolyfill=z,e.NativeEventSource=b,e.EventSource=je})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Pe:globalThis)});function Le(r){this.message=r}Le.prototype=new Error,Le.prototype.name="InvalidCharacterError";var Be=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var a=String(r).replace(/=+$/,"");if(a.length%4==1)throw new Le("'atob' failed: The string to be decoded is not correctly encoded.");for(var p,c,V=0,D=0,b="";c=a.charAt(D++);~c&&(p=V%4?64*p+c:c,V++%4)?b+=String.fromCharCode(255&p>>(-2*V&6)):0)c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c);return b};function dt(r){var a=r.replace(/-/g,"+").replace(/_/g,"/");switch(a.length%4){case 0:break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}try{return function(p){return decodeURIComponent(Be(p).replace(/(.)/g,function(c,V){var D=V.charCodeAt(0).toString(16).toUpperCase();return D.length<2&&(D="0"+D),"%"+D}))}(a)}catch(p){return Be(a)}}function Ae(r){this.message=r}function ct(r,a){if(typeof r!="string")throw new Ae("Invalid token specified");var p=(a=a||{}).header===!0?0:1;try{return JSON.parse(dt(r.split(".")[p]))}catch(c){throw new Ae("Invalid token specified: "+c.message)}}Ae.prototype=new Error,Ae.prototype.name="InvalidTokenError";var $e=ct;function Ke(r){return{all:r=r||new Map,on:function(a,p){var c=r.get(a);c&&c.push(p)||r.set(a,[p])},off:function(a,p){var c=r.get(a);c&&c.splice(c.indexOf(p)>>>0,1)},emit:function(a,p){(r.get(a)||[]).slice().map(function(c){c(p)}),(r.get("*")||[]).slice().map(function(c){c(a,p)})}}}var qe=ft(Ge());var k;(function(r){r.READY="ready",r.CONNECTED="connected",r.DISCONNECTED="disconnected",r.CHANGED="changed",r.ERROR="error"})(k||(k={}));var Ne=6e4,Xe={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:Ne,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},ue=(r,...a)=>console.error(`[FF-SDK] ${r}`,...a);var lt="1.7.0",ut=500,xe=globalThis.fetch,vt=qe.EventSourcePolyfill,we=!!globalThis.Proxy,_e=r=>{let{value:a}=r;try{switch(r.kind.toLowerCase()){case"int":case"number":a=Number(a);break;case"boolean":a=a.toString().toLowerCase()==="true";break;case"json":a=JSON.parse(a);break}}catch(p){ue(p)}return a},ht=(r,a,p)=>{let c=!1,V,D,b,L,$,N=!0,ie={},ae=()=>{N=!1},ve=()=>{N=!0},w=[],x=Ke(),P=W(W({},Xe),p);P.eventsSyncInterval<Ne&&(P.eventsSyncInterval=Ne);let R=(s,...f)=>{P.debug&&console.debug(`[FF-SDK] ${s}`,...f)},H=s=>{if(N){let f=Date.now();f-s.lastAccessed>ut&&(s.count++,s.lastAccessed=f)}};globalThis.onbeforeunload=()=>{w.length&&globalThis.localStorage&&(ae(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(w),ve())};let Q=(s,f)=>Oe(void 0,null,function*(){return(yield(yield xe(`${f.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s,target:W(W({},a),{identifier:String(a.identifier)})})})).json()).authToken}),se=0,fe=()=>{if(w.length){R("Sending metrics...",{metrics:w,evaluations:_});let s={metricsData:w.map(f=>({timestamp:Date.now(),count:f.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:f.featureIdentifier},{key:"featureName",value:f.featureIdentifier},{key:"variationIdentifier",value:f.variationIdentifier},{key:"target",value:a.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:lt}]}))};xe(`${P.eventUrl}/metrics/${V}?cluster=${D}`,{method:"POST",headers:W({"Content-Type":"application/json"},ie),body:JSON.stringify(s)}).then(()=>{w=[],se=0}).catch(f=>{se++&&(w=[],se=0),R(f)}).finally(()=>{$=window.setTimeout(fe,P.eventsSyncInterval)})}else $=window.setTimeout(fe,P.eventsSyncInterval)},_={},he=s=>{R("Sending event for",s.flag),we?x.emit(k.CHANGED,new Proxy(s,{get(f,o){var v;if(f.hasOwnProperty(o)&&o==="value"){let T=f.flag,C=s.value,F=w.find(K=>K.featureIdentifier===T&&K.featureValue===C);F?(H(F),F.variationIdentifier=((v=_[T])==null?void 0:v.identifier)||""):w.push({featureIdentifier:T,featureValue:String(C),variationIdentifier:_[T].identifier||"",count:N?1:0,lastAccessed:Date.now()}),R("Metrics event: Flag",o,"has been read with value via stream update",C)}return o==="value"?_e(s):s[o]}})):x.emit(k.CHANGED,{deleted:s.deleted,flag:s.flag,value:_e(s)})},pe=function(){return we?new Proxy({},{get(s,f){var v,T,C;let o=s[f];if(s.hasOwnProperty(f)){let F=s[f],K=w.find(Ce=>Ce.featureIdentifier===f&&F===Ce.featureValue);K?(K.variationIdentifier=((v=_[f])==null?void 0:v.identifier)||"",H(K)):w.push({featureIdentifier:f,featureValue:F,variationIdentifier:((T=_[f])==null?void 0:T.identifier)||"",count:N?1:0,lastAccessed:Date.now()}),R("Metrics event: Flag:",f,"has been read with value:",F,"variationIdentifier:",(C=_[f])==null?void 0:C.identifier)}return o}}):{}},O=pe();Q(r,P).then(s=>{if(c)return;L=s;let f=$e(s);if(ie={Authorization:`Bearer ${L}`,"Harness-AccountID":f.accountID,"Harness-EnvironmentID":f.environmentIdentifier},R("Authenticated",f),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,R("Picking up metrics from previous session")}catch(o){}$=window.setTimeout(fe,P.eventsSyncInterval),V=f.environment,D=f.clusterIdentifier,ge().then(()=>{R("Fetch all flags ok",O)}).then(()=>{c||be()}).then(()=>{c||(R("Event stream ready",{storage:O}),x.emit(k.READY,W({},O)),we||Object.keys(O).forEach(o=>{var v;w.push({featureIdentifier:o,featureValue:O[o],variationIdentifier:((v=_[o])==null?void 0:v.identifier)||"",count:N?1:0,lastAccessed:Date.now()})}))}).catch(o=>{x.emit(k.ERROR,o)})}).catch(s=>{ue("Authentication error: ",s),x.emit(k.ERROR,s)});let ge=()=>Oe(void 0,null,function*(){try{(yield(yield xe(`${P.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations?cluster=${D}`,{headers:ie})).json()).forEach(o=>{let v=_e(o),T=O[o.flag];v!==T&&(R("Flag variation has changed for ",o.identifier),O[o.flag]=v,_[o.flag]=W(W({},o),{value:v}),he(o))})}catch(s){return ue("Features fetch operation error: ",s),x.emit(k.ERROR,s),s}}),Z=s=>Oe(void 0,null,function*(){var f;try{let o=yield xe(`${P.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations/${s}?cluster=${D}`,{headers:ie});if(o.ok){let v=yield o.json(),T=_e(v);if(ae(),O[s]=T,_[s]=W(W({},v),{value:T}),ve(),he(v),!we){let C=v.flag,F=w.find(K=>K.featureIdentifier===C&&K.featureValue===v.value);F?(H(F),F.variationIdentifier=((f=_[C])==null?void 0:f.identifier)||""):w.push({featureIdentifier:C,featureValue:String(v.value),variationIdentifier:_[C].identifier||"",count:N?1:0,lastAccessed:Date.now()})}}else x.emit(k.ERROR,o)}catch(o){ue("Feature fetch operation error: ",o),x.emit(k.ERROR,o)}}),be=()=>{if(!P.streamEnabled){R("Stream is disabled by configuration. Note: Polling is not yet supported");return}b=new vt(`${P.baseUrl}/stream?cluster=${D}`,{headers:W({"API-Key":r},ie)}),b.onopen=o=>{R("Stream connected",o),x.emit(k.CONNECTED)},b.onclose=o=>{R("Stream disconnected"),x.emit(k.DISCONNECTED)},b.onerror=o=>{ue("Stream has issue",o),x.emit(k.ERROR,o)};let s=o=>{switch(o.event){case"create":setTimeout(()=>Z(o.identifier),1e3);break;case"patch":Z(o.identifier);break;case"delete":delete O[o.identifier],x.emit(k.CHANGED,{flag:o.identifier,value:void 0,deleted:!0}),R("Evaluation deleted",{message:o,storage:O});break}},f=o=>{o.event==="patch"&&ge()};b.addEventListener("*",o=>{let v=JSON.parse(o.data);R("Received event from stream: ",v),v.domain==="flag"?s(v):v.domain==="target-segment"&&f(v)})},Ee=(s,f)=>x.on(s,f),Te=(s,f)=>{s?x.off(s,f):Y()},ye=(s,f)=>{var v;let o=O[s];if(!we&&o!==void 0){let T=o,C=s,F=w.find(K=>K.featureIdentifier===C&&K.featureValue===T);F?(H(F),F.variationIdentifier=((v=_[C])==null?void 0:v.identifier)||""):w.push({featureIdentifier:C,featureValue:T,count:N?1:0,variationIdentifier:_[C].identifier||"",lastAccessed:Date.now()})}return o!==void 0?o:f},Y=()=>{c=!0,R("Closing event stream"),O=pe(),_={},clearTimeout($),x.all.clear(),typeof(b==null?void 0:b.close)=="function"&&b.close()};return{on:Ee,off:Te,variation:ye,close:Y}};export{k as Event,ht as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
