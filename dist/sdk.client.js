var et=Object.create,ke=Object.defineProperty,tt=Object.getPrototypeOf,nt=Object.prototype.hasOwnProperty,rt=Object.getOwnPropertyNames,it=Object.getOwnPropertyDescriptor;var Y=Object.assign,at=r=>ke(r,"__esModule",{value:!0});var ot=(r,a)=>()=>(a||(a={exports:{}},r(a.exports,a)),a.exports);var st=(r,a,h)=>{if(a&&typeof a=="object"||typeof a=="function")for(let c of rt(a))!nt.call(r,c)&&c!=="default"&&ke(r,c,{get:()=>a[c],enumerable:!(h=it(a,c))||h.enumerable});return r},ft=r=>st(at(ke(r!=null?et(tt(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var Ie=(r,a,h)=>new Promise((c,V)=>{var x=B=>{try{O(h.next(B))}catch(_){V(_)}},T=B=>{try{O(h.throw(B))}catch(_){V(_)}},O=B=>B.done?c(B.value):Promise.resolve(B.value).then(x,T);O((h=h.apply(r,a)).next())});var Ke=ot((Le,Oe)=>{(function(r){"use strict";var a=r.setTimeout,h=r.clearTimeout,c=r.XMLHttpRequest,V=r.XDomainRequest,x=r.ActiveXObject,T=r.EventSource,O=r.document,B=r.Promise,_=r.fetch,ve=r.Response,ie=r.TextDecoder,C=r.TextEncoder,R=r.AbortController;if(typeof window!="undefined"&&typeof O!="undefined"&&!("readyState"in O)&&O.body==null&&(O.readyState="loading",window.addEventListener("load",function(e){O.readyState="complete"},!1)),c==null&&x!=null&&(c=function(){return new x("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function n(){}return n.prototype=e,new n}),Date.now||(Date.now=function(){return new Date().getTime()}),R==null){var U=_;_=function(e,n){var i=n.signal;return U(e,{headers:n.headers,credentials:n.credentials,cache:n.cache}).then(function(t){var l=t.body.getReader();return i._reader=l,i._aborted&&i._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return l}}}})},R=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function I(){this.bitsNeeded=0,this.codePoint=0}I.prototype.decode=function(e){function n(E,y,u){if(u===1)return E>=128>>y&&E<<y<=2047;if(u===2)return E>=2048>>y&&E<<y<=55295||E>=57344>>y&&E<<y<=65535;if(u===3)return E>=65536>>y&&E<<y<=1114111;throw new Error}function i(E,y){if(E===6*1)return y>>6>15?3:y>31?2:1;if(E===6*2)return y>15?3:2;if(E===6*3)return 3;throw new Error}for(var t=65533,l="",f=this.bitsNeeded,v=this.codePoint,S=0;S<e.length;S+=1){var p=e[S];f!==0&&(p<128||p>191||!n(v<<6|p&63,f-6,i(f,v)))&&(f=0,v=t,l+=String.fromCharCode(v)),f===0?(p>=0&&p<=127?(f=0,v=p):p>=192&&p<=223?(f=6*1,v=p&31):p>=224&&p<=239?(f=6*2,v=p&15):p>=240&&p<=247?(f=6*3,v=p&7):(f=0,v=t),f!==0&&!n(v,f,i(f,v))&&(f=0,v=t)):(f-=6,v=v<<6|p&63),f===0&&(v<=65535?l+=String.fromCharCode(v):(l+=String.fromCharCode(55296+(v-65535-1>>10)),l+=String.fromCharCode(56320+(v-65535-1&1023))))}return this.bitsNeeded=f,this.codePoint=v,l};var oe=function(){try{return new ie().decode(new C().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(ie==null||C==null||!oe())&&(ie=I);var K=function(){};function z(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=K,this.onload=K,this.onerror=K,this.onreadystatechange=K,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=K}z.prototype.open=function(e,n){this._abort(!0);var i=this,t=this._xhr,l=1,f=0;this._abort=function(u){i._sendTimeout!==0&&(h(i._sendTimeout),i._sendTimeout=0),(l===1||l===2||l===3)&&(l=4,t.onload=K,t.onerror=K,t.onabort=K,t.onprogress=K,t.onreadystatechange=K,t.abort(),f!==0&&(h(f),f=0),u||(i.readyState=4,i.onabort(null),i.onreadystatechange())),l=0};var v=function(){if(l===1){var u=0,w="",Q=void 0;if("contentType"in t)u=200,w="OK",Q=t.contentType;else try{u=t.status,w=t.statusText,Q=t.getResponseHeader("Content-Type")}catch(ye){u=0,w="",Q=void 0}u!==0&&(l=2,i.readyState=2,i.status=u,i.statusText=w,i._contentType=Q,i.onreadystatechange())}},S=function(){if(v(),l===2||l===3){l=3;var u="";try{u=t.responseText}catch(w){}i.readyState=3,i.responseText=u,i.onprogress()}},p=function(u,w){if((w==null||w.preventDefault==null)&&(w={preventDefault:K}),S(),l===1||l===2||l===3){if(l=4,f!==0&&(h(f),f=0),i.readyState=4,u==="load")i.onload(w);else if(u==="error")i.onerror(w);else if(u==="abort")i.onabort(w);else throw new TypeError;i.onreadystatechange()}},E=function(u){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&p(t.responseText===""?"error":"load",u):t.readyState===3?"onprogress"in t||S():t.readyState===2&&v())},y=function(){f=a(function(){y()},500),t.readyState===3&&S()};"onload"in t&&(t.onload=function(u){p("load",u)}),"onerror"in t&&(t.onerror=function(u){p("error",u)}),"onabort"in t&&(t.onabort=function(u){p("abort",u)}),"onprogress"in t&&(t.onprogress=S),"onreadystatechange"in t&&(t.onreadystatechange=function(u){E(u)}),("contentType"in t||!("ontimeout"in c.prototype))&&(n+=(n.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,n,!0),"readyState"in t&&(f=a(function(){y()},0))},z.prototype.abort=function(){this._abort(!1)},z.prototype.getResponseHeader=function(e){return this._contentType},z.prototype.setRequestHeader=function(e,n){var i=this._xhr;"setRequestHeader"in i&&i.setRequestHeader(e,n)},z.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},z.prototype.send=function(){if((!("ontimeout"in c.prototype)||!("sendAsBinary"in c.prototype)&&!("mozAnon"in c.prototype))&&O!=null&&O.readyState!=null&&O.readyState!=="complete"){var e=this;e._sendTimeout=a(function(){e._sendTimeout=0,e.send()},4);return}var n=this._xhr;"withCredentials"in n&&(n.withCredentials=this.withCredentials);try{n.send(void 0)}catch(i){throw i}};function se(e){return e.replace(/[A-Z]/g,function(n){return String.fromCharCode(n.charCodeAt(0)+32)})}function F(e){for(var n=Object.create(null),i=e.split(`\r
`),t=0;t<i.length;t+=1){var l=i[t],f=l.split(": "),v=f.shift(),S=f.join(": ");n[se(v)]=S}this._map=n}F.prototype.get=function(e){return this._map[se(e)]},c!=null&&c.HEADERS_RECEIVED==null&&(c.HEADERS_RECEIVED=2);function he(){}he.prototype.open=function(e,n,i,t,l,f,v){e.open("GET",l);var S=0;e.onprogress=function(){var E=e.responseText,y=E.slice(S);S+=y.length,i(y)},e.onerror=function(E){E.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===c.HEADERS_RECEIVED){var E=e.status,y=e.statusText,u=e.getResponseHeader("Content-Type"),w=e.getAllResponseHeaders();n(E,y,u,new F(w))}},e.withCredentials=f;for(var p in v)Object.prototype.hasOwnProperty.call(v,p)&&e.setRequestHeader(p,v[p]);return e.send(),e};function pe(e){this._headers=e}pe.prototype.get=function(e){return this._headers.get(e)};function H(){}H.prototype.open=function(e,n,i,t,l,f,v){var S=null,p=new R,E=p.signal,y=new ie;return _(l,{headers:v,credentials:f?"include":"same-origin",signal:E,cache:"no-store"}).then(function(u){return S=u.body.getReader(),n(u.status,u.statusText,u.headers.get("Content-Type"),new pe(u.headers)),new B(function(w,Q){var ye=function(){S.read().then(function(G){if(G.done)w(void 0);else{var L=y.decode(G.value,{stream:!0});i(L),ye()}}).catch(function(G){Q(G)})};ye()})}).catch(function(u){if(u.name!=="AbortError")return u}).then(function(u){t(u)}),{abort:function(){S!=null&&S.cancel(),p.abort()}}};function ne(){this._listeners=Object.create(null)}function ge(e){a(function(){throw e},0)}ne.prototype.dispatchEvent=function(e){e.target=this;var n=this._listeners[e.type];if(n!=null)for(var i=n.length,t=0;t<i;t+=1){var l=n[t];try{typeof l.handleEvent=="function"?l.handleEvent(e):l.call(this,e)}catch(f){ge(f)}}},ne.prototype.addEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];t==null&&(t=[],i[e]=t);for(var l=!1,f=0;f<t.length;f+=1)t[f]===n&&(l=!0);l||t.push(n)},ne.prototype.removeEventListener=function(e,n){e=String(e);var i=this._listeners,t=i[e];if(t!=null){for(var l=[],f=0;f<t.length;f+=1)t[f]!==n&&l.push(t[f]);l.length===0?delete i[e]:i[e]=l}};function re(e){this.type=e,this.target=void 0}function we(e,n){re.call(this,e),this.data=n.data,this.lastEventId=n.lastEventId}we.prototype=Object.create(re.prototype);function Ee(e,n){re.call(this,e),this.status=n.status,this.statusText=n.statusText,this.headers=n.headers}Ee.prototype=Object.create(re.prototype);function be(e,n){re.call(this,e),this.error=n.error}be.prototype=Object.create(re.prototype);var fe=-1,s=0,d=1,o=2,g=-1,m=0,b=1,N=2,$=3,Te=/^text\/event\-stream(;.*)?$/i,qe=1e3,Je=18e6,_e=function(e,n){var i=e==null?n:parseInt(e,10);return i!==i&&(i=n),Fe(i)},Fe=function(e){return Math.min(Math.max(e,qe),Je)},de=function(e,n,i){try{typeof n=="function"&&n.call(e,i)}catch(t){ge(t)}};function W(e,n){ne.call(this),n=n||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,Ye(this,e,n)}function ze(){return c!=null&&"withCredentials"in c.prototype||V==null?new c:new V}var We=_!=null&&ve!=null&&"body"in ve.prototype;function Ye(e,n,i){n=String(n);var t=Boolean(i.withCredentials),l=i.lastEventIdQueryParameterName||"lastEventId",f=Fe(1e3),v=_e(i.heartbeatTimeout,45e3),S="",p=f,E=!1,y=0,u=i.headers||{},w=i.Transport,Q=We&&w==null?void 0:new z(w!=null?new w:ze()),ye=w!=null&&typeof w!="string"?new w:Q==null?new H:new he,G=void 0,L=0,J=fe,ce="",Ce="",Z="",Re="",P=m,Me=0,ae=0,Qe=function(D,A,X,q){if(J===s)if(D===200&&X!=null&&Te.test(X)){J=d,E=Date.now(),p=f,e.readyState=d;var j=new Ee("open",{status:D,statusText:A,headers:q});e.dispatchEvent(j),de(e,e.onopen,j)}else{var M="";D!==200?(A&&(A=A.replace(/\s+/g," ")),M="EventSource's response has a status "+D+" "+A+" that is not 200. Aborting the connection."):M="EventSource's response has a Content-Type specifying an unsupported type: "+(X==null?"-":X.replace(/\s+/g," "))+". Aborting the connection.",Ve();var j=new Ee("error",{status:D,statusText:A,headers:q});e.dispatchEvent(j),de(e,e.onerror,j),console.error(M)}},Ze=function(D){if(J===d){for(var A=-1,X=0;X<D.length;X+=1){var q=D.charCodeAt(X);(q===`
`.charCodeAt(0)||q==="\r".charCodeAt(0))&&(A=X)}var j=(A!==-1?Re:"")+D.slice(0,A+1);Re=(A===-1?Re:"")+D.slice(A+1),D!==""&&(E=Date.now(),y+=D.length);for(var M=0;M<j.length;M+=1){var q=j.charCodeAt(M);if(P===g&&q===`
`.charCodeAt(0))P=m;else if(P===g&&(P=m),q==="\r".charCodeAt(0)||q===`
`.charCodeAt(0)){if(P!==m){P===b&&(ae=M+1);var ee=j.slice(Me,ae-1),te=j.slice(ae+(ae<M&&j.charCodeAt(ae)===" ".charCodeAt(0)?1:0),M);ee==="data"?(ce+=`
`,ce+=te):ee==="id"?Ce=te:ee==="event"?Z=te:ee==="retry"?(f=_e(te,f),p=f):ee==="heartbeatTimeout"&&(v=_e(te,v),L!==0&&(h(L),L=a(function(){me()},v)))}if(P===m){if(ce!==""){S=Ce,Z===""&&(Z="message");var le=new we(Z,{data:ce.slice(1),lastEventId:Ce});if(e.dispatchEvent(le),Z==="open"?de(e,e.onopen,le):Z==="message"?de(e,e.onmessage,le):Z==="error"&&de(e,e.onerror,le),J===o)return}ce="",Z=""}P=q==="\r".charCodeAt(0)?g:m}else P===m&&(Me=M,P=b),P===b?q===":".charCodeAt(0)&&(ae=M+1,P=N):P===N&&(P=$)}}},je=function(D){if(J===d||J===s)J=fe,L!==0&&(h(L),L=0),L=a(function(){me()},p),p=Fe(Math.min(f*16,p*2)),e.readyState=s;else if(J===o&&D!=null){console.error(D);var A=new be("error",{error:D});e.dispatchEvent(A),de(e,e.onerror,A)}},Ve=function(){J=o,G!=null&&(G.abort(),G=void 0),L!==0&&(h(L),L=0),e.readyState=o},me=function(){if(L=0,J!==fe){if(!E&&G!=null)je(new Error("No activity within "+v+" milliseconds. "+(J===s?"No response received.":y+" chars received.")+" Reconnecting.")),G!=null&&(G.abort(),G=void 0);else{var D=Math.max((E||Date.now())+v-Date.now(),1);E=!1,L=a(function(){me()},D)}return}E=!1,y=0,L=a(function(){me()},v),J=s,ce="",Z="",Ce=S,Re="",Me=0,ae=0,P=m;var A=n;if(n.slice(0,5)!=="data:"&&n.slice(0,5)!=="blob:"&&S!==""){var X=n.indexOf("?");A=X===-1?n:n.slice(0,X+1)+n.slice(X+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(te,le){return le===l?"":te}),A+=(n.indexOf("?")===-1?"?":"&")+l+"="+encodeURIComponent(S)}var q=e.withCredentials,j={};j.Accept="text/event-stream";var M=e.headers;if(M!=null)for(var ee in M)Object.prototype.hasOwnProperty.call(M,ee)&&(j[ee]=M[ee]);try{G=ye.open(Q,Qe,Ze,je,A,q,j)}catch(te){throw Ve(),te}};e.url=n,e.readyState=s,e.withCredentials=t,e.headers=u,e._close=Ve,me()}W.prototype=Object.create(ne.prototype),W.prototype.CONNECTING=s,W.prototype.OPEN=d,W.prototype.CLOSED=o,W.prototype.close=function(){this._close()},W.CONNECTING=s,W.OPEN=d,W.CLOSED=o,W.prototype.withCredentials=void 0;var Pe=T;c!=null&&(T==null||!("withCredentials"in T.prototype))&&(Pe=W),function(e){if(typeof Oe=="object"&&typeof Oe.exports=="object"){var n=e(Le);n!==void 0&&(Oe.exports=n)}else typeof define=="function"&&define.amd?define(["exports"],e):e(r)}(function(e){e.EventSourcePolyfill=W,e.NativeEventSource=T,e.EventSource=Pe})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Le:globalThis)});function He(r){this.message=r}He.prototype=new Error,He.prototype.name="InvalidCharacterError";var Be=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(r){var a=String(r).replace(/=+$/,"");if(a.length%4==1)throw new He("'atob' failed: The string to be decoded is not correctly encoded.");for(var h,c,V=0,x=0,T="";c=a.charAt(x++);~c&&(h=V%4?64*h+c:c,V++%4)?T+=String.fromCharCode(255&h>>(-2*V&6)):0)c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c);return T};function dt(r){var a=r.replace(/-/g,"+").replace(/_/g,"/");switch(a.length%4){case 0:break;case 2:a+="==";break;case 3:a+="=";break;default:throw"Illegal base64url string!"}try{return function(h){return decodeURIComponent(Be(h).replace(/(.)/g,function(c,V){var x=V.charCodeAt(0).toString(16).toUpperCase();return x.length<2&&(x="0"+x),"%"+x}))}(a)}catch(h){return Be(a)}}function Ae(r){this.message=r}function ct(r,a){if(typeof r!="string")throw new Ae("Invalid token specified");var h=(a=a||{}).header===!0?0:1;try{return JSON.parse(dt(r.split(".")[h]))}catch(c){throw new Ae("Invalid token specified: "+c.message)}}Ae.prototype=new Error,Ae.prototype.name="InvalidTokenError";var Ue=ct;function $e(r){return{all:r=r||new Map,on:function(a,h){var c=r.get(a);c&&c.push(h)||r.set(a,[h])},off:function(a,h){var c=r.get(a);c&&c.splice(c.indexOf(h)>>>0,1)},emit:function(a,h){(r.get(a)||[]).slice().map(function(c){c(h)}),(r.get("*")||[]).slice().map(function(c){c(a,h)})}}}var Xe=ft(Ke());var k;(function(r){r.READY="ready",r.CONNECTED="connected",r.DISCONNECTED="disconnected",r.CHANGED="changed",r.ERROR="error"})(k||(k={}));var Ne=6e4,Ge={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:Ne,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},ue=(r,...a)=>console.error(`[FF-SDK] ${r}`,...a);var lt="1.6.0",ut=500,De=globalThis.fetch,vt=Xe.EventSourcePolyfill,Se=!!globalThis.Proxy,xe=r=>{let{value:a}=r;try{switch(r.kind.toLowerCase()){case"int":case"number":a=Number(a);break;case"boolean":a=a.toString().toLowerCase()==="true";break;case"json":a=JSON.parse(a);break}}catch(h){ue(h)}return a},ht=(r,a,h)=>{let c=!1,V,x,T,O,B,_=!0,ve=()=>{_=!1},ie=()=>{_=!0},C=[],R=$e(),U=Y(Y({},Ge),h);U.eventsSyncInterval<Ne&&(U.eventsSyncInterval=Ne);let I=(s,...d)=>{U.debug&&console.debug(`[FF-SDK] ${s}`,...d)},oe=s=>{if(_){let d=Date.now();d-s.lastAccessed>ut&&(s.count++,s.lastAccessed=d)}};globalThis.onbeforeunload=()=>{C.length&&globalThis.localStorage&&(ve(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(C),ie())};let K=(s,d)=>Ie(void 0,null,function*(){return(yield(yield De(`${d.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s,target:Y(Y({},a),{identifier:String(a.identifier)})})})).json()).authToken}),z=0,se=()=>{if(C.length){I("Sending metrics...",{metrics:C,evaluations:F});let s={metricsData:C.map(d=>({timestamp:Date.now(),count:d.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:d.featureIdentifier},{key:"featureName",value:d.featureIdentifier},{key:"variationIdentifier",value:d.variationIdentifier},{key:"target",value:a.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:lt}]}))};De(`${U.eventUrl}/metrics/${V}?cluster=${x}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify(s)}).then(()=>{C=[],z=0}).catch(d=>{z++&&(C=[],z=0),I(d)}).finally(()=>{B=window.setTimeout(se,U.eventsSyncInterval)})}else B=window.setTimeout(se,U.eventsSyncInterval)},F={},he=s=>{I("Sending event for",s.flag),Se?R.emit(k.CHANGED,new Proxy(s,{get(d,o){var g;if(d.hasOwnProperty(o)&&o==="value"){let m=d.flag,b=s.value,N=C.find($=>$.featureIdentifier===m&&$.featureValue===b);N?(oe(N),N.variationIdentifier=((g=F[m])==null?void 0:g.identifier)||""):C.push({featureIdentifier:m,featureValue:String(b),variationIdentifier:F[m].identifier||"",count:_?1:0,lastAccessed:Date.now()}),I("Metrics event: Flag",o,"has been read with value via stream update",b)}return o==="value"?xe(s):s[o]}})):R.emit(k.CHANGED,{deleted:s.deleted,flag:s.flag,value:xe(s)})},pe=function(){return Se?new Proxy({},{get(s,d){var g,m,b;let o=s[d];if(s.hasOwnProperty(d)){let N=s[d],$=C.find(Te=>Te.featureIdentifier===d&&N===Te.featureValue);$?($.variationIdentifier=((g=F[d])==null?void 0:g.identifier)||"",oe($)):C.push({featureIdentifier:d,featureValue:N,variationIdentifier:((m=F[d])==null?void 0:m.identifier)||"",count:_?1:0,lastAccessed:Date.now()}),I("Metrics event: Flag:",d,"has been read with value:",N,"variationIdentifier:",(b=F[d])==null?void 0:b.identifier)}return o}}):{}},H=pe();K(r,U).then(s=>{if(c)return;O=s;let d=Ue(s);if(I("Authenticated",d),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,I("Picking up metrics from previous session")}catch(o){}B=window.setTimeout(se,U.eventsSyncInterval),V=d.environment,x=d.clusterIdentifier,ne().then(()=>{I("Fetch all flags ok",H)}).then(()=>{c||re()}).then(()=>{c||(I("Event stream ready",{storage:H}),R.emit(k.READY,Y({},H)),Se||Object.keys(H).forEach(o=>{var g;C.push({featureIdentifier:o,featureValue:H[o],variationIdentifier:((g=F[o])==null?void 0:g.identifier)||"",count:_?1:0,lastAccessed:Date.now()})}))}).catch(o=>{R.emit(k.ERROR,o)})}).catch(s=>{ue("Authentication error: ",s),R.emit(k.ERROR,s)});let ne=()=>Ie(void 0,null,function*(){try{(yield(yield De(`${U.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}})).json()).forEach(o=>{let g=xe(o),m=H[o.flag];g!==m&&(I("Flag variation has changed for ",o.identifier),H[o.flag]=g,F[o.flag]=Y(Y({},o),{value:g}),he(o))})}catch(s){return ue("Features fetch operation error: ",s),R.emit(k.ERROR,s),s}}),ge=s=>Ie(void 0,null,function*(){var d;try{let o=yield De(`${U.baseUrl}/client/env/${V}/target/${a.identifier}/evaluations/${s}?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}});if(o.ok){let g=yield o.json(),m=xe(g);if(ve(),H[s]=m,F[s]=Y(Y({},g),{value:m}),ie(),he(g),!Se){let b=g.flag,N=C.find($=>$.featureIdentifier===b&&$.featureValue===g.value);N?(oe(N),N.variationIdentifier=((d=F[b])==null?void 0:d.identifier)||""):C.push({featureIdentifier:b,featureValue:String(g.value),variationIdentifier:F[b].identifier||"",count:_?1:0,lastAccessed:Date.now()})}}else R.emit(k.ERROR,o)}catch(o){ue("Feature fetch operation error: ",o),R.emit(k.ERROR,o)}}),re=()=>{if(!U.streamEnabled){I("Stream is disabled by configuration. Note: Polling is not yet supported");return}T=new vt(`${U.baseUrl}/stream?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`,"API-Key":r}}),T.onopen=o=>{I("Stream connected",o),R.emit(k.CONNECTED)},T.onclose=o=>{I("Stream disconnected"),R.emit(k.DISCONNECTED)},T.onerror=o=>{ue("Stream has issue",o),R.emit(k.ERROR,o)};let s=o=>{switch(o.event){case"create":setTimeout(()=>ge(o.identifier),1e3);break;case"patch":ge(o.identifier);break;case"delete":delete H[o.identifier],R.emit(k.CHANGED,{flag:o.identifier,value:void 0,deleted:!0}),I("Evaluation deleted",{message:o,storage:H});break}},d=o=>{o.event==="patch"&&ne()};T.addEventListener("*",o=>{let g=JSON.parse(o.data);I("Received event from stream: ",g),g.domain==="flag"?s(g):g.domain==="target-segment"&&d(g)})},we=(s,d)=>R.on(s,d),Ee=(s,d)=>{s?R.off(s,d):fe()},be=(s,d)=>{var g;let o=H[s];if(!Se&&o!==void 0){let m=o,b=s,N=C.find($=>$.featureIdentifier===b&&$.featureValue===m);N?(oe(N),N.variationIdentifier=((g=F[b])==null?void 0:g.identifier)||""):C.push({featureIdentifier:b,featureValue:m,count:_?1:0,variationIdentifier:F[b].identifier||"",lastAccessed:Date.now()})}return o!==void 0?o:d},fe=()=>{c=!0,I("Closing event stream"),H=pe(),F={},clearTimeout(B),R.all.clear(),typeof(T==null?void 0:T.close)=="function"&&T.close()};return{on:we,off:Ee,variation:be,close:fe}};export{k as Event,ht as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
