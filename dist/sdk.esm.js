var et=Object.create,ke=Object.defineProperty,tt=Object.getPrototypeOf,nt=Object.prototype.hasOwnProperty,rt=Object.getOwnPropertyNames,it=Object.getOwnPropertyDescriptor;var Y=Object.assign,at=t=>ke(t,"__esModule",{value:!0});var ot=(t,s)=>()=>(s||(s={exports:{}},t(s.exports,s)),s.exports);var st=(t,s,g)=>{if(s&&typeof s=="object"||typeof s=="function")for(let h of rt(s))!nt.call(t,h)&&h!=="default"&&ke(t,h,{get:()=>s[h],enumerable:!(g=it(s,h))||g.enumerable});return t},dt=t=>st(at(ke(t!=null?et(tt(t)):{},"default",t&&t.__esModule&&"default"in t?{get:()=>t.default,enumerable:!0}:{value:t,enumerable:!0})),t);var _e=(t,s,g)=>new Promise((h,V)=>{var W=j=>{try{D(g.next(j))}catch(N){V(N)}},_=j=>{try{D(g.throw(j))}catch(N){V(N)}},D=j=>j.done?h(j.value):Promise.resolve(j.value).then(W,_);D((g=g.apply(t,s)).next())});var Be=ot((Ve,Ie)=>{(function(t){"use strict";var s=t.setTimeout,g=t.clearTimeout,h=t.XMLHttpRequest,V=t.XDomainRequest,W=t.ActiveXObject,_=t.EventSource,D=t.document,j=t.Promise,N=t.fetch,oe=t.Response,de=t.TextDecoder,me=t.TextEncoder,O=t.AbortController;if(typeof window!="undefined"&&typeof D!="undefined"&&!("readyState"in D)&&D.body==null&&(D.readyState="loading",window.addEventListener("load",function(e){D.readyState="complete"},!1)),h==null&&W!=null&&(h=function(){return new W("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function i(){}return i.prototype=e,new i}),Date.now||(Date.now=function(){return new Date().getTime()}),O==null){var m=N;N=function(e,i){var o=i.signal;return m(e,{headers:i.headers,credentials:i.credentials,cache:i.cache}).then(function(n){var c=n.body.getReader();return o._reader=c,o._aborted&&o._reader.cancel(),{status:n.status,statusText:n.statusText,headers:n.headers,body:{getReader:function(){return c}}}})},O=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function I(){this.bitsNeeded=0,this.codePoint=0}I.prototype.decode=function(e){function i(p,y,l){if(l===1)return p>=128>>y&&p<<y<=2047;if(l===2)return p>=2048>>y&&p<<y<=55295||p>=57344>>y&&p<<y<=65535;if(l===3)return p>=65536>>y&&p<<y<=1114111;throw new Error}function o(p,y){if(p===6*1)return y>>6>15?3:y>31?2:1;if(p===6*2)return y>15?3:2;if(p===6*3)return 3;throw new Error}for(var n=65533,c="",d=this.bitsNeeded,u=this.codePoint,R=0;R<e.length;R+=1){var v=e[R];d!==0&&(v<128||v>191||!i(u<<6|v&63,d-6,o(d,u)))&&(d=0,u=n,c+=String.fromCharCode(u)),d===0?(v>=0&&v<=127?(d=0,u=v):v>=192&&v<=223?(d=6*1,u=v&31):v>=224&&v<=239?(d=6*2,u=v&15):v>=240&&v<=247?(d=6*3,u=v&7):(d=0,u=n),d!==0&&!i(u,d,o(d,u))&&(d=0,u=n)):(d-=6,u=u<<6|v&63),d===0&&(u<=65535?c+=String.fromCharCode(u):(c+=String.fromCharCode(55296+(u-65535-1>>10)),c+=String.fromCharCode(56320+(u-65535-1&1023))))}return this.bitsNeeded=d,this.codePoint=u,c};var w=function(){try{return new de().decode(new me().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(de==null||me==null||!w())&&(de=I);var x=function(){};function Q(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=x,this.onload=x,this.onerror=x,this.onreadystatechange=x,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=x}Q.prototype.open=function(e,i){this._abort(!0);var o=this,n=this._xhr,c=1,d=0;this._abort=function(l){o._sendTimeout!==0&&(g(o._sendTimeout),o._sendTimeout=0),(c===1||c===2||c===3)&&(c=4,n.onload=x,n.onerror=x,n.onabort=x,n.onprogress=x,n.onreadystatechange=x,n.abort(),d!==0&&(g(d),d=0),l||(o.readyState=4,o.onabort(null),o.onreadystatechange())),c=0};var u=function(){if(c===1){var l=0,S="",ne=void 0;if("contentType"in n)l=200,S="OK",ne=n.contentType;else try{l=n.status,S=n.statusText,ne=n.getResponseHeader("Content-Type")}catch(Ce){l=0,S="",ne=void 0}l!==0&&(c=2,o.readyState=2,o.status=l,o.statusText=S,o._contentType=ne,o.onreadystatechange())}},R=function(){if(u(),c===2||c===3){c=3;var l="";try{l=n.responseText}catch(S){}o.readyState=3,o.responseText=l,o.onprogress()}},v=function(l,S){if((S==null||S.preventDefault==null)&&(S={preventDefault:x}),R(),c===1||c===2||c===3){if(c=4,d!==0&&(g(d),d=0),o.readyState=4,l==="load")o.onload(S);else if(l==="error")o.onerror(S);else if(l==="abort")o.onabort(S);else throw new TypeError;o.onreadystatechange()}},p=function(l){n!=null&&(n.readyState===4?(!("onload"in n)||!("onerror"in n)||!("onabort"in n))&&v(n.responseText===""?"error":"load",l):n.readyState===3?"onprogress"in n||R():n.readyState===2&&u())},y=function(){d=s(function(){y()},500),n.readyState===3&&R()};"onload"in n&&(n.onload=function(l){v("load",l)}),"onerror"in n&&(n.onerror=function(l){v("error",l)}),"onabort"in n&&(n.onabort=function(l){v("abort",l)}),"onprogress"in n&&(n.onprogress=R),"onreadystatechange"in n&&(n.onreadystatechange=function(l){p(l)}),("contentType"in n||!("ontimeout"in h.prototype))&&(i+=(i.indexOf("?")===-1?"?":"&")+"padding=true"),n.open(e,i,!0),"readyState"in n&&(d=s(function(){y()},0))},Q.prototype.abort=function(){this._abort(!1)},Q.prototype.getResponseHeader=function(e){return this._contentType},Q.prototype.setRequestHeader=function(e,i){var o=this._xhr;"setRequestHeader"in o&&o.setRequestHeader(e,i)},Q.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},Q.prototype.send=function(){if((!("ontimeout"in h.prototype)||!("sendAsBinary"in h.prototype)&&!("mozAnon"in h.prototype))&&D!=null&&D.readyState!=null&&D.readyState!=="complete"){var e=this;e._sendTimeout=s(function(){e._sendTimeout=0,e.send()},4);return}var i=this._xhr;"withCredentials"in i&&(i.withCredentials=this.withCredentials);try{i.send(void 0)}catch(o){throw o}};function ce(e){return e.replace(/[A-Z]/g,function(i){return String.fromCharCode(i.charCodeAt(0)+32)})}function le(e){for(var i=Object.create(null),o=e.split(`\r
`),n=0;n<o.length;n+=1){var c=o[n],d=c.split(": "),u=d.shift(),R=d.join(": ");i[ce(u)]=R}this._map=i}le.prototype.get=function(e){return this._map[ce(e)]},h!=null&&h.HEADERS_RECEIVED==null&&(h.HEADERS_RECEIVED=2);function H(){}H.prototype.open=function(e,i,o,n,c,d,u){e.open("GET",c);var R=0;e.onprogress=function(){var p=e.responseText,y=p.slice(R);R+=y.length,o(y)},e.onerror=function(p){p.preventDefault(),n(new Error("NetworkError"))},e.onload=function(){n(null)},e.onabort=function(){n(null)},e.onreadystatechange=function(){if(e.readyState===h.HEADERS_RECEIVED){var p=e.status,y=e.statusText,l=e.getResponseHeader("Content-Type"),S=e.getAllResponseHeaders();i(p,y,l,new le(S))}},e.withCredentials=d;for(var v in u)Object.prototype.hasOwnProperty.call(u,v)&&e.setRequestHeader(v,u[v]);return e.send(),e};function be(e){this._headers=e}be.prototype.get=function(e){return this._headers.get(e)};function ye(){}ye.prototype.open=function(e,i,o,n,c,d,u){var R=null,v=new O,p=v.signal,y=new de;return N(c,{headers:u,credentials:d?"include":"same-origin",signal:p,cache:"no-store"}).then(function(l){return R=l.body.getReader(),i(l.status,l.statusText,l.headers.get("Content-Type"),new be(l.headers)),new j(function(S,ne){var Ce=function(){R.read().then(function(U){if(U.done)S(void 0);else{var L=y.decode(U.value,{stream:!0});o(L),Ce()}}).catch(function(U){ne(U)})};Ce()})}).catch(function(l){if(l.name!=="AbortError")return l}).then(function(l){n(l)}),{abort:function(){R!=null&&R.cancel(),v.abort()}}};function F(){this._listeners=Object.create(null)}function Re(e){s(function(){throw e},0)}F.prototype.dispatchEvent=function(e){e.target=this;var i=this._listeners[e.type];if(i!=null)for(var o=i.length,n=0;n<o;n+=1){var c=i[n];try{typeof c.handleEvent=="function"?c.handleEvent(e):c.call(this,e)}catch(d){Re(d)}}},F.prototype.addEventListener=function(e,i){e=String(e);var o=this._listeners,n=o[e];n==null&&(n=[],o[e]=n);for(var c=!1,d=0;d<n.length;d+=1)n[d]===i&&(c=!0);c||n.push(i)},F.prototype.removeEventListener=function(e,i){e=String(e);var o=this._listeners,n=o[e];if(n!=null){for(var c=[],d=0;d<n.length;d+=1)n[d]!==i&&c.push(n[d]);c.length===0?delete o[e]:o[e]=c}};function Z(e){this.type=e,this.target=void 0}function ue(e,i){Z.call(this,e),this.data=i.data,this.lastEventId=i.lastEventId}ue.prototype=Object.create(Z.prototype);function Se(e,i){Z.call(this,e),this.status=i.status,this.statusText=i.statusText,this.headers=i.headers}Se.prototype=Object.create(Z.prototype);function ve(e,i){Z.call(this,e),this.error=i.error}ve.prototype=Object.create(Z.prototype);var Te=-1,z=0,ee=1,te=2,a=-1,r=0,f=1,T=2,K=3,P=/^text\/event\-stream(;.*)?$/i,G=1e3,q=18e6,he=function(e,i){var o=e==null?i:parseInt(e,10);return o!==o&&(o=i),He(o)},He=function(e){return Math.min(Math.max(e,G),q)},pe=function(e,i,o){try{typeof i=="function"&&i.call(e,o)}catch(n){Re(n)}};function J(e,i){F.call(this),i=i||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,ze(this,e,i)}function Ye(){return h!=null&&"withCredentials"in h.prototype||V==null?new h:new V}var We=N!=null&&oe!=null&&"body"in oe.prototype;function ze(e,i,o){i=String(i);var n=Boolean(o.withCredentials),c=o.lastEventIdQueryParameterName||"lastEventId",d=He(1e3),u=he(o.heartbeatTimeout,45e3),R="",v=d,p=!1,y=0,l=o.headers||{},S=o.Transport,ne=We&&S==null?void 0:new Q(S!=null?new S:Ye()),Ce=S!=null&&typeof S!="string"?new S:ne==null?new ye:new H,U=void 0,L=0,X=Te,Ee="",Oe="",re="",Ae="",M=r,Le=0,fe=0,Qe=function(b,C,B,$){if(X===z)if(b===200&&B!=null&&P.test(B)){X=ee,p=Date.now(),v=d,e.readyState=ee;var k=new Se("open",{status:b,statusText:C,headers:$});e.dispatchEvent(k),pe(e,e.onopen,k)}else{var A="";b!==200?(C&&(C=C.replace(/\s+/g," ")),A="EventSource's response has a status "+b+" "+C+" that is not 200. Aborting the connection."):A="EventSource's response has a Content-Type specifying an unsupported type: "+(B==null?"-":B.replace(/\s+/g," "))+". Aborting the connection.",Me();var k=new Se("error",{status:b,statusText:C,headers:$});e.dispatchEvent(k),pe(e,e.onerror,k),console.error(A)}},Ze=function(b){if(X===ee){for(var C=-1,B=0;B<b.length;B+=1){var $=b.charCodeAt(B);($===`
`.charCodeAt(0)||$==="\r".charCodeAt(0))&&(C=B)}var k=(C!==-1?Ae:"")+b.slice(0,C+1);Ae=(C===-1?Ae:"")+b.slice(C+1),b!==""&&(p=Date.now(),y+=b.length);for(var A=0;A<k.length;A+=1){var $=k.charCodeAt(A);if(M===a&&$===`
`.charCodeAt(0))M=r;else if(M===a&&(M=r),$==="\r".charCodeAt(0)||$===`
`.charCodeAt(0)){if(M!==r){M===f&&(fe=A+1);var ie=k.slice(Le,fe-1),ae=k.slice(fe+(fe<A&&k.charCodeAt(fe)===" ".charCodeAt(0)?1:0),A);ie==="data"?(Ee+=`
`,Ee+=ae):ie==="id"?Oe=ae:ie==="event"?re=ae:ie==="retry"?(d=he(ae,d),v=d):ie==="heartbeatTimeout"&&(u=he(ae,u),L!==0&&(g(L),L=s(function(){we()},u)))}if(M===r){if(Ee!==""){R=Oe,re===""&&(re="message");var ge=new ue(re,{data:Ee.slice(1),lastEventId:Oe});if(e.dispatchEvent(ge),re==="open"?pe(e,e.onopen,ge):re==="message"?pe(e,e.onmessage,ge):re==="error"&&pe(e,e.onerror,ge),X===te)return}Ee="",re=""}M=$==="\r".charCodeAt(0)?a:r}else M===r&&(Le=A,M=f),M===f?$===":".charCodeAt(0)&&(fe=A+1,M=T):M===T&&(M=K)}}},Ue=function(b){if(X===ee||X===z)X=Te,L!==0&&(g(L),L=0),L=s(function(){we()},v),v=He(Math.min(d*16,v*2)),e.readyState=z;else if(X===te&&b!=null){console.error(b);var C=new ve("error",{error:b});e.dispatchEvent(C),pe(e,e.onerror,C)}},Me=function(){X=te,U!=null&&(U.abort(),U=void 0),L!==0&&(g(L),L=0),e.readyState=te},we=function(){if(L=0,X!==Te){if(!p&&U!=null)Ue(new Error("No activity within "+u+" milliseconds. "+(X===z?"No response received.":y+" chars received.")+" Reconnecting.")),U!=null&&(U.abort(),U=void 0);else{var b=Math.max((p||Date.now())+u-Date.now(),1);p=!1,L=s(function(){we()},b)}return}p=!1,y=0,L=s(function(){we()},u),X=z,Ee="",re="",Oe=R,Ae="",Le=0,fe=0,M=r;var C=i;if(i.slice(0,5)!=="data:"&&i.slice(0,5)!=="blob:"&&R!==""){var B=i.indexOf("?");C=B===-1?i:i.slice(0,B+1)+i.slice(B+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(ae,ge){return ge===c?"":ae}),C+=(i.indexOf("?")===-1?"?":"&")+c+"="+encodeURIComponent(R)}var $=e.withCredentials,k={};k.Accept="text/event-stream";var A=e.headers;if(A!=null)for(var ie in A)Object.prototype.hasOwnProperty.call(A,ie)&&(k[ie]=A[ie]);try{U=Ce.open(ne,Qe,Ze,Ue,C,$,k)}catch(ae){throw Me(),ae}};e.url=i,e.readyState=z,e.withCredentials=n,e.headers=l,e._close=Me,we()}J.prototype=Object.create(F.prototype),J.prototype.CONNECTING=z,J.prototype.OPEN=ee,J.prototype.CLOSED=te,J.prototype.close=function(){this._close()},J.CONNECTING=z,J.OPEN=ee,J.CLOSED=te,J.prototype.withCredentials=void 0;var Ge=_;h!=null&&(_==null||!("withCredentials"in _.prototype))&&(Ge=J),function(e){if(typeof Ie=="object"&&typeof Ie.exports=="object"){var i=e(Ve);i!==void 0&&(Ie.exports=i)}else typeof define=="function"&&define.amd?define(["exports"],e):e(t)}(function(e){e.EventSourcePolyfill=J,e.NativeEventSource=_,e.EventSource=Ge})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Ve:globalThis)});var Je=dt(Be());import ft from"jwt-decode";import ct from"mitt";var E;(function(t){t.READY="ready",t.CONNECTED="connected",t.DISCONNECTED="disconnected",t.FLAGS_LOADED="flags loaded",t.CHANGED="changed",t.ERROR="error",t.ERROR_METRICS="metrics error",t.ERROR_AUTH="auth error",t.ERROR_FETCH_FLAGS="fetch flags error",t.ERROR_FETCH_FLAG="fetch flag error",t.ERROR_STREAM="stream error"})(E||(E={}));var Fe=6e4,$e={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:Fe,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[],cache:!1},se=(t,...s)=>console.error(`[FF-SDK] ${t}`,...s);function Ke(t){return"HARNESS_FF_CACHE_"+t}function De(t){let s=window.localStorage.getItem(Ke(t));if(s)try{return JSON.parse(s)}catch(g){}return[]}function Ne(t,s){window.localStorage.setItem(Ke(t),JSON.stringify(s))}function Xe(t,s){let g=De(t),h=g.find(({flag:V})=>V===s.flag);h?Object.assign(h,s):g.push(s),Ne(t,g)}function qe(t,s){let g=De(t),h=g.findIndex(({flag:V})=>V===s);h>-1&&(g.splice(h,1),Ne(t,g))}var lt="1.9.0",ut=500,xe=globalThis.fetch,vt=Je.EventSourcePolyfill,je=!!globalThis.Proxy,Pe=t=>{let{value:s}=t;try{switch(t.kind.toLowerCase()){case"int":case"number":s=Number(s);break;case"boolean":s=s.toString().toLowerCase()==="true";break;case"json":s=JSON.parse(s);break}}catch(g){se(g)}return s},ht=(t,s,g)=>{let h=!1,V,W,_,D,j,N=!0,oe={},de=()=>{N=!1},me=()=>{N=!0},O=[],m=ct(),I=Y(Y({},$e),g);I.eventsSyncInterval<Fe&&(I.eventsSyncInterval=Fe);let w=(a,...r)=>{I.debug&&console.debug(`[FF-SDK] ${a}`,...r)},x=a=>{if(N){let r=Date.now();r-a.lastAccessed>ut&&(a.count++,a.lastAccessed=r)}};globalThis.onbeforeunload=()=>{O.length&&globalThis.localStorage&&(de(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(O),me())};let Q=(a,r)=>_e(void 0,null,function*(){return(yield(yield xe(`${r.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:a,target:Y(Y({},s),{identifier:String(s.identifier)})})})).json()).authToken}),ce=0,le=()=>{if(O.length){w("Sending metrics...",{metrics:O,evaluations:H});let a={metricsData:O.map(r=>({timestamp:Date.now(),count:r.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:r.featureIdentifier},{key:"featureName",value:r.featureIdentifier},{key:"variationIdentifier",value:r.variationIdentifier},{key:"target",value:s.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:lt}]}))};xe(`${I.eventUrl}/metrics/${V}?cluster=${W}`,{method:"POST",headers:Y({"Content-Type":"application/json"},oe),body:JSON.stringify(a)}).then(()=>{O=[],ce=0}).catch(r=>{ce++&&(O=[],ce=0),w(r),m.emit(E.ERROR_METRICS,r)}).finally(()=>{j=window.setTimeout(le,I.eventsSyncInterval)})}else j=window.setTimeout(le,I.eventsSyncInterval)},H={},be=a=>{w("Sending event for",a.flag),je?m.emit(E.CHANGED,new Proxy(a,{get(r,f){var T;if(r.hasOwnProperty(f)&&f==="value"){let K=r.flag,P=a.value,G=O.find(q=>q.featureIdentifier===K&&q.featureValue===P);G?(x(G),G.variationIdentifier=((T=H[K])==null?void 0:T.identifier)||""):O.push({featureIdentifier:K,featureValue:String(P),variationIdentifier:H[K].identifier||"",count:N?1:0,lastAccessed:Date.now()}),w("Metrics event: Flag",f,"has been read with value via stream update",P)}return f==="value"?Pe(a):a[f]}})):m.emit(E.CHANGED,{deleted:a.deleted,flag:a.flag,value:Pe(a)})},ye=function(){return je?new Proxy({},{get(a,r){var T,K,P;let f=a[r];if(a.hasOwnProperty(r)){let G=a[r],q=O.find(he=>he.featureIdentifier===r&&G===he.featureValue);q?(q.variationIdentifier=((T=H[r])==null?void 0:T.identifier)||"",x(q)):O.push({featureIdentifier:r,featureValue:G,variationIdentifier:((K=H[r])==null?void 0:K.identifier)||"",count:N?1:0,lastAccessed:Date.now()}),w("Metrics event: Flag:",r,"has been read with value:",G,"variationIdentifier:",(P=H[r])==null?void 0:P.identifier)}return f}}):{}},F=ye();Q(t,I).then(a=>{if(h)return;D=a;let r=ft(a);if(oe={Authorization:`Bearer ${D}`,"Harness-AccountID":r.accountID,"Harness-EnvironmentID":r.environmentIdentifier},w("Authenticated",r),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,w("Picking up metrics from previous session")}catch(T){}j=window.setTimeout(le,I.eventsSyncInterval),V=r.environment,W=r.clusterIdentifier;let f=!!Object.keys(H).length;Re().then(()=>{w("Fetch all flags ok",F)}).then(()=>{h||Se()}).then(()=>{h||(w("Event stream ready",{storage:F}),f||m.emit(E.READY,Y({},F)))}).catch(T=>{m.emit(E.ERROR,T)})}).catch(a=>{se("Authentication error: ",a),m.emit(E.ERROR_AUTH,a),m.emit(E.ERROR,a)});let Re=()=>_e(void 0,null,function*(){try{let a=yield xe(`${I.baseUrl}/client/env/${V}/target/${s.identifier}/evaluations?cluster=${W}`,{headers:oe});if(a.ok){let r=yield a.json();r.forEach(ue),m.emit(E.FLAGS_LOADED,r)}else se("Features fetch operation error: ",a),m.emit(E.ERROR_FETCH_FLAGS,a),m.emit(E.ERROR,a)}catch(a){return se("Features fetch operation error: ",a),m.emit(E.ERROR_FETCH_FLAGS,a),m.emit(E.ERROR,a),a}}),Z=a=>_e(void 0,null,function*(){try{let r=yield xe(`${I.baseUrl}/client/env/${V}/target/${s.identifier}/evaluations/${a}?cluster=${W}`,{headers:oe});if(r.ok){let f=yield r.json();ue(f)}else se("Feature fetch operation error: ",r),m.emit(E.ERROR_FETCH_FLAG,r),m.emit(E.ERROR,r)}catch(r){se("Feature fetch operation error: ",r),m.emit(E.ERROR_FETCH_FLAG,r),m.emit(E.ERROR,r)}}),ue=a=>{de();let r=Pe(a);r!==F[a.flag]&&(w("Flag variation has changed for ",a.identifier),F[a.flag]=r,H[a.flag]=Y(Y({},a),{value:r}),be(a)),me()},Se=()=>{if(!I.streamEnabled){w("Stream is disabled by configuration. Note: Polling is not yet supported");return}_=new vt(`${I.baseUrl}/stream?cluster=${W}`,{headers:Y({"API-Key":t},oe)}),_.onopen=f=>{w("Stream connected",f),m.emit(E.CONNECTED)},_.onclose=()=>{w("Stream disconnected"),m.emit(E.DISCONNECTED)},_.onerror=f=>{se("Stream has issue",f),m.emit(E.ERROR_STREAM,f),m.emit(E.ERROR,f)};let a=f=>{switch(f.event){case"create":setTimeout(()=>Z(f.identifier),1e3);break;case"patch":Z(f.identifier);break;case"delete":delete F[f.identifier],m.emit(E.CHANGED,{flag:f.identifier,value:void 0,deleted:!0}),w("Evaluation deleted",{message:f,storage:F});break}},r=f=>{f.event==="patch"&&Re()};_.addEventListener("*",f=>{let T=JSON.parse(f.data);w("Received event from stream: ",T),T.domain==="flag"?a(T):T.domain==="target-segment"&&r(T)})},ve=(a,r)=>m.on(a,r),Te=(a,r)=>{a?m.off(a,r):ee()},z=(a,r)=>{var T;let f=F[a];if(!je&&f!==void 0){let K=f,P=a,G=O.find(q=>q.featureIdentifier===P&&q.featureValue===K);G?(x(G),G.variationIdentifier=((T=H[P])==null?void 0:T.identifier)||""):O.push({featureIdentifier:P,featureValue:K,count:N?1:0,variationIdentifier:H[P].identifier||"",lastAccessed:Date.now()})}return f!==void 0?f:r},ee=()=>{h=!0,w("Closing event stream"),F=ye(),H={},clearTimeout(j),m.all.clear(),typeof(_==null?void 0:_.close)=="function"&&_.close()},te=a=>{if(a.length){let r=!!Object.keys(H).length;a.forEach(ue),r||setTimeout(()=>{m.emit(E.READY,Y({},F))},10)}};if(I.cache&&"localStorage"in window){let a=!0,r=De(s.identifier);r&&te(r),ve(E.FLAGS_LOADED,f=>{Ne(s.identifier,f),a=!1}),ve(E.CHANGED,f=>{a||(f.deleted?qe(s.identifier,f.flag):Xe(s.identifier,f))})}return{on:ve,off:Te,variation:z,close:ee,setEvaluations:te}};export{E as Event,ht as initialize};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
