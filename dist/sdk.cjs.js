var Qe=Object.create,Se=Object.defineProperty,Ze=Object.getPrototypeOf,et=Object.prototype.hasOwnProperty,tt=Object.getOwnPropertyNames,nt=Object.getOwnPropertyDescriptor;var re=Object.assign,Le=a=>Se(a,"__esModule",{value:!0});var rt=(a,c)=>()=>(c||(c={exports:{}},a(c.exports,c)),c.exports),at=(a,c)=>{for(var E in c)Se(a,E,{get:c[E],enumerable:!0})},it=(a,c,E)=>{if(c&&typeof c=="object"||typeof c=="function")for(let p of tt(c))!et.call(a,p)&&p!=="default"&&Se(a,p,{get:()=>c[p],enumerable:!(E=nt(c,p))||E.enumerable});return a},Ie=a=>it(Le(Se(a!=null?Qe(Ze(a)):{},"default",a&&a.__esModule&&"default"in a?{get:()=>a.default,enumerable:!0}:{value:a,enumerable:!0})),a);var be=(a,c,E)=>new Promise((p,U)=>{var $=I=>{try{T(E.next(I))}catch(K){U(K)}},B=I=>{try{T(E.throw(I))}catch(K){U(K)}},T=I=>I.done?p(I.value):Promise.resolve(I.value).then($,B);T((E=E.apply(a,c)).next())});var ke=rt((Fe,Te)=>{(function(a){"use strict";var c=a.setTimeout,E=a.clearTimeout,p=a.XMLHttpRequest,U=a.XDomainRequest,$=a.ActiveXObject,B=a.EventSource,T=a.document,I=a.Promise,K=a.fetch,fe=a.Response,M=a.TextDecoder,w=a.TextEncoder,G=a.AbortController;if(typeof window!="undefined"&&typeof T!="undefined"&&!("readyState"in T)&&T.body==null&&(T.readyState="loading",window.addEventListener("load",function(e){T.readyState="complete"},!1)),p==null&&$!=null&&(p=function(){return new $("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function n(){}return n.prototype=e,new n}),Date.now||(Date.now=function(){return new Date().getTime()}),G==null){var C=K;K=function(e,n){var r=n.signal;return C(e,{headers:n.headers,credentials:n.credentials,cache:n.cache}).then(function(t){var d=t.body.getReader();return r._reader=d,r._aborted&&r._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return d}}}})},G=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function pe(){this.bitsNeeded=0,this.codePoint=0}pe.prototype.decode=function(e){function n(v,h,f){if(f===1)return v>=128>>h&&v<<h<=2047;if(f===2)return v>=2048>>h&&v<<h<=55295||v>=57344>>h&&v<<h<=65535;if(f===3)return v>=65536>>h&&v<<h<=1114111;throw new Error}function r(v,h){if(v===6*1)return h>>6>15?3:h>31?2:1;if(v===6*2)return h>15?3:2;if(v===6*3)return 3;throw new Error}for(var t=65533,d="",i=this.bitsNeeded,u=this.codePoint,g=0;g<e.length;g+=1){var l=e[g];i!==0&&(l<128||l>191||!n(u<<6|l&63,i-6,r(i,u)))&&(i=0,u=t,d+=String.fromCharCode(u)),i===0?(l>=0&&l<=127?(i=0,u=l):l>=192&&l<=223?(i=6*1,u=l&31):l>=224&&l<=239?(i=6*2,u=l&15):l>=240&&l<=247?(i=6*3,u=l&7):(i=0,u=t),i!==0&&!n(u,i,r(i,u))&&(i=0,u=t)):(i-=6,u=u<<6|l&63),i===0&&(u<=65535?d+=String.fromCharCode(u):(d+=String.fromCharCode(55296+(u-65535-1>>10)),d+=String.fromCharCode(56320+(u-65535-1&1023))))}return this.bitsNeeded=i,this.codePoint=u,d};var Ce=function(){try{return new M().decode(new w().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(M==null||w==null||!Ce())&&(M=pe);var O=function(){};function F(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=O,this.onload=O,this.onerror=O,this.onreadystatechange=O,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=O}F.prototype.open=function(e,n){this._abort(!0);var r=this,t=this._xhr,d=1,i=0;this._abort=function(f){r._sendTimeout!==0&&(E(r._sendTimeout),r._sendTimeout=0),(d===1||d===2||d===3)&&(d=4,t.onload=O,t.onerror=O,t.onabort=O,t.onprogress=O,t.onreadystatechange=O,t.abort(),i!==0&&(E(i),i=0),f||(r.readyState=4,r.onabort(null),r.onreadystatechange())),d=0};var u=function(){if(d===1){var f=0,y="",W=void 0;if("contentType"in t)f=200,y="OK",W=t.contentType;else try{f=t.status,y=t.statusText,W=t.getResponseHeader("Content-Type")}catch(le){f=0,y="",W=void 0}f!==0&&(d=2,r.readyState=2,r.status=f,r.statusText=y,r._contentType=W,r.onreadystatechange())}},g=function(){if(u(),d===2||d===3){d=3;var f="";try{f=t.responseText}catch(y){}r.readyState=3,r.responseText=f,r.onprogress()}},l=function(f,y){if((y==null||y.preventDefault==null)&&(y={preventDefault:O}),g(),d===1||d===2||d===3){if(d=4,i!==0&&(E(i),i=0),r.readyState=4,f==="load")r.onload(y);else if(f==="error")r.onerror(y);else if(f==="abort")r.onabort(y);else throw new TypeError;r.onreadystatechange()}},v=function(f){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&l(t.responseText===""?"error":"load",f):t.readyState===3?"onprogress"in t||g():t.readyState===2&&u())},h=function(){i=c(function(){h()},500),t.readyState===3&&g()};"onload"in t&&(t.onload=function(f){l("load",f)}),"onerror"in t&&(t.onerror=function(f){l("error",f)}),"onabort"in t&&(t.onabort=function(f){l("abort",f)}),"onprogress"in t&&(t.onprogress=g),"onreadystatechange"in t&&(t.onreadystatechange=function(f){v(f)}),("contentType"in t||!("ontimeout"in p.prototype))&&(n+=(n.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,n,!0),"readyState"in t&&(i=c(function(){h()},0))},F.prototype.abort=function(){this._abort(!1)},F.prototype.getResponseHeader=function(e){return this._contentType},F.prototype.setRequestHeader=function(e,n){var r=this._xhr;"setRequestHeader"in r&&r.setRequestHeader(e,n)},F.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},F.prototype.send=function(){if((!("ontimeout"in p.prototype)||!("sendAsBinary"in p.prototype)&&!("mozAnon"in p.prototype))&&T!=null&&T.readyState!=null&&T.readyState!=="complete"){var e=this;e._sendTimeout=c(function(){e._sendTimeout=0,e.send()},4);return}var n=this._xhr;"withCredentials"in n&&(n.withCredentials=this.withCredentials);try{n.send(void 0)}catch(r){throw r}};function H(e){return e.replace(/[A-Z]/g,function(n){return String.fromCharCode(n.charCodeAt(0)+32)})}function ce(e){for(var n=Object.create(null),r=e.split(`\r
`),t=0;t<r.length;t+=1){var d=r[t],i=d.split(": "),u=i.shift(),g=i.join(": ");n[H(u)]=g}this._map=n}ce.prototype.get=function(e){return this._map[H(e)]},p!=null&&p.HEADERS_RECEIVED==null&&(p.HEADERS_RECEIVED=2);function ue(){}ue.prototype.open=function(e,n,r,t,d,i,u){e.open("GET",d);var g=0;e.onprogress=function(){var v=e.responseText,h=v.slice(g);g+=h.length,r(h)},e.onerror=function(v){v.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===p.HEADERS_RECEIVED){var v=e.status,h=e.statusText,f=e.getResponseHeader("Content-Type"),y=e.getAllResponseHeaders();n(v,h,f,new ce(y))}},e.withCredentials=i;for(var l in u)Object.prototype.hasOwnProperty.call(u,l)&&e.setRequestHeader(l,u[l]);return e.send(),e};function he(e){this._headers=e}he.prototype.get=function(e){return this._headers.get(e)};function ge(){}ge.prototype.open=function(e,n,r,t,d,i,u){var g=null,l=new G,v=l.signal,h=new M;return K(d,{headers:u,credentials:i?"include":"same-origin",signal:v,cache:"no-store"}).then(function(f){return g=f.body.getReader(),n(f.status,f.statusText,f.headers.get("Content-Type"),new he(f.headers)),new I(function(y,W){var le=function(){g.read().then(function(k){if(k.done)y(void 0);else{var A=h.decode(k.value,{stream:!0});r(A),le()}}).catch(function(k){W(k)})};le()})}).catch(function(f){if(f.name!=="AbortError")return f}).then(function(f){t(f)}),{abort:function(){g!=null&&g.cancel(),l.abort()}}};function te(){this._listeners=Object.create(null)}function ye(e){c(function(){throw e},0)}te.prototype.dispatchEvent=function(e){e.target=this;var n=this._listeners[e.type];if(n!=null)for(var r=n.length,t=0;t<r;t+=1){var d=n[t];try{typeof d.handleEvent=="function"?d.handleEvent(e):d.call(this,e)}catch(i){ye(i)}}},te.prototype.addEventListener=function(e,n){e=String(e);var r=this._listeners,t=r[e];t==null&&(t=[],r[e]=t);for(var d=!1,i=0;i<t.length;i+=1)t[i]===n&&(d=!0);d||t.push(n)},te.prototype.removeEventListener=function(e,n){e=String(e);var r=this._listeners,t=r[e];if(t!=null){for(var d=[],i=0;i<t.length;i+=1)t[i]!==n&&d.push(t[i]);d.length===0?delete r[e]:r[e]=d}};function z(e){this.type=e,this.target=void 0}function o(e,n){z.call(this,e),this.data=n.data,this.lastEventId=n.lastEventId}o.prototype=Object.create(z.prototype);function s(e,n){z.call(this,e),this.status=n.status,this.statusText=n.statusText,this.headers=n.headers}s.prototype=Object.create(z.prototype);function m(e,n){z.call(this,e),this.error=n.error}m.prototype=Object.create(z.prototype);var x=-1,L=0,X=1,J=2,ae=-1,ee=0,Oe=1,xe=2,$e=3,Ke=/^text\/event\-stream(;.*)?$/i,Ge=1e3,Xe=18e6,Ae=function(e,n){var r=e==null?n:parseInt(e,10);return r!==r&&(r=n),De(r)},De=function(e){return Math.min(Math.max(e,Ge),Xe)},ie=function(e,n,r){try{typeof n=="function"&&n.call(e,r)}catch(t){ye(t)}};function q(e,n){te.call(this),n=n||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,ze(this,e,n)}function qe(){return p!=null&&"withCredentials"in p.prototype||U==null?new p:new U}var Je=K!=null&&fe!=null&&"body"in fe.prototype;function ze(e,n,r){n=String(n);var t=Boolean(r.withCredentials),d=r.lastEventIdQueryParameterName||"lastEventId",i=De(1e3),u=Ae(r.heartbeatTimeout,45e3),g="",l=i,v=!1,h=0,f=r.headers||{},y=r.Transport,W=Je&&y==null?void 0:new F(y!=null?new y:qe()),le=y!=null&&typeof y!="string"?new y:W==null?new ge:new ue,k=void 0,A=0,P=x,oe="",Ee="",Y="",me="",D=ee,Ne=0,ne=0,We=function(b,S,j,V){if(P===L)if(b===200&&j!=null&&Ke.test(j)){P=X,v=Date.now(),l=i,e.readyState=X;var N=new s("open",{status:b,statusText:S,headers:V});e.dispatchEvent(N),ie(e,e.onopen,N)}else{var R="";b!==200?(S&&(S=S.replace(/\s+/g," ")),R="EventSource's response has a status "+b+" "+S+" that is not 200. Aborting the connection."):R="EventSource's response has a Content-Type specifying an unsupported type: "+(j==null?"-":j.replace(/\s+/g," "))+". Aborting the connection.",_e();var N=new s("error",{status:b,statusText:S,headers:V});e.dispatchEvent(N),ie(e,e.onerror,N),console.error(R)}},Ye=function(b){if(P===X){for(var S=-1,j=0;j<b.length;j+=1){var V=b.charCodeAt(j);(V===`
`.charCodeAt(0)||V==="\r".charCodeAt(0))&&(S=j)}var N=(S!==-1?me:"")+b.slice(0,S+1);me=(S===-1?me:"")+b.slice(S+1),b!==""&&(v=Date.now(),h+=b.length);for(var R=0;R<N.length;R+=1){var V=N.charCodeAt(R);if(D===ae&&V===`
`.charCodeAt(0))D=ee;else if(D===ae&&(D=ee),V==="\r".charCodeAt(0)||V===`
`.charCodeAt(0)){if(D!==ee){D===Oe&&(ne=R+1);var Q=N.slice(Ne,ne-1),Z=N.slice(ne+(ne<R&&N.charCodeAt(ne)===" ".charCodeAt(0)?1:0),R);Q==="data"?(oe+=`
`,oe+=Z):Q==="id"?Ee=Z:Q==="event"?Y=Z:Q==="retry"?(i=Ae(Z,i),l=i):Q==="heartbeatTimeout"&&(u=Ae(Z,u),A!==0&&(E(A),A=c(function(){ve()},u)))}if(D===ee){if(oe!==""){g=Ee,Y===""&&(Y="message");var se=new o(Y,{data:oe.slice(1),lastEventId:Ee});if(e.dispatchEvent(se),Y==="open"?ie(e,e.onopen,se):Y==="message"?ie(e,e.onmessage,se):Y==="error"&&ie(e,e.onerror,se),P===J)return}oe="",Y=""}D=V==="\r".charCodeAt(0)?ae:ee}else D===ee&&(Ne=R,D=Oe),D===Oe?V===":".charCodeAt(0)&&(ne=R+1,D=xe):D===xe&&(D=$e)}}},He=function(b){if(P===X||P===L)P=x,A!==0&&(E(A),A=0),A=c(function(){ve()},l),l=De(Math.min(i*16,l*2)),e.readyState=L;else if(P===J&&b!=null){console.error(b);var S=new m("error",{error:b});e.dispatchEvent(S),ie(e,e.onerror,S)}},_e=function(){P=J,k!=null&&(k.abort(),k=void 0),A!==0&&(E(A),A=0),e.readyState=J},ve=function(){if(A=0,P!==x){if(!v&&k!=null)He(new Error("No activity within "+u+" milliseconds. "+(P===L?"No response received.":h+" chars received.")+" Reconnecting.")),k!=null&&(k.abort(),k=void 0);else{var b=Math.max((v||Date.now())+u-Date.now(),1);v=!1,A=c(function(){ve()},b)}return}v=!1,h=0,A=c(function(){ve()},u),P=L,oe="",Y="",Ee=g,me="",Ne=0,ne=0,D=ee;var S=n;if(n.slice(0,5)!=="data:"&&n.slice(0,5)!=="blob:"&&g!==""){var j=n.indexOf("?");S=j===-1?n:n.slice(0,j+1)+n.slice(j+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(Z,se){return se===d?"":Z}),S+=(n.indexOf("?")===-1?"?":"&")+d+"="+encodeURIComponent(g)}var V=e.withCredentials,N={};N.Accept="text/event-stream";var R=e.headers;if(R!=null)for(var Q in R)Object.prototype.hasOwnProperty.call(R,Q)&&(N[Q]=R[Q]);try{k=le.open(W,We,Ye,He,S,V,N)}catch(Z){throw _e(),Z}};e.url=n,e.readyState=L,e.withCredentials=t,e.headers=f,e._close=_e,ve()}q.prototype=Object.create(te.prototype),q.prototype.CONNECTING=L,q.prototype.OPEN=X,q.prototype.CLOSED=J,q.prototype.close=function(){this._close()},q.CONNECTING=L,q.OPEN=X,q.CLOSED=J,q.prototype.withCredentials=void 0;var Me=B;p!=null&&(B==null||!("withCredentials"in B.prototype))&&(Me=q),function(e){if(typeof Te=="object"&&typeof Te.exports=="object"){var n=e(Fe);n!==void 0&&(Te.exports=n)}else typeof define=="function"&&define.amd?define(["exports"],e):e(a)}(function(e){e.EventSourcePolyfill=q,e.NativeEventSource=B,e.EventSource=Me})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Fe:globalThis)});Le(exports);at(exports,{Event:()=>_,initialize:()=>ft});var Ve=Ie(require("jwt-decode")),Be=Ie(require("mitt")),Pe=Ie(ke());var _;(function(a){a.READY="ready",a.CONNECTED="connected",a.DISCONNECTED="disconnected",a.CHANGED="changed",a.ERROR="error"})(_||(_={}));var je={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},de=(a,...c)=>console.error(`[FF-SDK] ${a}`,...c),we=30*1e3;var ot="1.5.0",st=500,Re=globalThis.fetch,dt=Pe.EventSourcePolyfill,Ue=a=>{let{value:c}=a;try{switch(a.kind.toLowerCase()){case"int":case"number":c=Number(c);break;case"boolean":c=c.toString().toLowerCase()==="true";break;case"json":c=JSON.parse(c);break}}catch(E){de(E)}return c},ft=(a,c,E)=>{let p,U,$,B,T,I=!0,K=()=>{I=!1},fe=()=>{I=!0},M=[],w=(0,Be.default)(),G=re(re({},je),E),C=(o,...s)=>{G.debug&&console.debug(`[FF-SDK] ${o}`,...s)},pe=o=>{if(I){let s=Date.now();s-o.lastAccessed>st&&(o.count++,o.lastAccessed=s)}};globalThis.onbeforeunload=()=>{M.length&&globalThis.localStorage&&(K(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(M),fe())};let Ce=(o,s)=>be(void 0,null,function*(){return(yield(yield Re(`${s.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:o,target:c})})).json()).authToken}),O=()=>{if(M.length){C("Sending metrics...",{metrics:M,evaluations:F});let o={metricsData:M.map(s=>({timestamp:Date.now(),count:s.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:s.featureIdentifier},{key:"featureName",value:s.featureIdentifier},{key:"variationIdentifier",value:s.variationIdentifier},{key:"target",value:c.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:ot}]}))};Re(`${G.eventUrl}/metrics/${p}?cluster=${U}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${B}`},body:JSON.stringify(o)}).then(()=>{M=[]}).catch(s=>{C(s)}).finally(()=>{T=window.setTimeout(O,we)})}else T=window.setTimeout(O,we)},F={},H={};Ce(a,G).then(o=>{B=o;let s=(0,Ve.default)(o);if(C("Authenticated",s),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,C("Picking up metrics from previous session")}catch(m){}T=window.setTimeout(O,we),p=s.environment,U=s.clusterIdentifier,ce().then(()=>{C("Fetch all flags ok",H)}).then(()=>{he()}).then(()=>{C("Event stream ready",{storage:H}),w.emit(_.READY,Object.keys(H))}).catch(m=>{w.emit(_.ERROR,m)})}).catch(o=>{de("Authentication error: ",o),w.emit(_.ERROR,o)});let ce=()=>be(void 0,null,function*(){try{(yield(yield Re(`${G.baseUrl}/client/env/${p}/target/${c.identifier}/evaluations?cluster=${U}`,{headers:{Authorization:`Bearer ${B}`}})).json()).forEach(m=>{let x=Ue(m),L=H[m.flag];x!==L&&(C("Flag variation has changed for ",m.identifier),H[m.flag]=x,F[m.flag]=re(re({},m),{value:x}))})}catch(o){return de("Features fetch operation error: ",o),w.emit(_.ERROR,o),o}}),ue=o=>be(void 0,null,function*(){try{let s=yield Re(`${G.baseUrl}/client/env/${p}/target/${c.identifier}/evaluations/${o}?cluster=${U}`,{headers:{Authorization:`Bearer ${B}`}});if(s.ok){let m=yield s.json(),x=Ue(m);K(),H[o]=x,F[o]=re(re({},m),{value:x}),fe(),w.emit(_.CHANGED,o)}else w.emit(_.ERROR,s)}catch(s){de("Feature fetch operation error: ",s),w.emit(_.ERROR,s)}}),he=()=>{if(!G.streamEnabled){C("Stream is disabled by configuration. Note: Polling is not yet supported");return}$=new dt(`${G.baseUrl}/stream?cluster=${U}`,{headers:{Authorization:`Bearer ${B}`,"API-Key":a}}),$.onopen=o=>{C("Stream connected",o),w.emit(_.CONNECTED)},$.onclose=o=>{C("Stream disconnected"),w.emit(_.DISCONNECTED)},$.onerror=o=>{de("Stream has issue",o),w.emit(_.ERROR,o)},$.addEventListener("*",o=>{let s=JSON.parse(o.data);switch(C("Received event from stream: ",s),s.event){case"create":setTimeout(()=>ue(s.identifier),1e3);break;case"patch":s.domain==="target-segment"?ce():ue(s.identifier);break;case"delete":delete H[s.identifier],w.emit(_.CHANGED,{flag:s.identifier,value:void 0,deleted:!0}),C("Evaluation deleted",{message:s,storage:H});break}})},ge=(o,s)=>w.on(o,s),te=(o,s)=>{o?w.off(o,s):z()},ye=(o,s)=>{var x;let m=H[o];if(m!==void 0){let L=m,X=o,J=M.find(ae=>ae.featureIdentifier===X&&ae.featureValue===L);J?(pe(J),J.variationIdentifier=((x=F[X])==null?void 0:x.identifier)||""):M.push({featureIdentifier:X,featureValue:L,count:I?1:0,variationIdentifier:F[X].identifier||"",lastAccessed:Date.now()})}return m!==void 0?m:s},z=()=>{C("Closing event stream"),H={},F={},clearTimeout(T),w.all.clear(),$.close()};return{on:ge,off:te,variation:ye,close:z}};
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
//# sourceMappingURL=sdk.cjs.js.map
