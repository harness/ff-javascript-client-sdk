var HarnessFFSDK=(()=>{var tt=Object.create,Ie=Object.defineProperty,nt=Object.getPrototypeOf,rt=Object.prototype.hasOwnProperty,it=Object.getOwnPropertyNames,at=Object.getOwnPropertyDescriptor;var Y=Object.assign,ot=n=>Ie(n,"__esModule",{value:!0});var st=(n,i)=>()=>(i||(i={exports:{}},n(i.exports,i)),i.exports),ft=(n,i)=>{for(var v in i)Ie(n,v,{get:i[v],enumerable:!0})},dt=(n,i,v)=>{if(i&&typeof i=="object"||typeof i=="function")for(let c of it(i))!rt.call(n,c)&&c!=="default"&&Ie(n,c,{get:()=>i[c],enumerable:!(v=at(i,c))||v.enumerable});return n},ct=n=>dt(ot(Ie(n!=null?tt(nt(n)):{},"default",n&&n.__esModule&&"default"in n?{get:()=>n.default,enumerable:!0}:{value:n,enumerable:!0})),n);var Ae=(n,i,v)=>new Promise((c,k)=>{var x=B=>{try{O(v.next(B))}catch(_){k(_)}},T=B=>{try{O(v.throw(B))}catch(_){k(_)}},O=B=>B.done?c(B.value):Promise.resolve(B.value).then(x,T);O((v=v.apply(n,i)).next())});var Ke=st((Le,Ne)=>{(function(n){"use strict";var i=n.setTimeout,v=n.clearTimeout,c=n.XMLHttpRequest,k=n.XDomainRequest,x=n.ActiveXObject,T=n.EventSource,O=n.document,B=n.Promise,_=n.fetch,ve=n.Response,ie=n.TextDecoder,C=n.TextEncoder,R=n.AbortController;if(typeof window!="undefined"&&typeof O!="undefined"&&!("readyState"in O)&&O.body==null&&(O.readyState="loading",window.addEventListener("load",function(e){O.readyState="complete"},!1)),c==null&&x!=null&&(c=function(){return new x("Microsoft.XMLHTTP")}),Object.create==null&&(Object.create=function(e){function r(){}return r.prototype=e,new r}),Date.now||(Date.now=function(){return new Date().getTime()}),R==null){var U=_;_=function(e,r){var a=r.signal;return U(e,{headers:r.headers,credentials:r.credentials,cache:r.cache}).then(function(t){var l=t.body.getReader();return a._reader=l,a._aborted&&a._reader.cancel(),{status:t.status,statusText:t.statusText,headers:t.headers,body:{getReader:function(){return l}}}})},R=function(){this.signal={_reader:null,_aborted:!1},this.abort=function(){this.signal._reader!=null&&this.signal._reader.cancel(),this.signal._aborted=!0}}}function I(){this.bitsNeeded=0,this.codePoint=0}I.prototype.decode=function(e){function r(E,y,u){if(u===1)return E>=128>>y&&E<<y<=2047;if(u===2)return E>=2048>>y&&E<<y<=55295||E>=57344>>y&&E<<y<=65535;if(u===3)return E>=65536>>y&&E<<y<=1114111;throw new Error}function a(E,y){if(E===6*1)return y>>6>15?3:y>31?2:1;if(E===6*2)return y>15?3:2;if(E===6*3)return 3;throw new Error}for(var t=65533,l="",f=this.bitsNeeded,h=this.codePoint,S=0;S<e.length;S+=1){var p=e[S];f!==0&&(p<128||p>191||!r(h<<6|p&63,f-6,a(f,h)))&&(f=0,h=t,l+=String.fromCharCode(h)),f===0?(p>=0&&p<=127?(f=0,h=p):p>=192&&p<=223?(f=6*1,h=p&31):p>=224&&p<=239?(f=6*2,h=p&15):p>=240&&p<=247?(f=6*3,h=p&7):(f=0,h=t),f!==0&&!r(h,f,a(f,h))&&(f=0,h=t)):(f-=6,h=h<<6|p&63),f===0&&(h<=65535?l+=String.fromCharCode(h):(l+=String.fromCharCode(55296+(h-65535-1>>10)),l+=String.fromCharCode(56320+(h-65535-1&1023))))}return this.bitsNeeded=f,this.codePoint=h,l};var oe=function(){try{return new ie().decode(new C().encode("test"),{stream:!0})==="test"}catch(e){console.debug("TextDecoder does not support streaming option. Using polyfill instead: "+e)}return!1};(ie==null||C==null||!oe())&&(ie=I);var K=function(){};function z(e){this.withCredentials=!1,this.readyState=0,this.status=0,this.statusText="",this.responseText="",this.onprogress=K,this.onload=K,this.onerror=K,this.onreadystatechange=K,this._contentType="",this._xhr=e,this._sendTimeout=0,this._abort=K}z.prototype.open=function(e,r){this._abort(!0);var a=this,t=this._xhr,l=1,f=0;this._abort=function(u){a._sendTimeout!==0&&(v(a._sendTimeout),a._sendTimeout=0),(l===1||l===2||l===3)&&(l=4,t.onload=K,t.onerror=K,t.onabort=K,t.onprogress=K,t.onreadystatechange=K,t.abort(),f!==0&&(v(f),f=0),u||(a.readyState=4,a.onabort(null),a.onreadystatechange())),l=0};var h=function(){if(l===1){var u=0,w="",Q=void 0;if("contentType"in t)u=200,w="OK",Q=t.contentType;else try{u=t.status,w=t.statusText,Q=t.getResponseHeader("Content-Type")}catch(ye){u=0,w="",Q=void 0}u!==0&&(l=2,a.readyState=2,a.status=u,a.statusText=w,a._contentType=Q,a.onreadystatechange())}},S=function(){if(h(),l===2||l===3){l=3;var u="";try{u=t.responseText}catch(w){}a.readyState=3,a.responseText=u,a.onprogress()}},p=function(u,w){if((w==null||w.preventDefault==null)&&(w={preventDefault:K}),S(),l===1||l===2||l===3){if(l=4,f!==0&&(v(f),f=0),a.readyState=4,u==="load")a.onload(w);else if(u==="error")a.onerror(w);else if(u==="abort")a.onabort(w);else throw new TypeError;a.onreadystatechange()}},E=function(u){t!=null&&(t.readyState===4?(!("onload"in t)||!("onerror"in t)||!("onabort"in t))&&p(t.responseText===""?"error":"load",u):t.readyState===3?"onprogress"in t||S():t.readyState===2&&h())},y=function(){f=i(function(){y()},500),t.readyState===3&&S()};"onload"in t&&(t.onload=function(u){p("load",u)}),"onerror"in t&&(t.onerror=function(u){p("error",u)}),"onabort"in t&&(t.onabort=function(u){p("abort",u)}),"onprogress"in t&&(t.onprogress=S),"onreadystatechange"in t&&(t.onreadystatechange=function(u){E(u)}),("contentType"in t||!("ontimeout"in c.prototype))&&(r+=(r.indexOf("?")===-1?"?":"&")+"padding=true"),t.open(e,r,!0),"readyState"in t&&(f=i(function(){y()},0))},z.prototype.abort=function(){this._abort(!1)},z.prototype.getResponseHeader=function(e){return this._contentType},z.prototype.setRequestHeader=function(e,r){var a=this._xhr;"setRequestHeader"in a&&a.setRequestHeader(e,r)},z.prototype.getAllResponseHeaders=function(){return this._xhr.getAllResponseHeaders!=null&&this._xhr.getAllResponseHeaders()||""},z.prototype.send=function(){if((!("ontimeout"in c.prototype)||!("sendAsBinary"in c.prototype)&&!("mozAnon"in c.prototype))&&O!=null&&O.readyState!=null&&O.readyState!=="complete"){var e=this;e._sendTimeout=i(function(){e._sendTimeout=0,e.send()},4);return}var r=this._xhr;"withCredentials"in r&&(r.withCredentials=this.withCredentials);try{r.send(void 0)}catch(a){throw a}};function se(e){return e.replace(/[A-Z]/g,function(r){return String.fromCharCode(r.charCodeAt(0)+32)})}function F(e){for(var r=Object.create(null),a=e.split(`\r
`),t=0;t<a.length;t+=1){var l=a[t],f=l.split(": "),h=f.shift(),S=f.join(": ");r[se(h)]=S}this._map=r}F.prototype.get=function(e){return this._map[se(e)]},c!=null&&c.HEADERS_RECEIVED==null&&(c.HEADERS_RECEIVED=2);function he(){}he.prototype.open=function(e,r,a,t,l,f,h){e.open("GET",l);var S=0;e.onprogress=function(){var E=e.responseText,y=E.slice(S);S+=y.length,a(y)},e.onerror=function(E){E.preventDefault(),t(new Error("NetworkError"))},e.onload=function(){t(null)},e.onabort=function(){t(null)},e.onreadystatechange=function(){if(e.readyState===c.HEADERS_RECEIVED){var E=e.status,y=e.statusText,u=e.getResponseHeader("Content-Type"),w=e.getAllResponseHeaders();r(E,y,u,new F(w))}},e.withCredentials=f;for(var p in h)Object.prototype.hasOwnProperty.call(h,p)&&e.setRequestHeader(p,h[p]);return e.send(),e};function pe(e){this._headers=e}pe.prototype.get=function(e){return this._headers.get(e)};function H(){}H.prototype.open=function(e,r,a,t,l,f,h){var S=null,p=new R,E=p.signal,y=new ie;return _(l,{headers:h,credentials:f?"include":"same-origin",signal:E,cache:"no-store"}).then(function(u){return S=u.body.getReader(),r(u.status,u.statusText,u.headers.get("Content-Type"),new pe(u.headers)),new B(function(w,Q){var ye=function(){S.read().then(function(G){if(G.done)w(void 0);else{var L=y.decode(G.value,{stream:!0});a(L),ye()}}).catch(function(G){Q(G)})};ye()})}).catch(function(u){if(u.name!=="AbortError")return u}).then(function(u){t(u)}),{abort:function(){S!=null&&S.cancel(),p.abort()}}};function ne(){this._listeners=Object.create(null)}function ge(e){i(function(){throw e},0)}ne.prototype.dispatchEvent=function(e){e.target=this;var r=this._listeners[e.type];if(r!=null)for(var a=r.length,t=0;t<a;t+=1){var l=r[t];try{typeof l.handleEvent=="function"?l.handleEvent(e):l.call(this,e)}catch(f){ge(f)}}},ne.prototype.addEventListener=function(e,r){e=String(e);var a=this._listeners,t=a[e];t==null&&(t=[],a[e]=t);for(var l=!1,f=0;f<t.length;f+=1)t[f]===r&&(l=!0);l||t.push(r)},ne.prototype.removeEventListener=function(e,r){e=String(e);var a=this._listeners,t=a[e];if(t!=null){for(var l=[],f=0;f<t.length;f+=1)t[f]!==r&&l.push(t[f]);l.length===0?delete a[e]:a[e]=l}};function re(e){this.type=e,this.target=void 0}function we(e,r){re.call(this,e),this.data=r.data,this.lastEventId=r.lastEventId}we.prototype=Object.create(re.prototype);function Ee(e,r){re.call(this,e),this.status=r.status,this.statusText=r.statusText,this.headers=r.headers}Ee.prototype=Object.create(re.prototype);function be(e,r){re.call(this,e),this.error=r.error}be.prototype=Object.create(re.prototype);var fe=-1,s=0,d=1,o=2,g=-1,m=0,b=1,N=2,$=3,Te=/^text\/event\-stream(;.*)?$/i,Je=1e3,ze=18e6,Fe=function(e,r){var a=e==null?r:parseInt(e,10);return a!==a&&(a=r),Me(a)},Me=function(e){return Math.min(Math.max(e,Je),ze)},de=function(e,r,a){try{typeof r=="function"&&r.call(e,a)}catch(t){ge(t)}};function W(e,r){ne.call(this),r=r||{},this.onopen=void 0,this.onmessage=void 0,this.onerror=void 0,this.url=void 0,this.readyState=void 0,this.withCredentials=void 0,this.headers=void 0,this._close=void 0,Qe(this,e,r)}function We(){return c!=null&&"withCredentials"in c.prototype||k==null?new c:new k}var Ye=_!=null&&ve!=null&&"body"in ve.prototype;function Qe(e,r,a){r=String(r);var t=Boolean(a.withCredentials),l=a.lastEventIdQueryParameterName||"lastEventId",f=Me(1e3),h=Fe(a.heartbeatTimeout,45e3),S="",p=f,E=!1,y=0,u=a.headers||{},w=a.Transport,Q=Ye&&w==null?void 0:new z(w!=null?new w:We()),ye=w!=null&&typeof w!="string"?new w:Q==null?new H:new he,G=void 0,L=0,J=fe,ce="",Ce="",Z="",Re="",P=m,Ve=0,ae=0,Ze=function(D,A,X,q){if(J===s)if(D===200&&X!=null&&Te.test(X)){J=d,E=Date.now(),p=f,e.readyState=d;var j=new Ee("open",{status:D,statusText:A,headers:q});e.dispatchEvent(j),de(e,e.onopen,j)}else{var M="";D!==200?(A&&(A=A.replace(/\s+/g," ")),M="EventSource's response has a status "+D+" "+A+" that is not 200. Aborting the connection."):M="EventSource's response has a Content-Type specifying an unsupported type: "+(X==null?"-":X.replace(/\s+/g," "))+". Aborting the connection.",ke();var j=new Ee("error",{status:D,statusText:A,headers:q});e.dispatchEvent(j),de(e,e.onerror,j),console.error(M)}},et=function(D){if(J===d){for(var A=-1,X=0;X<D.length;X+=1){var q=D.charCodeAt(X);(q===`
`.charCodeAt(0)||q==="\r".charCodeAt(0))&&(A=X)}var j=(A!==-1?Re:"")+D.slice(0,A+1);Re=(A===-1?Re:"")+D.slice(A+1),D!==""&&(E=Date.now(),y+=D.length);for(var M=0;M<j.length;M+=1){var q=j.charCodeAt(M);if(P===g&&q===`
`.charCodeAt(0))P=m;else if(P===g&&(P=m),q==="\r".charCodeAt(0)||q===`
`.charCodeAt(0)){if(P!==m){P===b&&(ae=M+1);var ee=j.slice(Ve,ae-1),te=j.slice(ae+(ae<M&&j.charCodeAt(ae)===" ".charCodeAt(0)?1:0),M);ee==="data"?(ce+=`
`,ce+=te):ee==="id"?Ce=te:ee==="event"?Z=te:ee==="retry"?(f=Fe(te,f),p=f):ee==="heartbeatTimeout"&&(h=Fe(te,h),L!==0&&(v(L),L=i(function(){me()},h)))}if(P===m){if(ce!==""){S=Ce,Z===""&&(Z="message");var le=new we(Z,{data:ce.slice(1),lastEventId:Ce});if(e.dispatchEvent(le),Z==="open"?de(e,e.onopen,le):Z==="message"?de(e,e.onmessage,le):Z==="error"&&de(e,e.onerror,le),J===o)return}ce="",Z=""}P=q==="\r".charCodeAt(0)?g:m}else P===m&&(Ve=M,P=b),P===b?q===":".charCodeAt(0)&&(ae=M+1,P=N):P===N&&(P=$)}}},je=function(D){if(J===d||J===s)J=fe,L!==0&&(v(L),L=0),L=i(function(){me()},p),p=Me(Math.min(f*16,p*2)),e.readyState=s;else if(J===o&&D!=null){console.error(D);var A=new be("error",{error:D});e.dispatchEvent(A),de(e,e.onerror,A)}},ke=function(){J=o,G!=null&&(G.abort(),G=void 0),L!==0&&(v(L),L=0),e.readyState=o},me=function(){if(L=0,J!==fe){if(!E&&G!=null)je(new Error("No activity within "+h+" milliseconds. "+(J===s?"No response received.":y+" chars received.")+" Reconnecting.")),G!=null&&(G.abort(),G=void 0);else{var D=Math.max((E||Date.now())+h-Date.now(),1);E=!1,L=i(function(){me()},D)}return}E=!1,y=0,L=i(function(){me()},h),J=s,ce="",Z="",Ce=S,Re="",Ve=0,ae=0,P=m;var A=r;if(r.slice(0,5)!=="data:"&&r.slice(0,5)!=="blob:"&&S!==""){var X=r.indexOf("?");A=X===-1?r:r.slice(0,X+1)+r.slice(X+1).replace(/(?:^|&)([^=&]*)(?:=[^&]*)?/g,function(te,le){return le===l?"":te}),A+=(r.indexOf("?")===-1?"?":"&")+l+"="+encodeURIComponent(S)}var q=e.withCredentials,j={};j.Accept="text/event-stream";var M=e.headers;if(M!=null)for(var ee in M)Object.prototype.hasOwnProperty.call(M,ee)&&(j[ee]=M[ee]);try{G=ye.open(Q,Ze,et,je,A,q,j)}catch(te){throw ke(),te}};e.url=r,e.readyState=s,e.withCredentials=t,e.headers=u,e._close=ke,me()}W.prototype=Object.create(ne.prototype),W.prototype.CONNECTING=s,W.prototype.OPEN=d,W.prototype.CLOSED=o,W.prototype.close=function(){this._close()},W.CONNECTING=s,W.OPEN=d,W.CLOSED=o,W.prototype.withCredentials=void 0;var Pe=T;c!=null&&(T==null||!("withCredentials"in T.prototype))&&(Pe=W),function(e){if(typeof Ne=="object"&&typeof Ne.exports=="object"){var r=e(Le);r!==void 0&&(Ne.exports=r)}else typeof define=="function"&&define.amd?define(["exports"],e):e(n)}(function(e){e.EventSourcePolyfill=W,e.NativeEventSource=T,e.EventSource=Pe})})(typeof globalThis=="undefined"?typeof window!="undefined"?window:typeof self!="undefined"?self:Le:globalThis)});var vt={};ft(vt,{Event:()=>V,initialize:()=>qe});function He(n){this.message=n}He.prototype=new Error,He.prototype.name="InvalidCharacterError";var Be=typeof window!="undefined"&&window.atob&&window.atob.bind(window)||function(n){var i=String(n).replace(/=+$/,"");if(i.length%4==1)throw new He("'atob' failed: The string to be decoded is not correctly encoded.");for(var v,c,k=0,x=0,T="";c=i.charAt(x++);~c&&(v=k%4?64*v+c:c,k++%4)?T+=String.fromCharCode(255&v>>(-2*k&6)):0)c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(c);return T};function lt(n){var i=n.replace(/-/g,"+").replace(/_/g,"/");switch(i.length%4){case 0:break;case 2:i+="==";break;case 3:i+="=";break;default:throw"Illegal base64url string!"}try{return function(v){return decodeURIComponent(Be(v).replace(/(.)/g,function(c,k){var x=k.charCodeAt(0).toString(16).toUpperCase();return x.length<2&&(x="0"+x),"%"+x}))}(i)}catch(v){return Be(i)}}function Oe(n){this.message=n}function ut(n,i){if(typeof n!="string")throw new Oe("Invalid token specified");var v=(i=i||{}).header===!0?0:1;try{return JSON.parse(lt(n.split(".")[v]))}catch(c){throw new Oe("Invalid token specified: "+c.message)}}Oe.prototype=new Error,Oe.prototype.name="InvalidTokenError";var Ue=ut;function $e(n){return{all:n=n||new Map,on:function(i,v){var c=n.get(i);c&&c.push(v)||n.set(i,[v])},off:function(i,v){var c=n.get(i);c&&c.splice(c.indexOf(v)>>>0,1)},emit:function(i,v){(n.get(i)||[]).slice().map(function(c){c(v)}),(n.get("*")||[]).slice().map(function(c){c(i,v)})}}}var Xe=ct(Ke());var V;(function(n){n.READY="ready",n.CONNECTED="connected",n.DISCONNECTED="disconnected",n.CHANGED="changed",n.ERROR="error"})(V||(V={}));var De=6e4,Ge={debug:!1,baseUrl:"https://config.ff.harness.io/api/1.0",eventUrl:"https://events.ff.harness.io/api/1.0",eventsSyncInterval:De,streamEnabled:!0,allAttributesPrivate:!1,privateAttributeNames:[]},ue=(n,...i)=>console.error(`[FF-SDK] ${n}`,...i);var ht="1.6.0",pt=500,xe=globalThis.fetch,gt=Xe.EventSourcePolyfill,Se=!!globalThis.Proxy,_e=n=>{let{value:i}=n;try{switch(n.kind.toLowerCase()){case"int":case"number":i=Number(i);break;case"boolean":i=i.toString().toLowerCase()==="true";break;case"json":i=JSON.parse(i);break}}catch(v){ue(v)}return i},qe=(n,i,v)=>{let c=!1,k,x,T,O,B,_=!0,ve=()=>{_=!1},ie=()=>{_=!0},C=[],R=$e(),U=Y(Y({},Ge),v);U.eventsSyncInterval<De&&(U.eventsSyncInterval=De);let I=(s,...d)=>{U.debug&&console.debug(`[FF-SDK] ${s}`,...d)},oe=s=>{if(_){let d=Date.now();d-s.lastAccessed>pt&&(s.count++,s.lastAccessed=d)}};globalThis.onbeforeunload=()=>{C.length&&globalThis.localStorage&&(ve(),globalThis.localStorage.HARNESS_FF_METRICS=JSON.stringify(C),ie())};let K=(s,d)=>Ae(void 0,null,function*(){return(yield(yield xe(`${d.baseUrl}/client/auth`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s,target:Y(Y({},i),{identifier:String(i.identifier)})})})).json()).authToken}),z=0,se=()=>{if(C.length){I("Sending metrics...",{metrics:C,evaluations:F});let s={metricsData:C.map(d=>({timestamp:Date.now(),count:d.count,metricsType:"FFMETRICS",attributes:[{key:"featureIdentifier",value:d.featureIdentifier},{key:"featureName",value:d.featureIdentifier},{key:"variationIdentifier",value:d.variationIdentifier},{key:"target",value:i.identifier},{key:"SDK_NAME",value:"JavaScript"},{key:"SDK_LANGUAGE",value:"JavaScript"},{key:"SDK_TYPE",value:"client"},{key:"SDK_VERSION",value:ht}]}))};xe(`${U.eventUrl}/metrics/${k}?cluster=${x}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${O}`},body:JSON.stringify(s)}).then(()=>{C=[],z=0}).catch(d=>{z++&&(C=[],z=0),I(d)}).finally(()=>{B=window.setTimeout(se,U.eventsSyncInterval)})}else B=window.setTimeout(se,U.eventsSyncInterval)},F={},he=s=>{I("Sending event for",s.flag),Se?R.emit(V.CHANGED,new Proxy(s,{get(d,o){var g;if(d.hasOwnProperty(o)&&o==="value"){let m=d.flag,b=s.value,N=C.find($=>$.featureIdentifier===m&&$.featureValue===b);N?(oe(N),N.variationIdentifier=((g=F[m])==null?void 0:g.identifier)||""):C.push({featureIdentifier:m,featureValue:String(b),variationIdentifier:F[m].identifier||"",count:_?1:0,lastAccessed:Date.now()}),I("Metrics event: Flag",o,"has been read with value via stream update",b)}return o==="value"?_e(s):s[o]}})):R.emit(V.CHANGED,{deleted:s.deleted,flag:s.flag,value:_e(s)})},pe=function(){return Se?new Proxy({},{get(s,d){var g,m,b;let o=s[d];if(s.hasOwnProperty(d)){let N=s[d],$=C.find(Te=>Te.featureIdentifier===d&&N===Te.featureValue);$?($.variationIdentifier=((g=F[d])==null?void 0:g.identifier)||"",oe($)):C.push({featureIdentifier:d,featureValue:N,variationIdentifier:((m=F[d])==null?void 0:m.identifier)||"",count:_?1:0,lastAccessed:Date.now()}),I("Metrics event: Flag:",d,"has been read with value:",N,"variationIdentifier:",(b=F[d])==null?void 0:b.identifier)}return o}}):{}},H=pe();K(n,U).then(s=>{if(c)return;O=s;let d=Ue(s);if(I("Authenticated",d),globalThis.localStorage&&globalThis.localStorage.HARNESS_FF_METRICS)try{delete globalThis.localStorage.HARNESS_FF_METRICS,I("Picking up metrics from previous session")}catch(o){}B=window.setTimeout(se,U.eventsSyncInterval),k=d.environment,x=d.clusterIdentifier,ne().then(()=>{I("Fetch all flags ok",H)}).then(()=>{c||re()}).then(()=>{c||(I("Event stream ready",{storage:H}),R.emit(V.READY,Y({},H)),Se||Object.keys(H).forEach(o=>{var g;C.push({featureIdentifier:o,featureValue:H[o],variationIdentifier:((g=F[o])==null?void 0:g.identifier)||"",count:_?1:0,lastAccessed:Date.now()})}))}).catch(o=>{R.emit(V.ERROR,o)})}).catch(s=>{ue("Authentication error: ",s),R.emit(V.ERROR,s)});let ne=()=>Ae(void 0,null,function*(){try{(yield(yield xe(`${U.baseUrl}/client/env/${k}/target/${i.identifier}/evaluations?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}})).json()).forEach(o=>{let g=_e(o),m=H[o.flag];g!==m&&(I("Flag variation has changed for ",o.identifier),H[o.flag]=g,F[o.flag]=Y(Y({},o),{value:g}),he(o))})}catch(s){return ue("Features fetch operation error: ",s),R.emit(V.ERROR,s),s}}),ge=s=>Ae(void 0,null,function*(){var d;try{let o=yield xe(`${U.baseUrl}/client/env/${k}/target/${i.identifier}/evaluations/${s}?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`}});if(o.ok){let g=yield o.json(),m=_e(g);if(ve(),H[s]=m,F[s]=Y(Y({},g),{value:m}),ie(),he(g),!Se){let b=g.flag,N=C.find($=>$.featureIdentifier===b&&$.featureValue===g.value);N?(oe(N),N.variationIdentifier=((d=F[b])==null?void 0:d.identifier)||""):C.push({featureIdentifier:b,featureValue:String(g.value),variationIdentifier:F[b].identifier||"",count:_?1:0,lastAccessed:Date.now()})}}else R.emit(V.ERROR,o)}catch(o){ue("Feature fetch operation error: ",o),R.emit(V.ERROR,o)}}),re=()=>{if(!U.streamEnabled){I("Stream is disabled by configuration. Note: Polling is not yet supported");return}T=new gt(`${U.baseUrl}/stream?cluster=${x}`,{headers:{Authorization:`Bearer ${O}`,"API-Key":n}}),T.onopen=o=>{I("Stream connected",o),R.emit(V.CONNECTED)},T.onclose=o=>{I("Stream disconnected"),R.emit(V.DISCONNECTED)},T.onerror=o=>{ue("Stream has issue",o),R.emit(V.ERROR,o)};let s=o=>{switch(o.event){case"create":setTimeout(()=>ge(o.identifier),1e3);break;case"patch":ge(o.identifier);break;case"delete":delete H[o.identifier],R.emit(V.CHANGED,{flag:o.identifier,value:void 0,deleted:!0}),I("Evaluation deleted",{message:o,storage:H});break}},d=o=>{o.event==="patch"&&ne()};T.addEventListener("*",o=>{let g=JSON.parse(o.data);I("Received event from stream: ",g),g.domain==="flag"?s(g):g.domain==="target-segment"&&d(g)})},we=(s,d)=>R.on(s,d),Ee=(s,d)=>{s?R.off(s,d):fe()},be=(s,d)=>{var g;let o=H[s];if(!Se&&o!==void 0){let m=o,b=s,N=C.find($=>$.featureIdentifier===b&&$.featureValue===m);N?(oe(N),N.variationIdentifier=((g=F[b])==null?void 0:g.identifier)||""):C.push({featureIdentifier:b,featureValue:m,count:_?1:0,variationIdentifier:F[b].identifier||"",lastAccessed:Date.now()})}return o!==void 0?o:d},fe=()=>{c=!0,I("Closing event stream"),H=pe(),F={},clearTimeout(B),R.all.clear(),typeof(T==null?void 0:T.close)=="function"&&T.close()};return{on:we,off:Ee,variation:be,close:fe}};return vt;})();
/** @license
 * eventsource.js
 * Available under MIT License (MIT)
 * https://github.com/Yaffle/EventSource/
 */
